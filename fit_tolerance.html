<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css"> 

<!-- Include relevant libraries -->
<script type="text/javascript" src="js/eclib.js"></script>
<script type="text/javascript" src="js/units.js"></script>
<script type="text/javascript" src="js/export.js"></script>
<script type="text/javascript" src="js/isofits.js"></script>
<script type="text/javascript" src="js/walkthrough.js"></script>

<!-- Export library requires this script tag -->
<script id="EXP_inputs_frame" ></script>

<script type="text/javascript">
	EXP_FN_BASE = 'fit_tol';
	UNIT_MAP = {
		'dimension': ['mm', 'in'] // ezpz
	};
	WALK_STEPS = [{
			poi: 'type',
			desc: 'Select the gland type...',
			valign: 'bottom'
		},{
			poi: 'user_inputs',
			desc: 'Plug in gland dimensions...',
			valign: 'bottom'
		},{
			poi: 'dashsize',
			desc: 'Standard o-ring sizes can be input here.'
		},{
			poi: 'computed_outputs',
			desc: 'Min and max values are calculated here.',
			valign: 'bottom',
			halign: 'right'
		}];
</script>
<script type="text/javascript">

	function init() {
		EC_onload();
		EXP_onload();
		UNIT_change();

		populateIntents();

		// not an expensive calculator, just fire on all changes
		EC_setOnInput(
			function(e) {
		    	var key = e.keyCode ? e.keyCode : e.which;
		    	setError(1);
		    	if (e.target.id.startsWith('class_')) {
		    		checkStandardClassFit();
		    	}

		    	compute();
		    });
		EC_setOnKeyUp(); // default handler ok

		//WALK_onload();

		compute();
		checkStandardClassFit();
	}

	function compute() {
		try{
			let modeSelect  = document.getElementById('mode_0');
			let nominal     = getV('nominal_0');
			let holeSelect  = document.getElementById('class_hole_0');
			let shaftSelect = document.getElementById('class_shaft_0');
			validateClass(holeSelect);
			validateClass(shaftSelect);

			selectMode();

			console.log(nominal, holeSelect.value, shaftSelect.value);
			let holeZone  = ISOFIT_computeZone(nominal, holeSelect.value);
			let shaftZone = ISOFIT_computeZone(nominal, shaftSelect.value);

			let metric = document.getElementById('unit_select').value == '0';
			let places = metric ? 4:5;

			console.log(holeZone, shaftZone);

			switch(modeSelect.value) {
				case "bilateral":
					setV("dim_hole_a_0",  holeZone[0],  places, true);
					setV("dim_hole_b_0",  holeZone[1],  places, true);
					setV("dim_shaft_a_0", shaftZone[0], places, true);
					setV("dim_shaft_b_0", shaftZone[1], places, true);
					break;
				case "symmetric":
					let holeAvg  = nominal+( holeZone[0]  + holeZone[1]  )/2;
					let shaftAvg = nominal+( shaftZone[0] + shaftZone[1] )/2;
					let holeSpn  = ( holeZone[1]  - holeZone[0]  )/2;
					let shaftSpn = ( shaftZone[1] - shaftZone[0] )/2;
					setV("dim_hole_a_0",  holeAvg,  places);
					setV("dim_hole_b_0",  holeSpn,  places);
					setV("dim_shaft_a_0", shaftAvg, places);
					setV("dim_shaft_b_0", shaftSpn, places);
					break;
				case "minmax":
					setV("dim_hole_a_0",  nominal+holeZone[0],  places);
					setV("dim_hole_b_0",  nominal+holeZone[1],  places);
					setV("dim_shaft_a_0", nominal+shaftZone[0], places);
					setV("dim_shaft_b_0", nominal+shaftZone[1], places);
					break;
			}

			perms = [
				shaftZone[1]-holeZone[0],
				shaftZone[0]-holeZone[0],
				shaftZone[1]-holeZone[1],
				shaftZone[0]-holeZone[1]
			];

			setV("dim_interf_a_0", Math.min(...perms));
			setV("dim_interf_b_0", Math.max(...perms));

			// setV(id, value, plages, show_sign)
		}catch(err){
			console.log(err);
			setError(2, err);
			return;
		}
		setError(0);
		EXP_dumpPersistence();
	}

	function populateIntents() {
		let select = document.getElementById('intent_0');
		let opt = document.createElement('option');
			opt.innerHTML = '';
			opt.value = '';
			select.appendChild(opt);

		for (intent in ISOFIT_INTENTS) {
			opt = document.createElement('option');
			opt.innerHTML = intent;
			opt.value = intent;
			select.appendChild(opt);
		}
	}

	/*function populateClasses(x, uppercase) {
		let select = document.getElementById(x);
		for (intent of ISOFIT_CLASSES) {
			opt = document.createElement('option');
			let cls = intent;
			if (!uppercase) cls = intent.toLowerCase();
			opt.innerHTML = cls;
			opt.value = cls;
			select.appendChild(opt);
		}
	}*/

	function validateClass(x) {
		if ( ISOFIT_CLASSES.includes(x.value.toUpperCase())) {
			x.classList.remove('error');
			return true;
		} else {
			x.classList.add('error');
			return false;
		}
	}

	function checkStandardClassFit() {
		//document.getElementById('intent_0').selectedIndex = 0;
		//document.getElementById('basis_0').selectedIndex = 0;
		let intentSelect = document.getElementById('intent_0');
		let basisSelect = document.getElementById('basis_0');
		let holeSelect  = document.getElementById('class_hole_0');
		let shaftSelect = document.getElementById('class_shaft_0');

		for (intent in ISOFIT_INTENTS) {
			if (ISOFIT_INTENTS[intent].hole[0] == holeSelect.value && ISOFIT_INTENTS[intent].hole[1] == shaftSelect.value) {
				selectItemByValue(basisSelect,  'hole');
				selectItemByValue(intentSelect, intent);
				return true;
			}
			if (ISOFIT_INTENTS[intent].shaft[0] == holeSelect.value && ISOFIT_INTENTS[intent].shaft[1] == shaftSelect.value) {
				selectItemByValue(basisSelect,  'shaft');
				selectItemByValue(intentSelect, intent);
				return true;
			}
		}
		selectItemByValue(basisSelect,  '');
		selectItemByValue(intentSelect, '');

	}

	function selectIntent() {
		let intentSelect = document.getElementById('intent_0');
		let basisSelect = document.getElementById('basis_0');
		console.log(intentSelect.value, basisSelect.value);

		if (intentSelect.value != '' && basisSelect.value != '') {
			let holeSelect  = document.getElementById('class_hole_0');
			let shaftSelect = document.getElementById('class_shaft_0');

			holeSelect.value =  ISOFIT_INTENTS[intentSelect.value][basisSelect.value][0];
			shaftSelect.value = ISOFIT_INTENTS[intentSelect.value][basisSelect.value][1];
		} else {
			basisSelect.value = '';
		}
	}

	function selectBasis() {
		let intentSelect = document.getElementById('intent_0');
		let basisSelect = document.getElementById('basis_0');
		console.log(intentSelect.value, basisSelect.value);

		if (intentSelect.value != '' && basisSelect.value != '') {
			let holeSelect  = document.getElementById('class_hole_0');
			let shaftSelect = document.getElementById('class_shaft_0');

			holeSelect.value =  ISOFIT_INTENTS[intentSelect.value][basisSelect.value][0];
			shaftSelect.value = ISOFIT_INTENTS[intentSelect.value][basisSelect.value][1];
		} else {
			basisSelect.value = '';
		}
	}

	function selectMode() {
		let modeSelect = document.getElementById('mode_0');
		let sepHole  = document.getElementById('sep_hole_0');
		let sepShaft = document.getElementById('sep_shaft_0');
		if (modeSelect.value == "bilateral") {
			sepShaft.innerHTML = sepHole.innerHTML = '/';
		} else if (modeSelect.value == "symmetric") {
			sepShaft.innerHTML = sepHole.innerHTML = '+/-';
		} else if (modeSelect.value == "minmax") {
			sepShaft.innerHTML = sepHole.innerHTML = 'to';
		} else {
			sepShaft.innerHTML = sepHole.innerHTML = 'ERROR';
		}
	}
</script>

<html>

<!-- Make sure to call your init function on document load -->
<!-- You can copy the topbar template here -->
<body onload="init()">
	<div id="topbar">
		<div class="topbar-la selectable" onclick="window.location='./'">EveryCalc</div>
		<div class="topbar-la" id='topbar_version'></div>
		<div class="topbar-la" id='topbar_filename'></div>
		<div class="topbar-la" id='topbar_unit'>
			<!-- Required for unit library. You could also put this in the calculator main body -->
			<select id="unit_select" onchange="UNIT_change(); compute();">
				<option value=0 >Millimeters</option>
				<option value=1 selected="selected">Inches</option>
			</select>
		</div>
		<div class="topbar-ctr" id="topbar_title">Fit Clearance/Interference Calculator</div>
		<div class="topbar-ra selectable" id="topbar_status"><span></span><span class='ttt'></span></div>
		<div class="topbar-ra selectable" onclick="downloadPage();" id="download">Export HTML</div>
		<div class="topbar-ra selectable" onclick="printPage();">Print</div>
		<div class="topbar-ra selectable" onclick="WALK_enable();">Tutorial</div>
		<a id="download_frame" hidden></a>
	</div>	

	<svg id="walkthrough_overlay" onclick="WALK_nextStep()" >
		<path id="walkthrough_frame" ></path>
		<text id="walkthrough_text" ></text>
		<text id="walkthrough_skip_button" onclick="WALK_disable();">Skip Tutorial</text>
	</svg>

<!-- From here go nuts, do whatever works for you. Use the container to keep stuff from spilling under topbar. I'll point out patterns to pay attention to. -->
<div style="float: left;" class="container">

<div style='display:table-row'>
	<div class="odd" style='display:table-cell'>
		<table style='float: left;'>
			<tr>
				<td class="rowlabel">
					Nominal Diam.
				</td>
				<td><input id="nominal_0" data-unit="dimension" /></td>
			</tr><tr>
				<td class="rowlabel">Intent</td>
				<td>
					<select id="intent_0" class="doublewide" onchange="selectIntent(); compute();" >
					</select><br/>
				</td>
			</tr><tr>
				<td class="rowlabel">Basis</td>
				<td>
					<select id="basis_0" class="doublewide" onchange="selectBasis(); compute();">
						<option value="" selected></option>
						<option value="hole">Hole Basis</option>
						<option value="shaft">Shaft Basis</option>
					</select>
				</td>
			</tr><tr>
				<td class="rowlabel">
					Hole/Shaft
				</td><td>
					<input id="class_hole_0" class="halfwide" />/<input id="class_shaft_0" class="halfwide" />
				</td>
			</tr>
		</table>
		<table style='float: right;'>
			<tr>
				<td colspan=4  style='text-align: center' >
					<select id="mode_0" class="doublewide" onchange="selectMode(); compute();">
						<option value="bilateral" selected>Bilateral Deviation</option>
						<option value="symmetric">Symmetric Tolerance</option>
						<option value="minmax">Min/Max Measurement</option>
					</select>
				</td>
			</tr>
			<tr>
				<td class="rowlabel">
					Hole
				</td>
				<td><input id="dim_hole_a_0" readonly  data-unit="dimension" /></td>
				<td id="sep_hole_0" style='text-align: center' >/</td>
				<td><input id="dim_hole_b_0" readonly  data-unit="dimension" /></td>
			</tr><tr>
				<td class="rowlabel">
					Shaft
				</td>
				<td><input id="dim_shaft_a_0" readonly  data-unit="dimension" /></td>
				<td id="sep_shaft_0" style='text-align: center' >/</td>
				<td><input id="dim_shaft_b_0" readonly  data-unit="dimension" /></td>
			</tr><tr>
				<td class="rowlabel">
					Interference
				</td>
				<td><input id="dim_interf_a_0" readonly  data-unit="dimension" /></td>
				<td id="sep_interf_0" style='text-align: center' >to</td>
				<td><input id="dim_interf_b_0" readonly  data-unit="dimension" /></td>
			</tr>
		</table>
	</div>
</div>
</div>
</body>
</html>