<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css"> 

<!-- Include relevant libraries -->
<script type="text/javascript" src="js/eclib.js"></script>
<script type="text/javascript" src="js/units.js"></script>
<script type="text/javascript" src="js/export.js"></script>
<script type="text/javascript" src="js/motors.js"></script>
<script type="text/javascript" src="js/plots.js"></script>
<script type="text/javascript" src="js/walkthrough.js"></script>
<script type="text/javascript" src="js/materials.js"></script>
<script type="text/javascript" src="js/belts.js"></script>

<!-- Export library requires this script tag -->
<script id="EXP_inputs_frame" ></script>

<script type="text/javascript" id="main">

	EXP_FN_BASE = 'simplemech'; // filename base for export utility
	UNIT_MAP = { // map of units
		"torque": ["N-m", "in-lbf"],
		"encoder_cpx": ["c/m", "c/ft"],
		"radius": ["mm","in"],
		"force": ["N", "lbf"],
		"mass": ["kg", "lbm"],
		"speed": ["m/s", "ft/s"],
		"distance": ["m", "ft"],
		"acceleration": ["m/s^2", "ft/s^2"],
		'moi': ['kg mm^2', 'lbm in^2'],
		"omega": ["RPM", "RPM"],
		"theta": ["rev", "rev"],
		"alpha": ["RPM/s", "RPM/s"],
		"angle": ["deg", "deg"],
		"pct":   ["%", "%"],
		"dimension": ["mm", "in"],
		"pa": ["deg","deg"]
	};
	/*WALK_STEPS = [{
			poi: 'user_input_motor',
			desc: 'Input details about the motors powering your mechanism...',
			valign: 'bottom'
		},{
			poi: 'user_input_gratio',
			desc: 'Input the gear ratio (you can use the dropdown to compute it)...'
		},{
			poi: 'user_input_encoder',
			desc: 'The encoder box can be used to help figure out encoder resolution...'
		},{
			poi: 'user_input_traction',
			desc: 'Traction limiting should be used for drivetrains...'
		},{
			poi: 'user_input_electrical',
			desc: 'Simultion of voltage drop and current limiting can be done...'
		},{
			poi: 'user_input_radius',
			desc: "Plug in the effective radius of your mechanism (arm length, wheel radius, or spool radius)..."
		},{
			poi: 'user_input_mass',
			desc: 'Plug in the mass of the system being accelerated...'
		},{
			poi: 'user_input_load',
			desc: 'Plug in the load perpindicular to the radius...'
		},{
			poi: 'user_input_endcond',
			desc: 'Plug in an end condition for simulation...'
		},{
			poi: 'computed_outputs',
			desc: 'Computed/simulated values will appear here.'
		},{
			poi: 'chart',
			desc: 'Simulation results are plotted here.'
		},{
			poi: 'chart',
			desc: 'Click on the plot to probe points for values.'
		},{
			poi: 'toggle_tips_label',
			desc: 'More tips and notes are in here.'
		},{
			poi: 'toggle_varref_label',
			desc: 'Variables that can be used in the load and end condition expressions are here.'
		}];*/
</script>
<script type="text/javascript">

	/* Initialization routine run on page load */
	function init() {
		EC_onload();
		MOTOR_setupMotorSelect("motor");
		EXP_onload();
		MOTOR_selectMotor("motor");
		UNIT_change();

		// on keyup for all variables
		EC_setOnInput(function(e) {
			let key = e.keyCode ? e.keyCode : e.which;
			let input = e.target;

		  	if(input.id.startsWith('toggle')) return; // ignore these, just css stuff

	    	// if a key is pressed, invalidate current results
	    	setError(1);
			if (input.type == 'checkbox') {
				compute();
			}
		});
		EC_setOnKeyUp(); // default handler is OK
		compute();
		//WALK_onload();
	}

	function registerCallbacks() {
		EC_setOnInput(function(e) {
	    	let key = e.keyCode ? e.keyCode : e.which;
	    	let input = e.target;
	    	if(input.id.startsWith('toggle')) return; // ignore these, just css stuff
	    	if(input.id.startsWith('section_')) {
	    		computeMOI();
	    	}
	    	if(input.id.startsWith('transmission_')) {
	    		//let str = input.id.split('_');
	    		//computeTransmission(str[1]);
	    		//compute();
	    	}
			if(key!=13) setError(1);
	    });
		EC_setOnKeyUp(); // default handler OK
	}

	function addTransmissionStage(params) {
		setError(1);
		let container = document.getElementById('transmission_stages');
		let transmission = document.createElement('div');
		x = container.dataset.current_stage_id;
		container.dataset.current_stage_id ++;
		transmission.innerHTML = `
		<span>
			[${x}]<select class="dynamic-input doublewide" id="transmission_${x}_type" onchange="selectTransmissionType(${x}); compute();">
				<option value="spur" selected >Spur</option>
				<option value="belt" >Belt</option>
				<option value="chain" >Chain</option>
				<option value="vp">VersaPlanetary</option>
				<option value="57sport">57 Sport</option>
			</select>
		</span><span style="float:right;">
			<button onclick="moveTransmissionStage(${x},-1); compute();" title="Move Up" id="transmission_${x}_moveup">^</button>
			<button onclick="moveTransmissionStage(${x},+1); compute();" title="Move Down" id="transmission_${x}_moveup">v</button>
			<button onclick="removeTransmissionStage(${x}); compute();" title="Remove">X</button>
		</span>
		<div id="transmission_${x}_detail" style="width:100%; overflow:hidden;"></div>
		`;
		transmission.dataset.stage_id = x;
		transmission.classList.add(x%2 ? 'even' : 'odd');
		container.appendChild(transmission);
		if (typeof params != 'undefined') {
			// process args
		}
		selectTransmissionType(x);
		registerCallbacks();
	}

	function removeTransmissionStage(x) {
		let container = document.getElementById('transmission_stages');
		for(i=0; i<container.children.length; i++) {
			if (container.children[i].dataset.stage_id == x) {
				container.removeChild(container.children[i]);
				i--;
			}
			else { // make them even and odd
				container.children[i].classList.remove(i%2 ? 'odd' : 'even');
				container.children[i].classList.add(i%2 ? 'even' : 'odd');
			}
		}
	}

	function moveTransmissionStage(x, direction) {
		let container = document.getElementById('transmission_stages');
		let searching = true;
		for(let i=(direction < 0 ? 1:0); i<container.childNodes.length-(direction > 0 ? 1:0); i++) {
			if (container.childNodes[i].dataset.stage_id == x) {
				// found the correct child, now do the swapping...
				let pulled = container.removeChild(container.childNodes[i]);
				console.log(i, pulled);
				console.log(container.childNodes.length);
				if (direction > 0) {
					container.insertBefore(pulled, container.childNodes[i+1]);
					document.getElementById(`transmission_${x}_movedown`).focus();
				} else {
					container.insertBefore(pulled, container.childNodes[i-1]);
					document.getElementById(`transmission_${x}_moveup`).focus();
				}
				break;
			}
		}
		for(i=0; i<container.children.length; i++) {
			container.children[i].classList.remove(i%2 ? 'odd' : 'even');
			container.children[i].classList.add(i%2 ? 'even' : 'odd');
		}
	}

	function selectTransmissionType(x) {
		let container = document.getElementById(`transmission_${x}_detail`);
		let type      = document.getElementById(`transmission_${x}_type`).value;
		switch(type) {
			case 'spur':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td class="collabel"></td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr>
					<tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=50 /></td>
					</tr><tr>
						<td class="collabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_teeth_matl">
							<option value="7075-T6 Aluminum">7075 (VexPro Aluminum)</option>
							<option value="6061-T6 Aluminum">6061 (AndyMa Aluminumrk)</option>
							<option value="4140N Steel">4140N (AM/ Hot-Rolled SteelVP)</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_teeth_matl">
							<option value="7075-T6 Aluminum">7075 (VexPro Aluminum)</option>
							<option value="6061-T6 Aluminum">6061 (AndyMa Aluminumrk)</option>
							<option value="4140N Steel">4140N (AM/ Hot-Rolled SteelVP)</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Width</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth_width" data-unit="dimension" value=0.5 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth_width" data-unit="dimension" value=0.5 /></td>
						<td class="unit" data-unit="dimension">
					</tr><tr>
						<td class="rowlabel">Shaft</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
							<option value="key" >Keyed</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
							<option value="key" >Keyed</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="7075-T6 Aluminum">7075 Aluminum</option>
							<option value="6061-T6 Aluminum">6061 Aluminum</option>
							<option value="4140N SteelN">4140 Steel</option>
							<option value="1018 Hot-Rolled Steel">1018 Hot-Rolled Steel</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="7075-T6 Aluminum">7075 Aluminum</option>
							<option value="6061-T6 Aluminum">6061 Aluminum</option>
							<option value="4140N SteelN">4140 Steel</option>
							<option value="1018 Hot-Rolled Steel">1018 Hot-Rolled Steel</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr><tr>
						<td class="rowlabel">Key Width</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_keywidth" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_keywidth" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td style="text-align:right;"><select class="dynamic-input" id="transmission_${x}_moduleselect" onchange="compute();" >
							<option value="mod">Module</option>
							<option value="dp" selected>D.P.</option>
						</select></td>
						<td><input class="dynamic-input" id="transmission_${x}_module" value=20 /></td> <!-- don't let UNIT handle conversions since meaning is dynamic-->
						<td class="rowlabel">PA<span class="ttt">Pressure Angle</span></td>
						<td><!--<input class="dynamic-input" id="transmission_${x}_pa" data-unit="pa" value=14.5 />-->
						<select id="transmission_${x}_pa" onchange="compute();" />
							<option value="14.5" selected >14.5</option>
							<option value="20" >20</option>
						</td>
						<td class="unit" data-unit="pa"></td>
					</tr><tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Torque Output</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td></td><td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Gear FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos_pos" readonly /></td>
					</tr><tr>
						<td class="rowlabel">Shaft FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				break;
			case 'vp':
				container.innerHTML =`
				<table style="float: left">
					<tr>
						<td class="rowlabel">Stage 1 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_1" value=7 /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 2 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_2" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 3 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_3" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 4 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_4" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Output Shaft: </td>
						<td colspan=2><select class="dynamic-input" id="transmission_${x}_shaft" >
							<option value="hex_500">1/2" Hex</option>
							<option value="hex_375">3/8" Hex</option>
							<option value="rnd_500">1/2" Keyed</option>
							<option value="cim">CIM Shaft</option>
						</select></td>
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel" readonly>Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				break;
			case 'belt':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td colspan=2 class="collabel">Belt</td>
					</tr><tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" >
							<option value="htd" selected>HTD</option>
							<option value="gt2">GT2</option>
							<option value="gt3">GT3</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Pitch</td>
						<td><select class="dynamic-input" id="transmission_${x}_pitch" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Width</td>
						<td><select class="dynamic-input" id="transmission_${x}_width" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_beltteeth" /></td>
					</tr>
				</table>

				<table style="float: left;">
					<tr>
						<td class="collabel"></td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=50 /></td>
					</tr><tr>
						<td class="rowlabel">Shaft</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
							<option value="key" >Keyed</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
							<option value="key" >Keyed</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="7075-T6 Aluminum">7075 Aluminum</option>
							<option value="6061-T6 Aluminum">6061 Aluminum</option>
							<option value="4140N Steel">4140 Steel</option>
							<option value="1018 Hot-Rolled Steel">1018 Hot-Rolled Steel</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="7075-T6 Aluminum">7075 Aluminum</option>
							<option value="6061-T6 Aluminum">6061 Aluminum</option>
							<option value="4140N Steel">4140 Steel</option>
							<option value="1018 Hot-Rolled Steel">1018 Hot-Rolled Steel</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr><tr>
						<td class="rowlabel">Key Width</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_keywidth" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_keywidth" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				break;
			case 'chain':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td colspan=2 class="collabel">Chain</td>
					</tr><tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" >
							<option value="25" selected>#25</option>
							<option value="35">#35</option>
							<option value="40">#40</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Links<span class="ttt">A full link is 1, a half link is 0.5</span></td>
						<td><input class="dynamic-input" id="transmission_${x}_chainteeth" /></td>
					</tr>
				</table>

				<table style="float: left;">
					<tr>
						<td class="collabel"></td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=50 /></td>
					</tr><tr>
						<td class="rowlabel">Shaft</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
							<option value="key" >Keyed</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
							<option value="key" >Keyed</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="7075-T6 Aluminum">7075 Aluminum</option>
							<option value="6061-T6 Aluminum">6061 Aluminum</option>
							<option value="4140N Steel">4140N Steel</option>
							<option value="1018 Hot-Rolled Steel">1018 Hot-Rolled Steel</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="7075-T6 Aluminum">7075 Aluminum</option>
							<option value="6061-T6 Aluminum">6061 Aluminum</option>
							<option value="4140N Steel">4140N Steel</option>
							<option value="1018 Hot-Rolled Steel">1018 Hot-Rolled Steel</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr><tr>
						<td class="rowlabel">Key Width</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_keywidth" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_keywidth" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				break;
			case '57sport':
				container.innerHTML =`
				<table style="float: left">
					<tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" onchange="select57Series(${x}); compute();">
							<option value="sd">SD</option>
							<option value="hd">HD</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Ratio</td>
						<td><select class="dynamic-input" id="transmission_${x}_ratio" onchange="compute();" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Output Shaft: </td>
						<td colspan=2><select class="dynamic-input" id="transmission_${x}_shaft" disabled onchange="compute();">
							<option value="hex_500">1/2" Hex</option>
						</select></td>
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
					</tr>
				</table>
				`;
				select57Series(x);
				break;
		}
		registerCallbacks();
		UNIT_change();
	}

	let STRENGTH_MAP_57SPORT = {
			hd: {
				12:  230.5,
				16:  217.0,
				20:  189.9,
				36:  230.5,
				48:  230.5,
				64:  217.0,
				80:  189.8,
				100: 189.8
			},
			sd: {
				4:  162.7,
				12: 183.1,
				16: 162.7,
				20: 149.2
			}
		};

	function select57Series(x){
		let series = document.getElementById(`transmission_${x}_series`).value;
		let ratio  = document.getElementById(`transmission_${x}_ratio`);
		let prevratio = parseInt(ratio.value);
		ratio.innerHTML = '';
		
		for (num in STRENGTH_MAP_57SPORT[series]) {
			let opt = document.createElement('option');
			opt.innerHTML = num+':1';
			opt.value = parseInt(num);
			if(prevratio == num) opt.selected = true;
			ratio.appendChild(opt);
		}
	}

	function refreshShaftSelections(x, side){
		console.log('refreshing');
		let shape    = document.getElementById(`transmission_${x}_${side}_shaft`);
		let material = document.getElementById(`transmission_${x}_${side}_shaft_matl`);
		let diameter = document.getElementById(`transmission_${x}_${side}_diameter`);
		let keywidth = document.getElementById(`transmission_${x}_${side}_keywidth`);
		switch(shape.value) {
			case "thex":
				material.disabled = false;
				material.value    = "7075-T6";
			case "hex":
				material.disabled = false;
				keywidth.disabled = true;  keywidth.value="";
				diameter.disabled = false;
				break;
			case "ignore":
				material.disabled = true;
				keywidth.disabled = true;  keywidth.value="";
				diameter.disabled = true;  diameter.value="";
				break;
			case "key":
				material.disabled = false;
				keywidth.disabled = false;
				diameter.disabled = false;
				break;
		}
		setError(1);
	}

	let LEWIS_FACTORS = {
		teeth: [10,11,12,13,14,15,16,17,18,19,20,22,24,26,28,30,32,34,36,38,40,45,50,55,60,65,70,75,80,90,100,150,200,300,+Infinity],
		14.5: [.176, .192, .210, .223, .236, .245, .255, .264, .270, .277, .283, .292, .302, .308, .314, .318, .322, .325, .329, .332, .336, .340, .346, .352, .355, .358, .360, .361, .363, .366, .368, .375, .378, .382, .390],
		20:   [.201, .226, .245, .264, .276, .289, .295, .302, .308, .314, .320, .330, .337, .344, .352, .358, .364, .370, .377, .383, .389, .399, .308, .415, .421, .425, .429, .433, .436, .442, .446, .458, .463, .471, .484]
	}

	function computeGearStrength(P) {
		// P is an object with keys:
		// sy (yield strength, tensile)
		// w (width of tooth)
		// dp (diametral pitch (NOT MODULE))
		// n (number of teeth), pa (pressure angle)
		// torque capacity is returned
		// sy = torq/r*dp/w/LEWIS_FACTOR(dp, pa)
		// r = n/dp/2
		// torq = sy*n/dp/2/dp*w*LEWIS_FACTOR(dp,pa)
		let lfac = interp1D(LEWIS_FACTORS.teeth, LEWIS_FACTORS[P.pa], P.n);
		console.log(lfac);
		return P.sy*P.n/P.dp/P.dp/2*P.w*lfac;
	}

	// TODO
	function computeShaftStrength(P) {
		// P is an object with keys:
		// sy (yield strength, tensile)
		// not sure... uh... ok later
	}

	function computeTransmission(x, torque) {
		let container = document.getElementById(`transmission_${x}_detail`);
		let type      = document.getElementById(`transmission_${x}_type`).value;
		if(type=='vp'){
			let caps = [0,0,0,0,0]; // in this array shaft is first, connected to fourth, then third, then second, then first stage (motor connected to first stage)
			let overall_ratio = 1;
			for (let i=4; i>=1; i--) {
				let id = `transmission_${x}_stage_${i}`;
				let ratio = document.getElementById(id).value;
				let stagecap = +Infinity;
				document.getElementById(id).classList.remove('error');
				if ([3,4,5].includes(parseInt(ratio))) {
					stagecap = +Infinity*overall_ratio;
					overall_ratio *= parseInt(ratio);
				} else if ([7,9,10].includes(parseInt(ratio))) {
					stagecap = 100*overall_ratio;
					overall_ratio *= parseInt(ratio);
				} else if (typeof ratio=='string' && ratio.toLowerCase().startsWith('r')) {
					stagecap = 160*overall_ratio;
				} else if (ratio!=='') {
					stagecap = 0;
					document.getElementById(id).classList.add('error');
				}
				caps[i] = stagecap;
			}
			let shaftmap = {
				hex_500: 157,
				hex_375: 57,
				rnd_500: 130,
				cim:     29
			};
			caps[0] = shaftmap[document.getElementById(`transmission_${x}_shaft`).value];

			let idxmin  = caps.indexOf(Math.min(...caps));
			let capmin  = Math.min(...caps);
			let torqout = torque*overall_ratio;
			let fosmin  = capmin/torqout;

			setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_fos`,        fosmin);
			setV(`transmission_${x}_fos_pos`,    idxmin ? `Stage ${idxmin}` : 'Shaft');
			setV(`transmission_${x}_ratio`,      overall_ratio, 0);

			return [fosmin, torqout, overall_ratio];
		} else if (type=='57sport') {
			let series = document.getElementById(`transmission_${x}_series`).value;
			let overall_ratio = document.getElementById(`transmission_${x}_ratio`).value;
			console.log(STRENGTH_MAP_57SPORT, STRENGTH_MAP_57SPORT[series], STRENGTH_MAP_57SPORT[series][overall_ratio]);
			let capmin = STRENGTH_MAP_57SPORT[series][overall_ratio];
			let torqout = torque*overall_ratio;
			let fosmin  = capmin/torqout;

			setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_fos`,        fosmin);
			setV(`transmission_${x}_ratio`,      overall_ratio, 0);

			return [fosmin, torqout, overall_ratio];
		} else if (type=='spur') {
			let overall_ratio = getV(`transmission_${x}_out_teeth`)/getV(`transmission_${x}_inp_teeth`);

			let torq_g_inp = computeGearStrength({
				dp: document.getElementById(`transmission_${x}_moduleselect`).value=='dp' ?
					convertFrom(getV(`transmission_${x}_inp_teeth`), '1/in') :
					convertFrom(1/getV(`transmission_${x}_inp_teeth`), '1/mm') , // invert module to get it into dp
				sy: MATERIAL_DATA[document.getElementById(`transmission_${x}_inp_teeth_matl`).value].Sy,
				w:  getV(`transmission_${x}_inp_teeth_width`),
				n:  getV(`transmission_${x}_inp_teeth`),
				pa: document.getElementById(`transmission_${x}_pa`).value
			})*overall_ratio; // prorate by the gear ratio
			let torq_g_out = computeGearStrength({
				dp: document.getElementById(`transmission_${x}_moduleselect`).value=='dp' ?
					convertFrom(getV(`transmission_${x}_out_teeth`), 'in') :
					convertFrom(1/getV(`transmission_${x}_out_teeth`), 'mm') , // invert module to get it into dp
				sy: MATERIAL_DATA[document.getElementById(`transmission_${x}_out_teeth_matl`).value].Sy,
				w:  getV(`transmission_${x}_out_teeth_width`),
				n:  getV(`transmission_${x}_out_teeth`),
				pa: document.getElementById(`transmission_${x}_pa`).value
			});

			let g_caps = [torq_g_inp, torq_g_out];
			let torqout = torque*overall_ratio;

			let g_idxmin  = g_caps.indexOf(Math.min(...g_caps));
			let g_capmin  = Math.min(...g_caps);
			let g_fosmin  = g_capmin/torqout;

			//setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_g_fos`,      g_fosmin);
			setV(`transmission_${x}_g_fos_pos`,  g_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_ratio`,      overall_ratio);

			return [Math.min(g_fosmin), torqout, overall_ratio];
		}
	}

	function compute() {
		let computed_basic = false;
		try{
			let container = document.getElementById('transmission_stages');
			let torque    = getV('motor_stall_torque');
			let fos       = +Infinity;
			let fos_pos   = NaN;
			let overall_ratio = 1;
			setV('input_torque', torque);
			for(stage of container.children) {
				let res = computeTransmission(stage.dataset.stage_id, torque);
				overall_ratio *= res[2];
				torque = res[1];
				if (res[0] < fos) {
					fos_pos = stage.dataset.stage_id;
					fos     = res[0];
				}
			}
			
			setV('overall_fos', fos);
			setV('output_torque', torque);
			setV('overall_ratio', overall_ratio);

		}catch(err){
			console.log(err);
			setError(2, err);
			return;
		}
		setError(0);
		EXP_dumpPersistence();
	}
</script>

<html>

<!-- Make sure to call your init function on document load -->
<!-- You can copy the topbar template here -->
<body onload="init()">
	<div id="topbar">
		<div class="topbar-la selectable" onclick="window.location='./'">EveryCalc</div>
		<div class="topbar-la" id='topbar_version'></div>
		<div class="topbar-la" id='topbar_filename'></div>
		<div class="topbar-la" id='topbar_unit'>
			<!-- Required for unit library. You could also put this in the calculator main body -->
			<select id="unit_select" onchange="UNIT_change(); compute();">
				<option value=0 >Metric</option>
				<option value=1 selected="selected">English</option>
			</select>
		</div>
		<div class="topbar-ctr" id="topbar_title">General Mechanism Calc</div>
		<div class="topbar-ra selectable" id="topbar_status" onclick="compute();"><span></span><span class='ttt'></span></div>
		<div class="topbar-ra selectable" onclick="downloadPage();" id="download">Export HTML</div>
		<div class="topbar-ra selectable" onclick="printPage();">Print</div>
		<div class="topbar-ra selectable" onclick="WALK_enable();">Tutorial</div>
		<a id="download_frame" hidden></a>
	</div>	

	<svg id="walkthrough_overlay" onclick="WALK_nextStep()" >
		<path id="walkthrough_frame" ></path>
		<text id="walkthrough_text" ></text>
		<text id="walkthrough_skip_button" onclick="WALK_disable();">Skip Tutorial</text>
	</svg>

	<!-- From here go nuts, do whatever works for you. Use the container to keep stuff from spilling under topbar. I'll point out patterns to pay attention to. -->
	<div style="" class="container">
		<div style="display:table-row">
			<div class="even" id="user_input_motor" style="display:table-cell;">
				<span># Motors
				<input class='narrow' id="motor_count" oninput="MOTOR_selectMotor('motor'); compute();" value=1 /></span><br/>
				<span class="rowlabel">Motor</span>
				<select class="doublewide" id="motor_select" onchange="MOTOR_selectMotor('motor'); compute();">
				</select>
				<input class="dropdown" type="checkbox" id="toggle-motor">
				<label class="dropdown" for="toggle-motor">V</label>
				<table id='detail_motor' class="dropdown">
					<tr>
						<th class="rowlabel">Free Speed<span class="ttt">The maximum RPM of the motor</span></th>
						<td><input data-unit="omega" id="motor_max_speed" readonly value=5880 /></td>
						<td class="unit" data-unit="omega" >[RPM]</td>
					</tr><tr>
						<th class="rowlabel">Stall Torque<span class="ttt">The maximum torque of the motor, occurring at 0 RPM</span></th>
						<td><input data-unit="torque" id="motor_stall_torque" readonly value=3.36 /></td>
						<td class="unit" data-unit="torque" id="unit_motor_stall_torque"></td>
					</tr><tr>
						<th class="rowlabel">Free Current<span class="ttt">The current drawn when the motor is unloaded</span></th>
						<td><input id="motor_free_current" readonly value=1.3 /></td>
						<td class="unit">[A]</td>
					</tr><tr>
						<th class="rowlabel">Stall Current<span class="ttt">The current drawn at 0 RPM / Max Torque</span></th>
						<td><input id="motor_stall_current" readonly value=166 /></td>
						<td class="unit">[A]</td>
					</tr>
				</table>
			</div>
			<div class="output" id="computed_outputs" style="display:table-cell;">
				<table>
					<tr>
						<th class="rowlabel">Input Torque</th>
						<td><input data-unit="torque" id="input_torque" readonly /></td>
						<td class="unit" data-unit="torque"></td>
					</tr><tr>
						<th class="rowlabel">Output Torque</th>
						<td><input data-unit="torque" id="output_torque" readonly /></td>
						<td class="unit" data-unit="torque"></td>
					</tr><tr>
						<th class="rowlabel">Overall Gear Ratio</th>
						<td><input id="overall_ratio" readonly /></td>
					</tr><tr>
						<th class="rowlabel">Overall FOS</th>
						<td><input id="overall_fos" readonly /></td>
					</tr>
				</table>
			</div>
		</div>
		<div style="">
			<div id="transmission_stages" data-current_stage_id=0 ></div>
			<button id="add_transmission_stage" onclick="addTransmissionStage(); compute();" style="width: 100%">Add Stage</button>
		</div>
	</div>
</div>
</body>
</html>