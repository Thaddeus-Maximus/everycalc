<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css"> 

<!-- Include relevant libraries -->
<script type="text/javascript" src="js/eclib.js"></script>
<script type="text/javascript" src="js/units.js"></script>
<script type="text/javascript" src="js/export.js"></script>
<script type="text/javascript" src="js/motors.js"></script>
<script type="text/javascript" src="js/plots.js"></script>
<script type="text/javascript" src="js/walkthrough.js"></script>
<script type="text/javascript" src="js/materials.js"></script>
<script type="text/javascript" src="js/belts.js"></script>

<!-- Export library requires this script tag -->
<script id="EXP_inputs_frame" ></script>

<script type="text/javascript" id="main">

	EXP_FN_BASE = 'transmission'; // filename base for export utility
	UNIT_MAP = { // map of units
		"torque": ["N-m", "in-lbf"],
		"force": ["N", "lbf"],
		"mass": ["kg", "lbm"],
		"speed": ["m/s", "ft/s"],
		"distance": ["m", "ft"],
		'moi': ['kg mm^2', 'lbm in^2'],
		"omega": ["RPM", "RPM"],
		"pct":   ["%", "%"],
		"dimension": ["mm", "in"],
		"pa": ["deg","deg"],
		"motor-torque": ["N-m", "N-m"]
	};
	WALK_STEPS = [{
			poi: 'user_input_motor',
			desc: 'Input details about the motors powering your mechanism...',
			valign: 'bottom'
		},{
			poi: 'predefined_select',
			desc: 'Optionally choose from predefined COTS gearboxes...'
		},{
			poi: 'transmission_stages',
			desc: 'These are the stages in this transmission.'
		},{
			poi: 'add_transmission_stage',
			desc: 'Additional transmission stages can be added.'
		},{
			poi: 'transmission_0_topcluster',
			desc: 'Stages can be moved up, down, or removed.'
		},{
			poi: 'transmission_0_type',
			desc: 'Different transmission types can be chose from.'
		},{
			poi: 'transmission_0_resolves_multimotor',
			desc: 'If multiple motors feed in and come out in one output, tick this radiobutton.'
		},{
			poi: 'computed_outputs',
			desc: 'Computed values will appear here.',
			valign: 'bottom'
		}];

	PREDEFINED_GEARBOXES = {
			"AndyMark Toughbox": [{
				"type":"spur",
				"resolves_multimotor":"true",
				"inp_teeth":"14",
				"out_teeth":"50.00",
				"inp_teeth_width":"0.575",
				"out_teeth_width":"0.375",
				"inp_diameter":"",
				"out_diameter":"0.375",
				"module":"20",
				"spacing":"1.600",
				"spacing_drives":"true",
				"inp_teeth_matl_detail":"4140N Steel",
				"out_teeth_matl_detail":"4140N Steel",
				"inp_teeth_matl_base":"Steel",
				"out_teeth_matl_base":"Steel",
				"inp_shaft":"ignore",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"4140N Steel",
				"out_shaft_matl_detail":"4140N Steel",
				"inp_shaft_matl_base":"Steel",
				"out_shaft_matl_base":"Steel",
				"moduleselect":"dp",
				"pa":"14.5"
			},{
				"type":"spur",
				"resolves_multimotor":"false",
				"inp_teeth":"19",
				"out_teeth":"45.00",
				"inp_teeth_width":"0.575",
				"out_teeth_width":"0.375",
				"inp_diameter":"0.375",
				"out_diameter":"0.5",
				"module":"20",
				"spacing":"1.600",
				"spacing_drives":"true",
				"inp_teeth_matl_detail":"4140N Steel",
				"out_teeth_matl_detail":"4140N Steel",
				"inp_teeth_matl_base":"Steel",
				"out_teeth_matl_base":"Steel",
				"inp_shaft":"hex",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"4140N Steel",
				"out_shaft_matl_detail":"4140N Steel",
				"inp_shaft_matl_base":"Steel",
				"out_shaft_matl_base":"Steel",
				"moduleselect":"dp",
				"pa":"14.5"
			}],
			"VexPro Single Reduction": [{
				"type":"spur",
				"resolves_multimotor":"true",
				"inp_teeth":"12",
				"out_teeth":"84",
				"inp_teeth_width":"0.75",
				"out_teeth_width":"0.375",
				"inp_diameter":"",
				"out_diameter":"0.5",
				"module":"20",
				"spacing_drives":"false",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"ignore",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			}],
			"VexPro Double Reduction": [{"type":"spur",
				"resolves_multimotor":"false",
				"inp_teeth":"12",
				"out_teeth":"40",
				"inp_teeth_width":"0.75",
				"out_teeth_width":"0.375",
				"inp_diameter":"",
				"out_diameter":".375",
				"module":"20",
				"spacing_drives":"false",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"ignore",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			},{
				"type":"spur",
				"resolves_multimotor":"true",
				"inp_teeth":"14",
				"out_teeth":"40.00",
				"inp_teeth_width":"0.425",
				"out_teeth_width":"0.375",
				"inp_diameter":".375",
				"out_diameter":".500",
				"module":"20",
				"spacing":"1.350",
				"spacing_drives":"true",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"hex",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			}],
			"VexPro Clamping Gearbox": [{
				"type":"spur",
				"resolves_multimotor":"false",
				"inp_teeth":"12",
				"out_teeth":"72.00",
				"inp_teeth_width":"0.75",
				"out_teeth_width":"0.375",
				"inp_diameter":"",
				"out_diameter":".375",
				"module":"20",
				"spacing":"2.100",
				"spacing_drives":"true",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"ignore",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			}],
			"WCP SS Gearbox":[{
				"type":"spur",
				"resolves_multimotor":"false",
				"inp_teeth":"11",
				"out_teeth":"50",
				"inp_teeth_width":"0.75",
				"out_teeth_width":"0.375",
				"inp_diameter":"",
				"out_diameter":".375",
				"module":"20",
				"spacing_drives":"false",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"ignore",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			},{
				"type":"spur",
				"resolves_multimotor":"true",
				"inp_teeth":"20",
				"out_teeth":"54.00",
				"inp_teeth_width":"0.425",
				"out_teeth_width":"0.375",
				"inp_diameter":".375",
				"out_diameter":".500",
				"module":"20",
				"spacing":"1.850",
				"spacing_drives":"true",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"hex",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			}],
			"WCP SS Flipped Gearbox": [{"type":"spur",
				"resolves_multimotor":"false",
				"inp_teeth":"14",
				"out_teeth":"58",
				"inp_teeth_width":"0.75",
				"out_teeth_width":"0.375",
				"inp_diameter":"",
				"out_diameter":".375",
				"module":"20",
				"spacing":"1.800",
				"spacing_drives":"false",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"ignore",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			},{
				"type":"spur",
				"resolves_multimotor":"true",
				"inp_teeth":"18",
				"out_teeth":"30.00",
				"inp_teeth_width":"0.425",
				"out_teeth_width":"0.375",
				"inp_diameter":".375",
				"out_diameter":".500",
				"module":"20",
				"spacing":"1.200",
				"spacing_drives":"true",
				"inp_teeth_matl_detail":"7075-T6 Aluminum",
				"out_teeth_matl_detail":"7075-T6 Aluminum",
				"inp_teeth_matl_base":"Aluminum",
				"out_teeth_matl_base":"Aluminum",
				"inp_shaft":"hex",
				"out_shaft":"hex",
				"inp_shaft_matl_detail":"7075-T6 Aluminum",
				"out_shaft_matl_detail":"7075-T6 Aluminum",
				"inp_shaft_matl_base":"Aluminum",
				"out_shaft_matl_base":"Aluminum",
				"moduleselect":"dp",
				"pa":"14.5"
			}]
	}
</script>
<script type="text/javascript">

	/* TODO LAND
	 * - Optionless reduction?
	 * - Revamp UI? Some things feel a little out of place
	 * - Highlight low FOSes?
	 * * Exporting produces a dump list rather than correct and prper combo box
	 */

	/* Initialization routine run on page load */
	function init() {
		EC_onload();
		populatePredefinedGearbox();
		MOTOR_setupMotorSelect("motor");
		
		switch(EXP_onload()) {
			case 0: // run when nothing loads
				addTransmissionStage({
					type:   '57sport',
					series: 'hd',
					ratio:  48
				});
				break;
			case 1: // run when export loads
				break;
			case 2: // run when local storage loads
				loadDynamicPersistence();
				break;
		}

		MOTOR_selectMotor("motor");
		UNIT_change();

		// on keyup for all variables
		registerCallbacks();
		compute();
		WALK_onload();
	}

	function registerCallbacks() {
		EC_setOnInput(function(e) {
	    	let key = e.keyCode ? e.keyCode : e.which;
	    	let input = e.target;
	    	if(input.id.startsWith('toggle')) return; // ignore these, just css stuff
	    	if(input.id.startsWith('section_')) {
	    		computeMOI();
	    	}
	    	if(input.id.startsWith('transmission_')) {
	    		//let str = input.id.split('_');
	    		//computeTransmission(str[1]);
	    		//compute();
	    	}
		  	if(input.id.endsWith('_spacing_drives') || input.id.endsWith('_teeth') || input.id.endsWith('_spacing'))
			  	computeTeeth(input);
			if(key!=13) setError(1);
	    });
		EC_setOnKeyUp(); // default handler OK
	}

	function populatePredefinedGearbox() {
		let select = document.getElementById('predefined_select');
		select.innerHTML = "";
		if (true) {
			let opt = document.createElement('option');
			opt.innerHTML = '[select COTS gearbox]';
			opt.value = '';
			select.appendChild(opt);
		}
		for (gearbox in PREDEFINED_GEARBOXES) {
			let opt = document.createElement('option');
			opt.innerHTML = gearbox;
			opt.value = gearbox;
			select.appendChild(opt);
		}
	}

	function selectPredefinedGearbox() { 
		setError(1);
		let select    = document.getElementById('predefined_select');
		let container = document.getElementById('transmission_stages');
		if (! select.value) return;
		container.innerHTML = '';
		let trans_obj = PREDEFINED_GEARBOXES[select.value];
		for (let tran of trans_obj) {
			addTransmissionStage(tran);
		}
	}

	let none_spawned = true;

	function addTransmissionStage(params) {
		setError(1);
		let container = document.getElementById('transmission_stages');
		let transmission = document.createElement('div');
		x = container.dataset.current_stage_id;
		container.dataset.current_stage_id ++;
		transmission.innerHTML = `
		<span>
			<select class="dynamic-input doublewide" id="transmission_${x}_type" onchange="selectTransmissionType(${x}); compute();">
				<option value="spur" selected >Spur</option>
				<option value="belt" >Belt</option>
				<option value="chain" >Chain</option>
				<option value="vp">VersaPlanetary</option>
				<option value="up">UltraPlanetary</option>
				<option value="57sport">57 Sport</option>
			</select>
			<input type="radio" id="transmission_${x}_resolves_multimotor" name="rmm" value="${x}" onchange="compute();" />
			<label for="transmission_${x}_resolves_multimotor">Combines Multiple Motors</label>
		</span><span style="float:right;" id="transmission_${x}_topcluster" >
			<button onclick="moveTransmissionStage(${x},-1); compute();" title="Move Up" id="transmission_${x}_moveup">^</button>
			<button onclick="moveTransmissionStage(${x},+1); compute();" title="Move Down" id="transmission_${x}_moveup">v</button>
			<button onclick="removeTransmissionStage(${x}); compute();" title="Remove">X</button>
		</span>
		<div id="transmission_${x}_detail" style="width:100%; overflow:hidden;"></div>
		`;
		transmission.dataset.stage_id = x;
		transmission.classList.add(x%2 ? 'even' : 'odd');
		container.appendChild(transmission);
		if (typeof params != 'undefined') {
			document.getElementById(`transmission_${x}_type`).value = params.type;
			document.getElementById(`transmission_${x}_resolves_multimotor`).checked = params.resolves_multimotor == 'true' ? true:false;
			//delete params.type; // get rid of it so that it doesn't cause issues later?
			//delete params.resolves_multimotor; // get rid of it so that it doesn't cause issues later?
		} else {
			document.getElementById(`transmission_${x}_resolves_multimotor`).checked = none_spawned;
			none_spawned = false;
			params = {};
		}
		selectTransmissionType(x, params);
		registerCallbacks();
	}

	function removeTransmissionStage(x) {
		let container = document.getElementById('transmission_stages');
		for(i=0; i<container.children.length; i++) {
			if (container.children[i].dataset.stage_id == x) {
				container.removeChild(container.children[i]);
				i--;
			}
			else { // make them even and odd
				container.children[i].classList.remove(i%2 ? 'odd' : 'even');
				container.children[i].classList.add(i%2 ? 'even' : 'odd');
			}
		}
	}

	function moveTransmissionStage(x, direction) {
		let container = document.getElementById('transmission_stages');
		let searching = true;
		for(let i=(direction < 0 ? 1:0); i<container.childNodes.length-(direction > 0 ? 1:0); i++) {
			if (container.childNodes[i].dataset.stage_id == x) {
				// found the correct child, now do the swapping...
				let pulled = container.removeChild(container.childNodes[i]);
				if (direction > 0) {
					container.insertBefore(pulled, container.childNodes[i+1]);
					//document.getElementById(`transmission_${x}_movedown`).focus();
				} else {
					container.insertBefore(pulled, container.childNodes[i-1]);
					//document.getElementById(`transmission_${x}_moveup`).focus();
				}
				break;
			}
		}
		for(i=0; i<container.children.length; i++) {
			container.children[i].classList.remove(i%2 ? 'odd' : 'even');
			container.children[i].classList.add   (i%2 ? 'even' : 'odd');
		}
	}

	function getDP(x) { // return diametral pitch in 1/m
		return document.getElementById(`transmission_${x}_moduleselect`).value=='dp' ?
					convertFrom(getV(`transmission_${x}_module`), '1/in') :
					convertFrom(1/getV(`transmission_${x}_module`), '1/mm')
	}

	function computeTeeth(input) {
		x = parseInt(input.id.split('_')[1]); // get that sick ID
		if (document.getElementById(`transmission_${x}_type`).value != 'spur') return; // you shouldn't be here, go away
		if (document.getElementById(`transmission_${x}_spacing_drives`).checked) {
			document.getElementById(`transmission_${x}_spacing`).readOnly = false;
			if (input.id.endsWith('_inp_teeth') || input.id.endsWith('_spacing_drives') || input.id.endsWith('_spacing')) {
				let spacing  = getV(`transmission_${x}_spacing`);
				let teeth    = getV(`transmission_${x}_inp_teeth`);
				let dp       = getDP(x);
				let newTeeth = (2*spacing - teeth/dp)*dp;
				setV(`transmission_${x}_out_teeth`, newTeeth);
			} else if (input.id.endsWith('_out_teeth')) {
				let spacing  = getV(`transmission_${x}_spacing`);
				let teeth    = getV(`transmission_${x}_out_teeth`);
				let dp       = getDP(x);
				let newTeeth = (2*spacing - teeth/dp)*dp;
				setV(`transmission_${x}_inp_teeth`, newTeeth);
			}
		} else {
			document.getElementById(`transmission_${x}_spacing`).readOnly = true;
			setV(`transmission_${x}_spacing`, (getV(`transmission_${x}_out_teeth`)+getV(`transmission_${x}_inp_teeth`))/getDP(x)/2 );
		}
	}

	function unpackTransmissionParams(x, params) {
		if (params == undefined) params = {};
		let strstrt = (`transmission_${x}_`).length;
		for (input of document.getElementById(`transmission_${x}_detail`).getElementsByTagName('input')) {
			let id = input.id.slice(strstrt);
			if (params[id] == undefined)
				continue;
			else if (input.type == 'checkbox' || input.type == 'radio')
				input.checked = params[id] == "true" ? true:false;
			else
				input.value = params[id];
		}
		for (input of document.getElementById(`transmission_${x}_detail`).getElementsByTagName('select')) {
			let id = input.id.slice(strstrt);
			if(params[id]) input.value = params[id];
		}
	}

	function loadDynamicPersistence() {
		let trans_obj = JSON.parse(getLocalStorage('transmission_stages'));
		for (let tran of trans_obj) {
			addTransmissionStage(tran);
		}
	}

	function dumpDynamicPersistence() {
		let container = document.getElementById('transmission_stages');
		let trans_obj = [];

		for(i=0; i<container.children.length; i++) {
			let x = container.children[i].dataset.stage_id;
			let strstrt = (`transmission_${x}_`).length;
			trans_obj_i = {};
			trans_obj_i.type = document.getElementById(`transmission_${x}_type`).value;
			trans_obj_i.resolves_multimotor = document.getElementById(`transmission_${x}_resolves_multimotor`).checked ? 'true':'false';
			for (input of document.getElementById(`transmission_${x}_detail`).getElementsByTagName('input')) {
				let id = input.id.slice(strstrt);
				if (input.type == 'checkbox' || input.type == 'radio')
					trans_obj_i[id] = input.checked ? "true":"false";
				else
					trans_obj_i[id] = input.value;
			}
			for (input of document.getElementById(`transmission_${x}_detail`).getElementsByTagName('select')) {
				let id = input.id.slice(strstrt);
				trans_obj_i[id] = input.value;
			}
			trans_obj.push(trans_obj_i);
		}
		setLocalStorage('transmission_stages', JSON.stringify(trans_obj));
	}

	function selectTransmissionType(x, params) {
		let container = document.getElementById(`transmission_${x}_detail`);
		let type      = document.getElementById(`transmission_${x}_type`).value;
		switch(type) {
			case 'spur':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td class="collabel bold">Gears</td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr>
					<tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=50 /></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_teeth_matl_base" onchange="MATERIAL_selectBase('transmission_${x}_inp_teeth_matl'); compute();">
							<option value="7075-T6 Aluminum">7075 Aluminum (VexPro)</option>
							<option value="6061-T6 Aluminum">6061 Aluminum (AndyMark)</option>
							<option value="4140N Steel">4140N (AM/VexPro)</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_teeth_matl_base" onchange="MATERIAL_selectBase('transmission_${x}_out_teeth_matl'); compute();">
							<option value="7075-T6 Aluminum">7075 Aluminum (VexPro)</option>
							<option value="6061-T6 Aluminum">6061 Aluminum (AndyMark)</option>
							<option value="4140N Steel">4140N (AM/VexPro)</option>
						</select></td>
					</tr><tr>
						<td></td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_teeth_matl_detail" onchange="compute();">
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_teeth_matl_detail" onchange="compute();">
						</select></td>
					</tr><tr>
						<td class="rowlabel">Width</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth_width" data-unit="dimension" value=0.5 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth_width" data-unit="dimension" value=0.5 /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>
				
				<table style="float: left;">
					<tr>
						<td class="collabel bold">Shaft</td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Shape</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'inp'); MATERIAL_selectBase('transmission_${x}_inp_shaft_matl'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'out'); MATERIAL_selectBase('transmission_${x}_out_shaft_matl'); compute();" >
						</select></td>
					</tr><tr>
						<td></td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'inp'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'out'); compute();" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td style="text-align:right;"><select class="dynamic-input" id="transmission_${x}_moduleselect" onchange="compute();" >
							<option value="mod">Module</option>
							<option value="dp" selected>D.P.</option>
						</select></td>
						<td><input class="dynamic-input" id="transmission_${x}_module" value=20 /></td> <!-- don't let UNIT handle conversions since meaning is dynamic-->
						<td class="rowlabel">PA<span class="ttt">Pressure Angle</span></td>
						<td><!--<input class="dynamic-input" id="transmission_${x}_pa" data-unit="pa" value=14.5 />-->
						<select id="transmission_${x}_pa" onchange="compute();" />
							<option value="14.5" selected >14.5</option>
							<option value="20" >20</option>
						</td>
						<td class="unit" data-unit="pa"></td>
					</tr><tr>
						<td class="rowlabel">Spacing</td>
						<td><input id="transmission_${x}_spacing" value='' data-unit="dimension"/></td>
						<td class="unit" data-unit="dimension"></td>
						<td><input type="checkbox" id="transmission_${x}_spacing_drives" />Drive Teeth?</td>
					</tr><tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Torque Output</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td></td><td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Gear FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos_pos" readonly /></td>
					</tr><tr>
						<td class="rowlabel">Shaft FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				MATERIAL_populateSelect(`transmission_${x}_inp_teeth_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_teeth_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				MATERIAL_populateSelect(`transmission_${x}_inp_teeth_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_teeth_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				computeTeeth(document.getElementById(`transmission_${x}_spacing_drives`));
				break;
			case 'up':
				container.innerHTML =`
				<table style="float: left">
					<tr>
						<td class="rowlabel">Stage 1 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_1" value=3 /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 2 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_2" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 3 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_3" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 4 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_4" /></td>
						<td>:1</td>
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel" readonly>Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				unpackTransmissionParams(x, params);
				break;
			case 'belt':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td colspan=2 class="collabel">Belt</td>
					</tr><tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" onchange="selectBeltSeries(${x}); compute();" >
							<option value="htd" selected>HTD</option>
							<option value="gt2">GT2</option>
							<option value="gt3">GT3</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Pitch</td>
						<td><select class="dynamic-input" id="transmission_${x}_pitch" onchange="selectBeltPitch(${x}); compute();" value="5mm" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Width</td>
						<td><select class="dynamic-input" id="transmission_${x}_width" onchange="compute();" value="9mm" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_beltteeth" value=400 /></td>
					</tr>
				</table>

				<table style="float: left;">
					<tr>
						<td class="collabel"></td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=50 /></td>
					</tr><tr>
						<td class="rowlabel">Shaft</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'inp'); MATERIAL_selectBase('transmission_${x}_inp_shaft_matl'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'out'); MATERIAL_selectBase('transmission_${x}_out_shaft_matl'); compute();" >
						</select></td>
					</tr><tr>
						<td></td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'inp'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'out'); compute();" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Torque Output</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td></td><td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Belt FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos_pos" readonly /></td>
					</tr><tr>
						<td class="rowlabel">Shaft FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				selectBeltSeries(x);
				break;
			case 'vp':
				container.innerHTML =`
				<table style="float: left">
					<tr></tr>
						<td class="rowlabel">VersaDM</td>
						<td><select id="transmission_${x}_versadm" onchange="compute();">
							<option value="" >None</option>
							<option value="1" >1:1</option>
							<option value="3.75" >3.75:1</option>
							<option value="5.33" >5.33:1</option>
						</select></td>
					<tr><tr>
						<td class="rowlabel">Stage 1 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_1" value=7 /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 2 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_2" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 3 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_3" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 4 </td>
						<td><input class="dynamic-input" id="transmission_${x}_stage_4" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Output Shaft: </td>
						<td colspan=2><select class="dynamic-input" id="transmission_${x}_shaft" onchange="compute();" >
							<option value="hex_500">1/2" Hex</option>
							<option value="hex_375">3/8" Hex</option>
							<option value="rnd_500">1/2" Keyed</option>
							<option value="cim">CIM Shaft</option>
						</select></td>
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel" readonly>Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				unpackTransmissionParams(x, params);
				break;
			case 'belt':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td colspan=2 class="collabel">Belt</td>
					</tr><tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" onchange="selectBeltSeries(${x}); compute();" value='undefined' >
							<option value="htd">HTD</option>
							<option value="gt2">GT2</option>
							<option value="gt3">GT3</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Pitch</td>
						<td><select class="dynamic-input" id="transmission_${x}_pitch" onchange="selectBeltPitch(${x}); compute();">
						</select></td>
					</tr><tr>
						<td class="rowlabel">Width</td>
						<td><select class="dynamic-input" id="transmission_${x}_width" onchange="compute();">
						</select></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_beltteeth" /></td>
					</tr>
				</table>

				<table style="float: left;">
					<tr>
						<td class="collabel"></td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=50 /></td>
					</tr><tr>
						<td class="rowlabel">Shaft</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'inp'); MATERIAL_selectBase('transmission_${x}_inp_shaft_matl'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'out'); MATERIAL_selectBase('transmission_${x}_out_shaft_matl'); compute();" >
						</select></td>
					</tr><tr>
						<td></td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'inp'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'out'); compute();" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Torque Output</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td></td><td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Belt FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos_pos" readonly /></td>
					</tr><tr>
						<td class="rowlabel">Shaft FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				selectBeltSeries(x);
				break;
			case 'chain':
				container.innerHTML =`
				<table style="float: left;">
					<tr>
						<td colspan=2 class="collabel">Chain</td>
					</tr><tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" onchange="compute();" >
							<option value="25" selected>#25</option>
							<option value="35">#35</option>
							<option value="40">#40</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Links<span class="ttt">A full link is 1, a half link is 0.5</span></td>
						<td><input class="dynamic-input" id="transmission_${x}_chainteeth" /></td>
					</tr>
				</table>

				<table style="float: left;">
					<tr>
						<td class="collabel"></td>
						<td class="collabel">Input</td>
						<td class="collabel">Output</td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Teeth</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_teeth" value=14 /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_teeth" value=50 /></td>
					</tr><tr>
						<td class="rowlabel">Shaft</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft" onchange="refreshShaftSelections(${x}, 'inp');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft" onchange="refreshShaftSelections(${x}, 'out');" >
							<option value="ignore">Ignore</option>
							<option value="thex">ThunderHex</option>
							<option value="hex" >Hex</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Material</td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'inp'); MATERIAL_selectBase('transmission_${x}_inp_shaft_matl'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_base" onchange="refreshShaftSelections(${x}, 'out'); MATERIAL_selectBase('transmission_${x}_out_shaft_matl'); compute();" >
						</select></td>
					</tr><tr>
						<td></td>
						<td><select class="dynamic-input" id="transmission_${x}_inp_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'inp'); compute();" >
						</select></td>
						<td><select class="dynamic-input" id="transmission_${x}_out_shaft_matl_detail" onchange="refreshShaftSelections(${x}, 'out'); compute();" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Diameter</td>
						<td><input class="dynamic-input" id="transmission_${x}_inp_diameter" data-unit="dimension" /></td>
						<td><input class="dynamic-input" id="transmission_${x}_out_diameter" data-unit="dimension" /></td>
						<td class="unit" data-unit="dimension">
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Ratio </td>
						<td><input class="dynamic-input" id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Torque Output</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td></td><td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Chain FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_g_fos_pos" readonly /></td>
					</tr><tr>
						<td class="rowlabel">Shaft FOS</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos" readonly /></td>
						<td>@</td>
						<td><input class="dynamic-input" id="transmission_${x}_s_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				MATERIAL_populateSelect(`transmission_${x}_inp_shaft_matl`, true);
				MATERIAL_populateSelect(`transmission_${x}_out_shaft_matl`, true);
				unpackTransmissionParams(x, params);
				refreshShaftSelections(x, "inp");
				refreshShaftSelections(x, "out");
				break;
			case '57sport':
				container.innerHTML =`
				<table style="float: left">
					<tr>
						<td class="rowlabel">Series</td>
						<td><select class="dynamic-input" id="transmission_${x}_series" onchange="select57Series(${x}); compute();">
							<option value="sd">SD</option>
							<option value="hd">HD</option>
						</select></td>
					</tr><tr>
						<td class="rowlabel">Ratio</td>
						<td><select class="dynamic-input" id="transmission_${x}_ratio" onchange="compute();" >
						</select></td>
					</tr><tr>
						<td class="rowlabel">Output Shaft: </td>
						<td colspan=2><select class="dynamic-input" id="transmission_${x}_shaft" disabled onchange="compute();">
							<option value="hex_500">1/2" Hex</option>
						</select></td>
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input class="dynamic-input" id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input class="dynamic-input" id="transmission_${x}_fos" readonly /></td>
					</tr>
				</table>
				`;
				unpackTransmissionParams(x, params);
				select57Series(x);
				unpackTransmissionParams(x, params);
				break;
		}
		registerCallbacks();
		UNIT_change();
	}

	let STRENGTH_MAP_57SPORT = {
			hd: {
				12:  230.5,
				16:  217.0,
				20:  189.9,
				36:  230.5,
				48:  230.5,
				64:  217.0,
				80:  189.8,
				100: 189.8
			},
			sd: {
				4:  162.7,
				12: 183.1,
				16: 162.7,
				20: 149.2
			}
		};

	function select57Series(x){
		let series = document.getElementById(`transmission_${x}_series`).value;
		let ratio  = document.getElementById(`transmission_${x}_ratio`);
		let prevratio = parseInt(ratio.value);
		ratio.innerHTML = '';
		
		for (num in STRENGTH_MAP_57SPORT[series]) {
			let opt = document.createElement('option');
			opt.innerHTML = num+':1';
			opt.value = parseInt(num);
			if(prevratio == num) opt.selected = true;
			ratio.appendChild(opt);
		}
	}

	function refreshShaftSelections(x, side){
		let shape    = document.getElementById(`transmission_${x}_${side}_shaft`);
		let materialb = document.getElementById(`transmission_${x}_${side}_shaft_matl_base`);
		let materiald = document.getElementById(`transmission_${x}_${side}_shaft_matl_detail`);
		let diameter = document.getElementById(`transmission_${x}_${side}_diameter`);
		//let keywidth = document.getElementById(`transmission_${x}_${side}_keywidth`);
		switch(shape.value) {
			case "thex":
				materialb.disabled = false;
				materiald.disabled = false;
				materialb.value    = "Aluminum";
				MATERIAL_selectBase(`transmission_${x}_${side}_shaft_matl`);
				materiald.value    = "7075-T6 Aluminum";
			case "hex":
				materialb.disabled = false;
				materiald.disabled = false;
				diameter.disabled = false;
				break;
			case "ignore":
				materialb.disabled = true;
				materiald.disabled = true;
				diameter.disabled = true;  diameter.value="";
				break;
		}
		setError(1);
	}

	function selectBeltSeries(x) {
		let series = document.getElementById(`transmission_${x}_series`).value;
		let pitch  = document.getElementById(`transmission_${x}_pitch`);
		let oldPitch = pitch.value;
		pitch.innerHTML = '';

		for (num of BELT_PITCHES[series]) {
			let opt = document.createElement('option');
			opt.innerHTML = num;
			opt.value = num;
			if(oldPitch == num) opt.selected = true;
			pitch.appendChild(opt);
		}
		selectBeltPitch(x);
	}

	function selectBeltPitch(x) {
		let series = document.getElementById(`transmission_${x}_series`).value;
		let pitch  = document.getElementById(`transmission_${x}_pitch`).value;
		let width  = document.getElementById(`transmission_${x}_width`);
		let oldWidth = width.value;
		width.innerHTML = '';

		for (num in BELT_RATINGS[series+'_'+pitch].width_multipliers) {
			let opt = document.createElement('option');
			opt.innerHTML = num;
			opt.value = num;
			if(oldWidth == num) opt.selected = true;
			width.appendChild(opt);
		}
	}

	let LEWIS_FACTORS = {
		teeth: [10,11,12,13,14,15,16,17,18,19,20,22,24,26,28,30,32,34,36,38,40,45,50,55,60,65,70,75,80,90,100,150,200,300,+Infinity],
		14.5: [.176, .192, .210, .223, .236, .245, .255, .264, .270, .277, .283, .292, .302, .308, .314, .318, .322, .325, .329, .332, .336, .340, .346, .352, .355, .358, .360, .361, .363, .366, .368, .375, .378, .382, .390],
		20:   [.201, .226, .245, .264, .276, .289, .295, .302, .308, .314, .320, .330, .337, .344, .352, .358, .364, .370, .377, .383, .389, .399, .308, .415, .421, .425, .429, .433, .436, .442, .446, .458, .463, .471, .484]
	}

	let CHAIN_STRENGTHS = {
		35: 845,
		25: 378,
		40: 1557
	}

	function computeGearStrength(P) {
		// P is an object with keys:
		// sy (yield strength, tensile)
		// w (width of tooth)
		// dp (diametral pitch (NOT MODULE))
		// n (number of teeth), pa (pressure angle)
		// torque capacity is returned
		// sy = torq/r*dp/w/LEWIS_FACTOR(dp, pa)
		// r = n/dp/2
		// torq = sy*n/dp/2/dp*w*LEWIS_FACTOR(dp,pa)
		let lfac = interp1D(LEWIS_FACTORS.teeth, LEWIS_FACTORS[P.pa], P.n);
		return P.sy*P.n/(P.dp*P.dp)/2*P.w*lfac;
	}

	function computeShaftStrength(prefix) {
		// pass the prefix for your stuff, e.g. "transmission_${x}_inp"
		let type = document.getElementById(prefix+"_shaft").value;
		let matl = MATERIAL_DATA[document.getElementById(prefix+"_shaft_matl_detail").value];
		let diameter = getV(prefix+"_diameter");
		document.getElementById(prefix+"_diameter").classList.remove('error');
		let S = 0;
		// matl.Sy = torq*radius/J = torq/S => torq = matl.Sy*S
		switch(type) {
			case 'ignore':
				return +Infinity;
			case 'hex':
				S = 0.208*Math.pow(diameter, 3);
				return S*matl.Sy/2;
			case 'thex':
				if (Math.abs(diameter - convertFrom(0.5, 'in')) < 1e-5) {
					// 1/2 thunderhex has a 5.1mm hole
					S = (.12*Math.pow(diameter, 4) - .098*Math.pow(5.1e-3, 4))/(1.154*diameter/2);
				} else if (Math.abs(diameter - convertFrom(0.375, 'in')) < 1e-5) {
					// 3/8 thunderhex has a 4.2mm hole
					S = (.12*Math.pow(diameter, 4) - .098*Math.pow(4.2e-3, 4))/(1.154*diameter/2);
				} else {
					document.getElementById(prefix+"_diameter").classList.add('error');
					return 0;
				}
				return S*matl.Sy/2;
		}
	}

	function computeTransmission(x, torque, speed, n_inputs) {
		let container = document.getElementById(`transmission_${x}_detail`);
		let type      = document.getElementById(`transmission_${x}_type`).value;
		if(type=='vp'){
			let caps = [0,0,0,0,0]; // in this array shaft is first, connected to fourth, then third, then second, then first stage (motor connected to first stage)
			let overall_ratio = 1;

			for (let i=4; i>=1; i--) {
				let id = `transmission_${x}_stage_${i}`;
				let ratio = document.getElementById(id).value;
				let stagecap = +Infinity;
				document.getElementById(id).classList.remove('error');
				if ([3,4,5].includes(parseInt(ratio))) {
					stagecap = +Infinity*overall_ratio;
					overall_ratio *= parseInt(ratio);
				} else if ([7,9,10].includes(parseInt(ratio))) {
					stagecap = 100*overall_ratio;
					overall_ratio *= parseInt(ratio);
				} else if (typeof ratio=='string' && ratio.toLowerCase().startsWith('r')) {
					stagecap = 160*overall_ratio;
				} else if (ratio!=='') {
					stagecap = 0;
					document.getElementById(id).classList.add('error');
				}
				caps[i] = stagecap;
			}
			let shaftmap = {
				hex_500: 157,
				hex_375: 57,
				rnd_500: 130,
				cim:     29
			};

			let versadm = document.getElementById(`transmission_${x}_versadm`).value;
			if (versadm != '') {
				overall_ratio *= parseFloat(versadm);
			}

			caps[0] = shaftmap[document.getElementById(`transmission_${x}_shaft`).value];

			let idxmin  = caps.indexOf(Math.min(...caps));
			let capmin  = Math.min(...caps);
			let torqout = torque*overall_ratio;
			let fosmin  = capmin/torqout;
			let spdout  = speed/overall_ratio;

			setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_fos`,        fosmin);
			setV(`transmission_${x}_fos_pos`,    idxmin ? `Stage ${idxmin}` : 'Shaft');
			setV(`transmission_${x}_ratio`,      overall_ratio);

			if(document.getElementById(`transmission_${x}_resolves_multimotor`).checked) n_inputs = 1;

			return [fosmin, torqout, overall_ratio, spdout, n_inputs];
		} else if (type=='up'){
			let caps = [+Infinity,0,0,0,0]; // in this array shaft is first, connected to fourth, then third, then second, then first stage (motor connected to first stage)
			let overall_ratio = 1;

			for (let i=4; i>=1; i--) {
				let id = `transmission_${x}_stage_${i}`;
				let ratio = document.getElementById(id).value;
				let stagecap = +Infinity;
				document.getElementById(id).classList.remove('error');
				if ([3,4,5].includes(parseInt(ratio))) {
					stagecap       = 40*overall_ratio;
					overall_ratio *= parseInt(ratio);
				} else if (ratio!=='') {
					stagecap = 0;
					document.getElementById(id).classList.add('error');
				}
				caps[i] = stagecap;
			}

			let idxmin  = caps.indexOf(Math.min(...caps));
			let capmin  = Math.min(...caps);
			let torqout = torque*overall_ratio;
			let fosmin  = capmin/torqout;
			let spdout  = speed/overall_ratio;

			setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_fos`,        fosmin);
			setV(`transmission_${x}_fos_pos`,    idxmin ? `Stage ${idxmin}` : 'Shaft');
			setV(`transmission_${x}_ratio`,      overall_ratio);

			if(document.getElementById(`transmission_${x}_resolves_multimotor`).checked) n_inputs = 1;

			return [fosmin, torqout, overall_ratio, spdout, n_inputs];
		} else if (type=='57sport') {
			let series = document.getElementById(`transmission_${x}_series`).value;
			let overall_ratio = document.getElementById(`transmission_${x}_ratio`).value;
			let capmin = STRENGTH_MAP_57SPORT[series][overall_ratio];
			let torqout = torque*overall_ratio;
			let fosmin  = capmin/torqout;
			let spdout  = speed/overall_ratio;

			setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_fos`,        fosmin);
			setV(`transmission_${x}_ratio`,      overall_ratio, 0);

			if(document.getElementById(`transmission_${x}_resolves_multimotor`).checked) n_inputs = 1;

			return [fosmin, torqout, overall_ratio, spdout, n_inputs];
		} else if (type=='spur') {
			computeTeeth(document.getElementById(`transmission_${x}_spacing_drives`));
			let overall_ratio = getV(`transmission_${x}_out_teeth`)/getV(`transmission_${x}_inp_teeth`);
			let torqout = torque*overall_ratio;
			let spdout  = speed/overall_ratio;

			let torq_g_inp = computeGearStrength({
				dp: getDP(x), // invert module to get it into dp
				sy: MATERIAL_DATA[document.getElementById(`transmission_${x}_inp_teeth_matl_detail`).value].Sy,
				w:  getV(`transmission_${x}_inp_teeth_width`),
				n:  getV(`transmission_${x}_inp_teeth`),
				pa: document.getElementById(`transmission_${x}_pa`).value
			})*overall_ratio*n_inputs; // prorate by the gear ratio
			let torq_g_out = computeGearStrength({
				dp: getDP(x), // invert module to get it into dp
				sy: MATERIAL_DATA[document.getElementById(`transmission_${x}_out_teeth_matl_detail`).value].Sy,
				w:  getV(`transmission_${x}_out_teeth_width`),
				n:  getV(`transmission_${x}_out_teeth`),
				pa: document.getElementById(`transmission_${x}_pa`).value
			})*n_inputs;

			let torq_s_inp = computeShaftStrength(`transmission_${x}_inp`)*overall_ratio*n_inputs;
			let torq_s_out = computeShaftStrength(`transmission_${x}_out`);

			let g_caps = [torq_g_inp, torq_g_out];
			let s_caps = [torq_s_inp, torq_s_out];

			let g_idxmin  = g_caps.indexOf(Math.min(...g_caps));
			let g_capmin  = Math.min(...g_caps);
			let g_fosmin  = g_capmin/torqout;

			let s_idxmin  = s_caps.indexOf(Math.min(...s_caps));
			let s_capmin  = Math.min(...s_caps);
			let s_fosmin  = s_capmin/torqout;

			//setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_g_fos`,      g_fosmin);
			setV(`transmission_${x}_g_fos_pos`,  g_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_s_fos`,      s_fosmin);
			setV(`transmission_${x}_s_fos_pos`,  s_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_ratio`,      overall_ratio);

			if(document.getElementById(`transmission_${x}_resolves_multimotor`).checked) n_inputs = 1;

			return [Math.min(g_fosmin), torqout, overall_ratio, spdout, n_inputs];
		} else if (type=='belt') {
			let overall_ratio = getV(`transmission_${x}_out_teeth`)/getV(`transmission_${x}_inp_teeth`);
			let torqout = torque*overall_ratio;			
			let spdout  = speed/overall_ratio;

			// TODO: RPM
			let series   = document.getElementById(`transmission_${x}_series`).value;
			let pitch    = document.getElementById(`transmission_${x}_pitch`).value;
			let convPitch = convertFrom(parseFloat(pitch), pitch.replace(/[0-9.]*/, ''));
			let width    = document.getElementById(`transmission_${x}_width`).value;
			let length   = document.getElementById(`transmission_${x}_beltteeth`).value*convPitch;
			let bdata    = BELT_RATINGS[`${series}_${pitch}`];

			let torq_g_inp = BELT_computeBeltTorqueCapacity(
				bdata, convertTo(speed, 'RPM'),  getV(`transmission_${x}_inp_teeth`), width, length)
				*overall_ratio*n_inputs; // prorate by the gear ratio
			let torq_g_out = BELT_computeBeltTorqueCapacity(
				bdata, convertTo(spdout, 'RPM'), getV(`transmission_${x}_out_teeth`), width, length);

			let torq_s_inp = computeShaftStrength(`transmission_${x}_inp`)*overall_ratio*n_inputs;
			let torq_s_out = computeShaftStrength(`transmission_${x}_out`);

			let g_caps = [torq_g_inp, torq_g_out];
			let s_caps = [torq_s_inp, torq_s_out];

			let g_idxmin  = g_caps.indexOf(Math.min(...g_caps));
			let g_capmin  = Math.min(...g_caps);
			let g_fosmin  = g_capmin/torqout;

			let s_idxmin  = s_caps.indexOf(Math.min(...s_caps));
			let s_capmin  = Math.min(...s_caps);
			let s_fosmin  = s_capmin/torqout;

			//setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_g_fos`,      g_fosmin);
			setV(`transmission_${x}_g_fos_pos`,  g_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_s_fos`,      s_fosmin);
			setV(`transmission_${x}_s_fos_pos`,  s_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_ratio`,      overall_ratio);

			if(document.getElementById(`transmission_${x}_resolves_multimotor`).checked) n_inputs = 1;

			return [Math.min(g_fosmin), torqout, overall_ratio, spdout, n_inputs];
		} else if (type=='chain') {
			let overall_ratio = getV(`transmission_${x}_out_teeth`)/getV(`transmission_${x}_inp_teeth`);
			let torqout = torque*overall_ratio;
			let spdout  = speed/overall_ratio;

			// TODO: RPM
			let series = document.getElementById(`transmission_${x}_series`).value;
			let chnstrength = CHAIN_STRENGTHS[series];
			let pitch = convertFrom(parseInt(series.substring(0,1))/8, 'in');

			let torq_g_inp = chnstrength*pitch*getV(`transmission_${x}_inp_teeth`)/Math.PI*overall_ratio*n_inputs; // prorate by the gear ratio
			let torq_g_out = chnstrength*pitch*getV(`transmission_${x}_out_teeth`)/Math.PI;

			let torq_s_inp = computeShaftStrength(`transmission_${x}_inp`)*overall_ratio*n_inputs;
			let torq_s_out = computeShaftStrength(`transmission_${x}_out`);

			let g_caps = [torq_g_inp, torq_g_out];
			let s_caps = [torq_s_inp, torq_s_out];

			let g_idxmin  = g_caps.indexOf(Math.min(...g_caps));
			let g_capmin  = Math.min(...g_caps);
			let g_fosmin  = g_capmin/torqout;

			let s_idxmin  = s_caps.indexOf(Math.min(...s_caps));
			let s_capmin  = Math.min(...s_caps);
			let s_fosmin  = s_capmin/torqout;

			//setV(`transmission_${x}_torque_cap`, capmin);
			setV(`transmission_${x}_torque_out`, torqout);
			setV(`transmission_${x}_g_fos`,      g_fosmin);
			setV(`transmission_${x}_g_fos_pos`,  g_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_s_fos`,      s_fosmin);
			setV(`transmission_${x}_s_fos_pos`,  s_idxmin ? 'Output':'Input');
			setV(`transmission_${x}_ratio`,      overall_ratio);

			if(document.getElementById(`transmission_${x}_resolves_multimotor`).checked) n_inputs = 1;

			return [Math.min(g_fosmin), torqout, overall_ratio, spdout, n_inputs];
		}
	}

	function compute() {
		let computed_basic = false;
		try{
			let container = document.getElementById('transmission_stages');
			let n_inputs  = getV('motor_count');
			let torque    = getV('motor_stall_torque')*n_inputs;
			let fos       = +Infinity;
			let fos_pos   = NaN;
			let overall_ratio = 1;
			let speed     = getV('motor_max_speed');
			setV('input_torque', torque);
			for(stage of container.children) {
				let res = computeTransmission(stage.dataset.stage_id, torque, speed, n_inputs);
				overall_ratio *= res[2];
				torque = res[1];
				speed  = res[3];
				if (res[0] < fos) {
					fos_pos = stage.dataset.stage_id;
					fos     = res[0];
				}
				n_inputs = res[4];
			}
			
			setV('overall_fos',   fos);
			setV('output_torque', torque);
			setV('output_speed',  speed);
			setV('overall_ratio', overall_ratio);

		}catch(err){
			console.log(err);
			setError(2, err);
			return;
		}
		setError(0);
		if (EXP_dumpPersistence())
			dumpDynamicPersistence();
	}
</script>

<html>

<!-- Make sure to call your init function on document load -->
<!-- You can copy the topbar template here -->
<body onload="init()">
	<div id="topbar">
		<div class="topbar-la selectable" onclick="window.location='./'">EveryCalc</div>
		<div class="topbar-la" id='topbar_version'></div>
		<div class="topbar-la" id='topbar_filename'></div>
		<div class="topbar-la" id='topbar_unit'>
			<!-- Required for unit library. You could also put this in the calculator main body -->
			<select id="unit_select" onchange="UNIT_change(); compute();">
				<option value=0 >Metric</option>
				<option value=1 selected="selected">English</option>
			</select>
		</div>
		<div class="topbar-ctr" id="topbar_title">General Mechanism Calc</div>
		<div class="topbar-ra selectable" id="topbar_status" onclick="compute();"><span></span><span class='ttt'></span></div>
		<div class="topbar-ra selectable" onclick="downloadPage();" id="download">Export HTML</div>
		<div class="topbar-ra selectable" onclick="printPage();">Print</div>
		<div class="topbar-ra selectable" onclick="WALK_enable();">Tutorial</div>
		<a id="download_frame" hidden></a>
	</div>	

	<svg id="walkthrough_overlay" onclick="WALK_nextStep()" >
		<path id="walkthrough_frame" ></path>
		<text id="walkthrough_text" ></text>
		<text id="walkthrough_skip_button" onclick="WALK_disable();">Skip Tutorial</text>
	</svg>

	<!-- From here go nuts, do whatever works for you. Use the container to keep stuff from spilling under topbar. I'll point out patterns to pay attention to. -->
	<div style="" class="container">
		<div style="display:table-row">
			<div class="even" id="user_input_motor" style="display:table-cell;">
				<span># Motors
				<input class='narrow' id="motor_count" oninput="MOTOR_selectMotor('motor'); compute();" value=1 /></span><br/>
				<span class="rowlabel">Motor</span>
				<select class="doublewide" id="motor_select" onchange="MOTOR_selectMotor('motor'); compute();">
				</select>
				<input class="dropdown" type="checkbox" id="toggle-motor">
				<label class="dropdown" for="toggle-motor">V</label>
				<table id='detail_motor' class="dropdown">
					<tr>
						<th class="rowlabel">Free Speed<span class="ttt">The maximum RPM of the motor</span></th>
						<td><input data-unit="omega" id="motor_max_speed" readonly value=5880 /></td>
						<td class="unit" data-unit="omega" >[RPM]</td>
					</tr><tr>
						<th class="rowlabel">Stall Torque<span class="ttt">The maximum torque of the motor, occurring at 0 RPM</span></th>
						<td><input data-unit="motor-torque" id="motor_stall_torque" readonly value=3.36 /></td>
						<td class="unit" data-unit="motor-torque" id="unit_motor_stall_torque"></td>
					</tr><tr>
						<th class="rowlabel">Free Current<span class="ttt">The current drawn when the motor is unloaded</span></th>
						<td><input id="motor_free_current" readonly value=1.3 /></td>
						<td class="unit">[A]</td>
					</tr><tr>
						<th class="rowlabel">Stall Current<span class="ttt">The current drawn at 0 RPM / Max Torque</span></th>
						<td><input id="motor_stall_current" readonly value=166 /></td>
						<td class="unit">[A]</td>
					</tr>
				</table>
				<select class="doublewide" id="predefined_select" onchange="selectPredefinedGearbox(); compute();">
				</select>
			</div>
			<div class="output" id="computed_outputs" style="display:table-cell;">
				<table>
					<tr>
						<th class="rowlabel">Input Torque</th>
						<td><input data-unit="torque" id="input_torque" readonly /></td>
						<td class="unit" data-unit="torque"></td>
					</tr><tr>
						<th class="rowlabel">Output Torque</th>
						<td><input data-unit="torque" id="output_torque" readonly /></td>
						<td class="unit" data-unit="torque"></td>
					</tr><tr>
						<th class="rowlabel">Output Speed</th>
						<td><input data-unit="omega" id="output_speed" readonly /></td>
						<td class="unit" data-unit="omega"></td>
					</tr><tr>
						<th class="rowlabel">Overall Gear Ratio</th>
						<td><input id="overall_ratio" readonly /></td>
					</tr><tr>
						<th class="rowlabel">Overall FOS</th>
						<td><input id="overall_fos" readonly /></td>
					</tr>
				</table>
			</div>
		</div>
		<div style="">
			<div id="transmission_stages" data-current_stage_id=0 ></div>
			<button id="add_transmission_stage" onclick="addTransmissionStage(); compute();" style="width: 100%">Add Stage</button>
		</div>
	</div>
</div>
</body>
</html>