<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css"> 

<!-- Include relevant libraries -->
<script type="text/javascript" src="js/eclib.js"></script>
<script type="text/javascript" src="js/units.js"></script>
<script type="text/javascript" src="js/export.js"></script>
<script type="text/javascript" src="js/motors.js"></script>
<script type="text/javascript" src="js/plots.js"></script>
<script type="text/javascript" src="js/walkthrough.js"></script>

<!-- Export library requires this script tag -->
<script id="EXP_inputs_frame" ></script>

<script type="text/javascript" id="main">

	EXP_FN_BASE = 'simplemech'; // filename base for export utility
	UNIT_MAP = { // map of units
		"torque": ["N-m", "in-lbf"],
		"encoder_cpx": ["c/m", "c/ft"],
		"radius": ["mm","in"],
		"force": ["N", "lbf"],
		"mass": ["kg", "lbm"],
		"speed": ["m/s", "ft/s"],
		"distance": ["m", "ft"],
		"acceleration": ["m/s^2", "ft/s^2"],
		'moi': ['kg mm^2', 'lbm in^2'],
		"omega": ["RPM", "RPM"],
		"theta": ["rev", "rev"],
		"alpha": ["RPM/s", "RPM/s"],
		"angle": ["deg", "deg"],
		"pct":   ["%", "%"]
	};
	/*WALK_STEPS = [{
			poi: 'user_input_motor',
			desc: 'Input details about the motors powering your mechanism...',
			valign: 'bottom'
		},{
			poi: 'user_input_gratio',
			desc: 'Input the gear ratio (you can use the dropdown to compute it)...'
		},{
			poi: 'user_input_encoder',
			desc: 'The encoder box can be used to help figure out encoder resolution...'
		},{
			poi: 'user_input_traction',
			desc: 'Traction limiting should be used for drivetrains...'
		},{
			poi: 'user_input_electrical',
			desc: 'Simultion of voltage drop and current limiting can be done...'
		},{
			poi: 'user_input_radius',
			desc: "Plug in the effective radius of your mechanism (arm length, wheel radius, or spool radius)..."
		},{
			poi: 'user_input_mass',
			desc: 'Plug in the mass of the system being accelerated...'
		},{
			poi: 'user_input_load',
			desc: 'Plug in the load perpindicular to the radius...'
		},{
			poi: 'user_input_endcond',
			desc: 'Plug in an end condition for simulation...'
		},{
			poi: 'computed_outputs',
			desc: 'Computed/simulated values will appear here.'
		},{
			poi: 'chart',
			desc: 'Simulation results are plotted here.'
		},{
			poi: 'chart',
			desc: 'Click on the plot to probe points for values.'
		},{
			poi: 'toggle_tips_label',
			desc: 'More tips and notes are in here.'
		},{
			poi: 'toggle_varref_label',
			desc: 'Variables that can be used in the load and end condition expressions are here.'
		}];*/
</script>
<script type="text/javascript">

	/* Initialization routine run on page load */
	function init() {
		EC_onload();
		MOTOR_setupMotorSelect("motor");
		EXP_onload();
		MOTOR_selectMotor("motor");
		UNIT_change();

		// on keyup for all variables
		EC_setOnInput(function(e) {
			let key = e.keyCode ? e.keyCode : e.which;
			let input = e.target;

		  	if(input.id.startsWith('toggle')) return; // ignore these, just css stuff

	    	// if a key is pressed, invalidate current results
	    	setError(1);
			if (input.type == 'checkbox') {
				compute();
			}
		});
		EC_setOnKeyUp(); // default handler is OK
		compute();
		//WALK_onload();
	}

	function registerCallbacks() {
		EC_setOnInput(function(e) {
	    	let key = e.keyCode ? e.keyCode : e.which;
	    	let input = e.target;
	    	if(input.id.startsWith('toggle')) return; // ignore these, just css stuff
	    	if(input.id.startsWith('section_')) {
	    		computeMOI();
	    	}
	    	if(input.id.startsWith('transmission_')) {
	    		let str = input.id.split('_');
	    		computeTransmission(str[1]);
	    	}
			if(key!=13) setError(1);
	    });
		EC_setOnKeyUp(); // default handler OK
	}

	function addTransmissionStage(params) {
		setError(1);
		let container = document.getElementById('transmission_stages');
		let transmission = document.createElement('div');
		x = container.dataset.current_stage_id;
		container.dataset.current_stage_id ++;
		transmission.innerHTML = `
		<span>
			<select class="dynamic-input" id="transmission_${x}_type" onchange="selectTransmissionType(${x}); compute();">
				<option value="spur" >Spur</option>
				<option value="belt" >Belt</option>
				<option value="chain" >Chain</option>
				<option value="vp"  selected='selected' >VersaPlanetary</option>
			</select>
		</span><span style="float:right;">
			<button onclick="moveLoad(${x},+1); compute();" title="Move Up">^</button>
			<button onclick="moveLoad(${x},-1); compute();" title="Move Down">v</button>
			<button onclick="removeLoad(${x}); compute();" title="Remove">X</button>
		</span>
		<div id="transmission_${x}_detail" style="width:100%; overflow:hidden;"></div>
		`;
		transmission.dataset.stage_id = x;
		transmission.classList.add(x%2 ? 'even' : 'odd');
		container.appendChild(transmission);
		if (typeof params != 'undefined') {
			// process args
		}
		selectTransmissionType(x);
		registerCallbacks();
	}

	function selectTransmissionType(x) {
		let container = document.getElementById(`transmission_${x}_detail`);
		let type      = document.getElementById(`transmission_${x}_type`).value;
		switch(type) {
			case 'spur':
				container.innerHTML =`
				<table>
					<tr>
						<td class="rowlabel">IN</td>
					</tr><tr>
						<td class="rowlabel">OUT</td>
					</tr>
				</table>
				`;
				break;
			case 'vp':
				container.innerHTML =`
				<table style="float: left">
					<tr>
						<td class="rowlabel">Stage 1 </td>
						<td><input id="transmission_${x}_stage_1" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 2 </td>
						<td><input id="transmission_${x}_stage_2" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 3 </td>
						<td><input id="transmission_${x}_stage_3" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Stage 4 </td>
						<td><input id="transmission_${x}_stage_4" /></td>
						<td>:1</td>
					</tr><tr>
						<td class="rowlabel">Output Shaft: </td>
						<td colspan=2><select id="transmission_${x}_shaft" >
							<option value="hex_500">1/2" Hex</option>
							<option value="hex_375">3/8" Hex</option>
							<option value="rnd_500">1/2" Keyed</option>
							<option value="cim">CIM Shaft</option>
						</select></td>
					</tr>
				</table>

				<table style="float:right">
					<tr>
						<td class="rowlabel" readonly>Ratio </td>
						<td><input id="transmission_${x}_ratio" readonly /></td>
						<td></td>
					</tr><tr>
						<td class="rowlabel">Output/Capacity</td>
						<td><input id="transmission_${x}_torque_out" data-unit="torque" readonly /></td>
						<td>/</td>
						<td><input id="transmission_${x}_torque_cap" data-unit="torque" readonly /></td>
						<td class="unit" data-unit="torque" ></td>
					</tr><tr>
						<td class="rowlabel">Factor of Safety </td>
						<td><input id="transmission_${x}_fos" readonly /></td>
						<td>@</td>
						<td><input id="transmission_${x}_fos_pos" readonly /></td>
					</tr>
				</table>
				`;
				break;
		}
		UNIT_change();
	}

	function computeTransmission(x) {
		console.log('computing', x);
		let container = document.getElementById(`transmission_${x}_detail`);
		let type      = document.getElementById(`transmission_${x}_type`).value;
		switch(type) {
			case 'spur':
				
				break;
			case 'vp':
				let caps = [0,0,0,0,0]; // in this array shaft is first, connected to fourth, then third, then second, then first stage (motor connected to first stage)
				let overall_ratio = 1;
				for (let i=4; i>=1; i--) {
					let id = `transmission_${x}_stage_${i}`;
					let ratio = document.getElementById(id).value;
					let stagecap = +Infinity;
					document.getElementById(id).classList.remove('error');
					if ([3,4,5].includes(parseInt(ratio))) {
						stagecap = +Infinity*overall_ratio;
						overall_ratio *= parseInt(ratio);
					} else if ([7,9,10].includes(parseInt(ratio))) {
						stagecap = 100*overall_ratio;
						overall_ratio *= parseInt(ratio);
					} else if (typeof ratio=='string' && ratio.toLowerCase().startsWith('r')) {
						stagecap = 160*overall_ratio;
					} else if (ratio!=='') {
						stagecap = 0;
						document.getElementById(id).classList.add('error');
					}
					caps[i] = stagecap;
				}
				let shaftmap = {
					hex_500: 157,
					hex_375: 57,
					rnd_500: 130,
					cim:     29
				};
				caps[0] = shaftmap[document.getElementById(`transmission_${x}_shaft`).value];

				let idxmin = caps.indexOf(Math.min(...caps));
				let capmin = Math.min(...caps);

				setV(`transmission_${x}_torque_cap`, capmin);
				setV(`transmission_${x}_fos_pos`, idxmin ? `Stage ${idxmin}` : 'Shaft');
				setV(`transmission_${x}_ratio`, overall_ratio, 0);

				break;
		}
	}

	function compute() {
		let computed_basic = false;
		try{
			
		}catch(err){
			console.log(err);
			setError(2, err);
			return;
		}
		setError(0);
		EXP_dumpPersistence();
	}
</script>

<html>

<!-- Make sure to call your init function on document load -->
<!-- You can copy the topbar template here -->
<body onload="init()">
	<div id="topbar">
		<div class="topbar-la selectable" onclick="window.location='./'">EveryCalc</div>
		<div class="topbar-la" id='topbar_version'></div>
		<div class="topbar-la" id='topbar_filename'></div>
		<div class="topbar-la" id='topbar_unit'>
			<!-- Required for unit library. You could also put this in the calculator main body -->
			<select id="unit_select" onchange="UNIT_change(); compute();">
				<option value=0 >Metric</option>
				<option value=1 selected="selected">English</option>
			</select>
		</div>
		<div class="topbar-ctr" id="topbar_title">General Mechanism Calc</div>
		<div class="topbar-ra selectable" id="topbar_status" onclick="compute();"><span></span><span class='ttt'></span></div>
		<div class="topbar-ra selectable" onclick="downloadPage();" id="download">Export HTML</div>
		<div class="topbar-ra selectable" onclick="printPage();">Print</div>
		<div class="topbar-ra selectable" onclick="WALK_enable();">Tutorial</div>
		<a id="download_frame" hidden></a>
	</div>	

	<svg id="walkthrough_overlay" onclick="WALK_nextStep()" >
		<path id="walkthrough_frame" ></path>
		<text id="walkthrough_text" ></text>
		<text id="walkthrough_skip_button" onclick="WALK_disable();">Skip Tutorial</text>
	</svg>

	<!-- From here go nuts, do whatever works for you. Use the container to keep stuff from spilling under topbar. I'll point out patterns to pay attention to. -->
	<div style="" class="container">
		<div style="display:table-row">
			<div class="even" id="user_input_motor" style="display:table-cell;">
				<span># Motors
				<input class='narrow' id="motor_count" oninput="MOTOR_selectMotor('motor'); compute();" value=1 /></span><br/>
				<span class="rowlabel">Motor</span>
				<select class="doublewide" id="motor_select" onchange="MOTOR_selectMotor('motor'); compute();">
				</select>
				<input class="dropdown" type="checkbox" id="toggle-motor">
				<label class="dropdown" for="toggle-motor">V</label>
				<table id='detail_motor' class="dropdown">
					<tr>
						<th class="rowlabel">Free Speed<span class="ttt">The maximum RPM of the motor</span></th>
						<td><input data-unit="omega" id="motor_max_speed" readonly value=5880 /></td>
						<td class="unit" data-unit="omega" >[RPM]</td>
					</tr><tr>
						<th class="rowlabel">Stall Torque<span class="ttt">The maximum torque of the motor, occurring at 0 RPM</span></th>
						<td><input data-unit="torque" id="motor_stall_torque" readonly value=3.36 /></td>
						<td class="unit" data-unit="torque" id="unit_motor_stall_torque"></td>
					</tr><tr>
						<th class="rowlabel">Free Current<span class="ttt">The current drawn when the motor is unloaded</span></th>
						<td><input id="motor_free_current" readonly value=1.3 /></td>
						<td class="unit">[A]</td>
					</tr><tr>
						<th class="rowlabel">Stall Current<span class="ttt">The current drawn at 0 RPM / Max Torque</span></th>
						<td><input id="motor_stall_current" readonly value=166 /></td>
						<td class="unit">[A]</td>
					</tr>
				</table>
			</div>
			<div class="output" id="computed_outputs" style="display:table-cell;">
				<table>
					<tr>
						<th class="rowlabel">Input Torque</th>
						<td><input data-unit="torque" id="input_torque" readonly /></td>
						<td class="unit" data-unit="torque"></td>
					</tr><tr>
						<th class="rowlabel">Output Torque</th>
						<td><input data-unit="torque" id="output_torque" readonly /></td>
						<td class="unit" data-unit="torque"></td>
					</tr><tr>
						<th class="rowlabel">Overall Gear Ratio</th>
						<td><input id="overall_ratio" readonly /></td>
					</tr><tr>
						<th class="rowlabel">Overall FOS</th>
						<td><input id="overall_fos" readonly /></td>
					</tr>
				</table>
			</div>
		</div>
		<div style="">
			<div id="transmission_stages" data-current_stage_id=0 ><!-- transmission stages will go inside of here --></div>
			<button id="add_transmission_stage" onclick="addTransmissionStage()" style="width: 100%">Add Stage</button>
		</div>
	</div>
</div>
</body>
</html>