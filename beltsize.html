<!DOCTYPE html>
<link rel="stylesheet" href="style.css"> 
<script type="text/javascript" src="specs.js"></script>
<script type="text/javascript">
	function thload() {
		vendor_select();
		driver_select();
		switch_type();
	}

	function gidv(id) {
		return parseFloat(document.getElementById(id).value);
	}

	function calc_l (cc, d1t, d2t, crossed) {
		d1 = Math.min(d1t, d2t);
		d2 = Math.max(d1t, d2t);
		theta = Math.asin((crossed ? (d2+d1) : (d2-d1))/2/cc);
		if (crossed)
			return 2*cc*Math.sqrt(1-((d2+d1)/2/cc)*((d2+d1)/2/cc)) + Math.PI*(d1+d2)/2 + theta*(d2+d1);
		else
			return 2*cc*Math.sqrt(1-((d2-d1)/2/cc)*((d2-d1)/2/cc)) + Math.PI*(d1+d2)/2 + theta*(d2-d1);
	}

	function wrap_1(d1, d2, cc, pitch) {
		theta = Math.asin((d2-d1)/2/cc);
		return d1/2*(Math.PI - 2*theta)/pitch;
	}

	function wrap_2(d1, d2, cc, pitch) {
		theta = Math.asin((d2-d1)/2/cc);
		return d2/2*(Math.PI + 2*theta)/pitch;
	}

	function calc_cc (l, d1, d2, crossed) {
		a = l;
		b = (d1+d2)/2;
		c = (a+b)/2;
		n = 0;
		while (n<100) {
			n++;
			c = (a+b)/2;
			fa = calc_l(a, d1, d2, crossed) - l;
			fb = calc_l(b, d1, d2, crossed) - l;
			fc = calc_l(c, d1, d2, crossed) - l;

			if (Math.abs(fc)<1e-4) {
				break;
			}

			if (fc*fa > 0)	a = c;
			else			b = c;
		}
		//console.log('found', c, 'in', n);
		return c;
	}

	function compute() {
		var uconv = 1;

		if (document.getElementById('unit_inch').checked) uconv = 25.4;
		else if (document.getElementById('unit_mm').checked) uconv = 1;
		else return;

		pitch = gidv('pitch') / uconv;
		p1 = gidv('p1_n') * pitch / Math.PI;	
		p2 = gidv('p2_n') * pitch / Math.PI;

		document.getElementById("ratio").value = (p2/p1).toFixed(4);

		document.getElementById("p1_pd").value = p1.toFixed(4);
		document.getElementById("p2_pd").value = p2.toFixed(4);

		if (gidv('pitch')==5) {
			od1 = p1 + 1.1/uconv;
			od2 = p2 + 1.1/uconv;
			document.getElementById('p1_od').value = od1.toFixed(4);
			document.getElementById('p2_od').value = od2.toFixed(4);
		} else {
			document.getElementById('p1_od').value = '';
			document.getElementById('p2_od').value = '';
		}


		v = document.getElementById("driver").value;
		//console.log(v);
		if(v == "teeth") {
			nb = gidv('driver_val');
			l = nb*pitch;
			cc = calc_cc(l, p1, p2, false) + gidv("center_add");
			//console.log("center-center: ", cc);
			if (isNaN(cc) || cc <= (p1+p2)/2*1.01) {
				document.getElementById("n_teeth_s").value = 'pulleys';
				document.getElementById("l_s")		.value = 'are';
				document.getElementById("cc_s")		.value = 'too';
				document.getElementById("p1_s")		.value = 'close';
				document.getElementById("p2_s")		.value = '!';
			} else {
				document.getElementById("n_teeth_s").value = nb.toFixed(4);
				document.getElementById("l_s")		.value = l.toFixed(4);
				document.getElementById("cc_s")		.value = cc.toFixed(4);
				document.getElementById("p1_s")		.value = wrap_1(p1,p2,cc,pitch).toFixed(4);
				document.getElementById("p2_s")		.value = wrap_2(p1,p2,cc,pitch).toFixed(4);
			}
		} else if (document.getElementById('type_timing').checked) {
			cc = gidv('driver_val') - gidv("center_add");
			l = calc_l(cc, p1, p2, false);
			nb = l/pitch;

			vendor = document.getElementById('vendor').value;
			if (vendor == 'raw') {
				inc = gidv('raw_inc');
				nb_s = Math.floor(nb/inc)*inc;
				nb_l = nb_s + inc;
			} else {
				//console.log(vendor);
				var belts_opts = belts_data[vendor][document.getElementById('pitch').value+"mm"];
				i=0;
				nb_s = NaN;
				nb_l = NaN;
				for(;i<belts_opts.length;i++) {
					if(belts_opts[i] > nb) {
						break;
					}
				}
				nb_s = belts_opts[i-1];
				nb_l = belts_opts[i];
			}
			
			l_s = nb_s*pitch;
			l_l = nb_l*pitch;
			cc_s = calc_cc(l_s, p1, p2, false) + gidv("center_add");
			cc_l = calc_cc(l_l, p1, p2, false) + gidv("center_add");

			if (isNaN(cc_l) || cc_l <= (p1+p2)/2*1.01) {
				document.getElementById("n_teeth_l").value = 'no';
				document.getElementById("l_l")		.value = 'options';
				document.getElementById("cc_l")		.value = '';
				document.getElementById("p1_l")		.value = '';
				document.getElementById("p2_l")		.value = '!';
			} else {
				document.getElementById("n_teeth_l").value = nb_l.toFixed(4);
				document.getElementById("l_l")		.value = l_l.toFixed(4);
				document.getElementById("cc_l")		.value = cc_l.toFixed(4);
				document.getElementById("p1_l")		.value = wrap_1(p1,p2,cc_l,pitch).toFixed(4);
				document.getElementById("p2_l")		.value = wrap_2(p1,p2,cc_l,pitch).toFixed(4);
			}

			if (isNaN(cc_s) || cc_s <= (p1+p2)/2*1.01) {
				document.getElementById("n_teeth_s").value = 'no';
				document.getElementById("l_s")		.value = 'options';
				document.getElementById("cc_s")		.value = '';
				document.getElementById("p1_s")		.value = '';
				document.getElementById("p2_s")		.value = '!';
			} else {
				document.getElementById("n_teeth_s").value = nb_s.toFixed(4);
				document.getElementById("l_s")		.value = l_s.toFixed(4);
				document.getElementById("cc_s")		.value = cc_s.toFixed(4);
				document.getElementById("p1_s")		.value = wrap_1(p1,p2,cc_s,pitch).toFixed(4);
				document.getElementById("p2_s")		.value = wrap_2(p1,p2,cc_s,pitch).toFixed(4);
			}
		} else {
			crossed = document.getElementById("crossed").checked;
			cc = gidv('driver_val') - gidv("center_add");
			p1 = gidv('p1_n');
			p2 = gidv('p2_n');
			l = calc_l(cc, p1, p2, crossed) / (1+gidv("stretch")/100);

			if (isNaN(cc) || cc <= (p1+p2)/2*1.01) {
				document.getElementById("n_teeth_s").value = 'no';
				document.getElementById("l_s")		.value = 'options';
				document.getElementById("cc_s")		.value = '';
				document.getElementById("p1_s")		.value = '';
				document.getElementById("p2_s")		.value = '!';
			} else {
				document.getElementById("n_teeth_s").value = "-";
				document.getElementById("l_s")		.value = l.toFixed(4);
				document.getElementById("cc_s")		.value = gidv('driver_val').toFixed(4);
				document.getElementById("p1_s")		.value = wrap_1(p1,p2,cc,1).toFixed(4);
				document.getElementById("p2_s")		.value = wrap_2(p1,p2,cc,1).toFixed(4);
			}
		}
	}

	function vendor_select() {
		v = document.getElementById("vendor").value
		//console.log(v);
		if(v == "raw") {
			document.getElementById("raw_inc").style.display="inline-block";
			document.getElementById("raw_inc_label").style.display="inline-block";
		}else {
			document.getElementById("raw_inc").style.display="none";
			document.getElementById("raw_inc_label").style.display="none";
		}

		compute();
	}

	function driver_select() {
		v = document.getElementById("driver").value;
		timing = document.getElementById("type_timing").checked;
		//console.log(v);
		if(v == "teeth" || !timing) {
			document.getElementById("n_teeth_l").style.display="none";
			document.getElementById("l_l").style.display="none";
			document.getElementById("cc_l").style.display="none";
			document.getElementById("p1_l").style.display="none";
			document.getElementById("p2_l").style.display="none";
			document.getElementById("sm_lrg_label").style.display="none";
			document.getElementById("src_label").style.display="none";
			document.getElementById("no_teeth_out").style.display= timing ? "table-row" : "none";
		}else {
			document.getElementById("n_teeth_l").style.display="inline-block";
			document.getElementById("l_l").style.display="inline-block";
			document.getElementById("cc_l").style.display="inline-block";
			document.getElementById("p1_l").style.display="inline-block";
			document.getElementById("p2_l").style.display="inline-block";
			document.getElementById("sm_lrg_label").style.display="table-row";
			document.getElementById("src_label").style.display="table-row";
			document.getElementById("no_teeth_out").style.display= timing ? "table-row" : "none";
		}

		compute();
	}

	function switch_type() {
		v = document.getElementById("type_timing").checked;
		if (v) {
			document.getElementById("driver").readonly = false;
			document.getElementById("th_pitch").style.display="table-row";
			document.getElementById("th_stretch").style.display="none";
			document.getElementById("p1_mesh").innerHTML = "P1 Teeth in Mesh";
			document.getElementById("p2_mesh").innerHTML = "P2 Teeth in Mesh";
			document.getElementById("no_teeth_1").innerHTML = "# Teeth";
			//document.getElementById("center_add").readonly = false;
		} else {
			document.getElementById("driver").value = "cc";
			document.getElementById("driver").readonly = true;
			document.getElementById("th_pitch").style.display="none";
			document.getElementById("th_stretch").style.display="table-row";
			document.getElementById("p1_mesh").innerHTML = "P1 Distance in Mesh";
			document.getElementById("p2_mesh").innerHTML = "P2 Distance in Mesh";
			document.getElementById("no_teeth_1").innerHTML = "Pulley Diam.";
			//document.getElementById("center_add").readonly = true;
		}
		driver_select();
	}
</script>

<html>
<body onload="thload()">
<div style="float: left;" class="container">
	<h3>Thad's Belt Calculator</h3>
	<center>
		<a href="./">Back To Index</a>
	</center>

	<div class="even">
		<center>
			  <input type="radio" id="unit_inch" name="unit" value="inch" onclick="compute()"  checked>
			  <label for="inch">Inches</label>
			  <input type="radio" id="unit_mm" name="unit" value="mm" onclick="compute()" >
			  <label for="mm">Millimeters</label><br>
			  <input type="radio" id="type_timing" name="belt_type" value="timing" onclick="switch_type()" checked>
			  <label for="timing">Timing Belt</label>
			  <input type="radio" id="type_poly" name="belt_type" value="timing" onclick="switch_type()" >
			  <label for="timing">Polybelt</label>
		</center>
	</div>

	<div class="odd">
	
	<table>
		<tr id="th_pitch">
			<th class="rowlabel">Pitch: <span class="ttt">Pitch of the timing belt; the distance from one tooth to the next.</span></th>
			<td><input id="pitch" value=5 onchange="compute()" /></td><td class="unit">mm</td>
		</tr><tr id="th_stretch">
			<th class="rowlabel">Stretch: <span class="ttt">How much stretch to add to the belt. Polycord (round belt) should be 5-20%, polybelt (flat belt) should be 1-3%.</span></th>
			<td><input id="stretch" value=5 onchange="compute()" /></td><td class="unit">%</td>
			<th class="rowlabel">Crossed? <span class="ttt">Whether the belt is crossed in a figure-eight or infinity shape, in order to reverse the direction of motion.</span></th>
			<td><input type="checkbox" id="crossed" value="crossed" onclick="compute()"/></td>
		</tr>
		<tr>
			<td></td>
			<th class="collabel">Pulley 1</th>
			<th class="collabel">Pulley 2</th>
			<th class="collabel" colspan=2>Center</th>
		</tr><tr>
			<th class="rowlabel" id="no_teeth_1"># Teeth</th>
			<th><input id="p1_n" value=24 onchange="compute()" /></th>
			<th><input id="p2_n" value=18 onchange="compute()" /></th>
			<th id="des_cc" class="rowlabel">
				<select id="driver" onchange="driver_select()">
					<option value="teeth">Belt Teeth</option>
					<option value="cc" selected="selected">Desired C-C</option>
				</select>
			</th>
			<th><input id="driver_val" value=5 onchange="compute()" /></th>
			<!--<th id="des_teeth_label" class="rowlabel" style="display:none">Belt Teeth</th>
			<th><input id="des_teeth" value=500 style="display:none" /></th>-->
		</tr><tr>
			<th class="rowlabel">OD</th>
			<th><input id="p1_od" readonly /></th>
			<th><input id="p2_od" readonly /></th>
			<th id="center_add_label" class="rowlabel">Center Add<span class="ttt">Center to add. When using 'desired C-C' mode with polybelt, the additional extra is removed from the belt, not added to the center value.</span></th>
			<th><input id="center_add" value=0.000  onchange="compute()" /></th>
		</tr><tr>
			<th class="rowlabel">PD</th>
			<th><input id="p1_pd" readonly /></th>
			<th><input id="p2_pd" readonly /></th>
			<th class="rowlabel">Ratio</th>
			<th><input id="ratio" readonly /></th>
		</tr><tr id="src_label">
				<th class="collabel" colspan=5>
					Belting Option Source: <select id="vendor" onchange="vendor_select()">
						<option value="vex">VexPro</option>
						<option value="am">AndyMark</option>
						<option value="raw" selected="selected">Increments of</option>
					</select>
					<input id="raw_inc" value=5 onchange="compute()" /><span id="raw_inc_label">Teeth</span>
				</th>
			</tr>
	</table>
	</div><div class="output" id="results_table">
		<center>
		<table>
			<tr id="sm_lrg_label">
				<th class="collabel"></th>
				<th class="collabel">Smaller</th>
				<th class="collabel">Larger</th>
			</tr><tr id="no_teeth_out">
				<th class="rowlabel"># of Teeth</th>
				<td><input id="n_teeth_s" readonly /></td>
				<td><input id="n_teeth_l" readonly /></td>
			</tr><tr>
				<th class="rowlabel">Length</th>
				<td><input id="l_s" readonly /></td>
				<td><input id="l_l" readonly /></td>
			</tr><tr>
				<th class="rowlabel">Center-Center</th>
				<td><input id="cc_s" readonly /></td>
				<td><input id="cc_l" readonly /></td>
			</tr><tr>
				<th class="rowlabel" id="p1_mesh">P1 Teeth In Mesh</th>
				<td><input id="p1_s" readonly /></td>
				<td><input id="p1_l" readonly /></td>
			</tr><tr>
				<th class="rowlabel" id="p2_mesh">P2 Teeth In Mesh</th>
				<td><input id="p2_s" readonly /></td>
				<td><input id="p2_l" readonly /></td>
			</tr>
		</table>
	</center>
	</div>
	</div>
</div>
</body>
</html>