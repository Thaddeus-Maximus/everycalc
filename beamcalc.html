<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css">

<!-- Include relevant libraries -->
<script type="text/javascript" src="include/eclib.js"></script>
<script type="text/javascript" src="include/units.js"></script>
<script type="text/javascript" src="include/export.js"></script>
<script type="text/javascript" src="include/motors.js"></script>
<script type="text/javascript" src="include/plots.js"></script>

<!-- Export library requires this script tag -->
<script id="EXP_inputs_frame" ></script>

<script type="text/javascript">
  EXP_FN_BASE = 'beam';
	UNIT_MAP = {
		'force':           ['N', 'lbf'],
		'elastic_modulus': ['GPa', '10^6 psi'],
		'moi':       ['mm^4', 'in^4'],
		'area': 	 ['mm^2', 'in^2'],
		'section_1': ['mm', 'in'],
		'section_2': ['mm', 'in'],
		'section_3': ['mm', 'in'],
		'section_4': ['mm', 'in'],
		'length':    ['mm', 'in'],
		'rmax':      ['mm', 'in'],
		'rmin':      ['mm', 'in'],
		'query_l':   ['mm', 'in'],
		'query_q':   ['mm', 'thou'],
		'query_m':   ['N-m', 'ft-lbf'],
		'query_sl':  ['deg', 'deg'],
		'query_sh':  ['N', 'lbf'],
		'query_stress_bend_top': ['MPa', 'psi'],
		'query_stress_bend_bot': ['MPa', 'psi'],
		'query_stress_shear':    ['MPa', 'psi'],
		'density': ['g/cm^3', 'lbm/in^3'],
		'mass':    ['kg',  'lbm'],
		'Sf':      ['MPa', 'psi']
	}

	function init() {
		EC_onload();
		EXP_onload();
		// UNIT_onload ? should also be in simplemech

		populate_materials();
		document.getElementById('material').value = 'Aluminum';
		selectMaterial();

		// custom code to make default inputs
		// cookies preferred
		if(!packed_inputs) {
			addLoad({where: 10, amount: 0, type: 0});
			addLoad({where: 50, amount: 0, type: 0});
			addLoad({where: 90, amount: 100, type: 2});
			addLoad({where: 10, amount: -10, type: 3});
			document.getElementById('length').value=100;
		}

		selectShape();
		computeMOI();

		EC_setOnInputChange(function(e) {
	    	let key = e.keyCode ? e.keyCode : e.which;
	    	let input = e.target;
			setError(1);

			if (key == 13) compute();
	    });

		compute();
	}

	/* may need to make a collapse_table?
	function collapse(id) {
		tbl = document.getElementById('table_'+id);

		btn = document.getElementById('toggle_detail_'+id);
		if(tbl.rows[1].style['display'] != 'none') {
			for(i=1;i<tbl.rows.length;i++) tbl.rows[i].style['display'] = 'none';
			btn.innerHTML = "&#9660";
		} else {
			for(i=1;i<tbl.rows.length;i++) tbl.rows[i].style['display'] = 'table-row';
			btn.innerHTML = "&#9650";
		}
	}*/

	function computeMOI() {
		invalidate_computations();
		shape = document.getElementById('section').value;
		var moi, area, rmax, rmin;
		flip = document.getElementById('section_flip').checked;
		// TODO: unsupported sections
		if (shape == 'rndbar') {
			d = getV('section_1');
			rmax = rmin = d/2;
			area = Math.PI/4 * d*d;
			moi = Math.PI/64*Math.pow(d,4);
		} else if (shape == 'boxbar') {
			w = getV('section_1');
			h = getV('section_2');
			rmax = rmin = h/2;
			area = w*h;
			moi = w*Math.pow(h,3)/12;
		} else if (shape == 'boxtube') {
			w = getV('section_1');
			h = getV('section_2');
			t = getV('section_3');
			rmax = rmin = h/2;
			area = w*h - (w-2*t)*(w-2*t);
			moi = (w*Math.pow(h,3) - (w-2*t)*Math.pow(h-2*t,3))/12;
		} else if (shape == 'angle') {
			a = getV('section_1');
			b = getV('section_2');
			t = getV('section_3');
			d = b - t;
			c = a - t;
			rmin = (t*(2*d+a)+d*d)/2/(d+a);
			rmax = b-rmin;
			area = a*b - c*d;
			moi  = 1/3*(t*Math.pow(rmax, 3)+ a*Math.pow(b-rmax,3 ) - (a-t)*Math.pow(b-rmax-t, 3));
			if(flip) {
				tmp  = rmax;
				rmax = rmin;
				rmin = tmp;
			}
		} else if (shape == 'channel') {
			b = getV('section_1');
			d = getV('section_2');
			t = getV('section_3');
			s = t;
			h = d-2*s;
			area = 2*s*b + h*t
			if(flip) {
				rmin = (2*b*b*s + h*t*t)/(2*b*d-2*h*(b-t));
				rmax = b - rmin;
				moi  = (2*s*b*b*b + h*t*t*t)/3 - area*rmin*rmin;
			} else {
				rmin = rmax = d/2;
				moi  = (b*d*d*d - h*h*h*(b-t))/12;
			}
		} else if (shape == 'rndtube') {
			d = getV('section_1');
			t = getV('section_2');
			rmax = rmin = d/2;
			area = Math.PI/4 * (d*d-(d-2*t)*(d-2*t));
			moi = Math.PI/64*(Math.pow(d,4)-Math.pow(d-2*t,4));
		} else if (shape == 'hex') {
			a = getV('section_1')/2; //side length
			id = getV('section_2');
			if (isNaN(id)) id = 0;
			area = Math.sqrt(3)*3/2*a*a 			- Math.PI/4 * id*id;
			moi  = 5/16*Math.sqrt(3)*Math.pow(a, 4) - Math.PI/64*Math.pow(id,4);
			rmax = rmin = flip ? a : (a*2/Math.sqrt(3));
		}

		if (shape != 'custom') {
			setV("moi", moi);
			setV("area", area);
			setV("rmax", rmax);
			setV("rmin", rmin);
		}

	}

	function selectShape(disable_recompute) {
		if(!disable_recompute) invalidate_computations();
		shape = document.getElementById('section').value;
		document.getElementById('moi').readOnly = true;
		document.getElementById('area').readOnly = true;
		document.getElementById('rmax').readOnly = true;
		document.getElementById('rmin').readOnly = true;
		document.getElementById('section_img').src = 'include/section_' + shape + '.svg';
		if (shape == 'custom') {
			document.getElementById('moi').readOnly  = false;
			document.getElementById('area').readOnly = false;
			document.getElementById('rmax').readOnly = false;
			document.getElementById('rmin').readOnly = false;
			document.getElementById('section_flip_row').style.display = 'none';
			for (i=1;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'rndbar') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'Diameter';
			document.getElementById('section_flip_row').style.display = 'none';
			for (i=2;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'boxbar') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'Width';
			document.getElementById('section_2_row').style.display = '';
			document.getElementById('section_2_label').innerHTML = 'Height';
			document.getElementById('section_flip_row').style.display = 'none';
			for (i=3;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'boxtube') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'Width';
			document.getElementById('section_2_row').style.display = '';
			document.getElementById('section_2_label').innerHTML = 'Height';
			document.getElementById('section_3_row').style.display = '';
			document.getElementById('section_3_label').innerHTML = 'Thickness';
			document.getElementById('section_flip_row').style.display = 'none';
			for (i=4;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'channel') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'Width';
			document.getElementById('section_2_row').style.display = '';
			document.getElementById('section_2_label').innerHTML = 'Height';
			document.getElementById('section_3_row').style.display = '';
			document.getElementById('section_3_label').innerHTML = 'Thickness';
			document.getElementById('section_flip_row').style.display = '';
			document.getElementById('section_flip_label').innerHTML = 'Rotate 90?';
			for (i=4;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'angle') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'Width';
			document.getElementById('section_2_row').style.display = '';
			document.getElementById('section_2_label').innerHTML = 'Height';
			document.getElementById('section_3_row').style.display = '';
			document.getElementById('section_3_label').innerHTML = 'Thickness';
			document.getElementById('section_flip_row').style.display = '';
			document.getElementById('section_flip_label').innerHTML = 'Flip 180?';
			for (i=4;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'rndtube') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'OD';
			document.getElementById('section_2_row').style.display = '';
			document.getElementById('section_2_label').innerHTML = 'Thickness';
			document.getElementById('section_flip_row').style.display = 'none';
			for (i=3;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		} else if (shape == 'hex') {
			document.getElementById('section_1_row').style.display = '';
			document.getElementById('section_1_label').innerHTML = 'Width';
			document.getElementById('section_2_row').style.display = '';
			document.getElementById('section_2_label').innerHTML = 'ID';
			document.getElementById('section_flip_row').style.display = '';
			document.getElementById('section_flip_label').innerHTML = 'Rotate 90?';
			for (i=3;i<=4;i++)
				document.getElementById('section_'+i+'_row').style.display = 'none';
		}
		if (!disable_recompute) {
			computeMOI();
			selectMaterial();
		}
	}

	var current_load_number = 0;
	function addLoad(params) {
		setError(1);
		loads = document.getElementById('loads');
		load_div = document.createElement('div');
		x = current_load_number;
		current_load_number ++;
		load_div.innerHTML =
		`<table identifier=${x}>
			<tr>
				<td>[${x}] <button onclick="remove_load(${x}); compute();" title="Remove">-</button></td>
				<td><select id="load_type_${x}" onchange="change_load(${x}); compute();">
					<option value="pin" selected='selected' >Pinned</option>
					<option value="fix">Fixed</option>
					<option value="force">Force </option>
					<option value="moment">Moment</option>
				</select></td>
			</tr>
			<tr id="load_${x}_1_row">
				<th class="rowlabel" id="load_${x}_1_label">L1</th>
				<td><input id="load_${x}_1" onchange="drawbeam()"/></td>
				<td class="unit" id="unit_load_${x}_1"></td>
			</tr><tr id="load_${x}_2_row">
				<th class="rowlabel" id="load_${x}_2_label">L2</th>
				<td><input id="load_${x}_2" onchange="drawbeam()" /></td>
				<td class="unit" id="unit_load_${x}_2"></td>
			</tr><tr id="load_${x}_3_row">
				<th class="rowlabel" id="load_${x}_3_label">L3</th>
				<td><input id="load_${x}_3" onchange="drawbeam()" /></td>
				<td class="unit" id="unit_load_${x}_3"></td>
			</tr><tr id="load_${x}_4_row">
				<th class="rowlabel" id="load_${x}_4_label">L4</th>
				<td><input id="load_${x}_4" onchange="drawbeam()" /></td>
				<td class="unit" id="unit_load_${x}_4"></td>
			</tr>
		</table>`;
		load_div.identifier = x;
		load_div.classList.add(x%2 ? 'even' : 'odd');
		load_div.classList.add('load');
		loads.insertBefore(load_div, loads.lastChild);

		if (typeof params != 'undefined') {
			document.getElementById(`load_${x}_1`).value = params.where;
			document.getElementById(`load_${x}_2`).value = params.amount;
			document.getElementById(`load_type_${x}`).selectedIndex = params.type;
		}
		change_load(x);
		register_callbacks();
	}

	function change_load(i) {
		setError(1);
		type = document.getElementById('load_type_'+i).value;
		if (type == 'pin' ) { //
			document.getElementById(`load_${i}_1_row`).style.display = '';
			document.getElementById(`load_${i}_1_label`).innerHTML = 'At x=';
			document.getElementById(`load_${i}_2_row`).style.display = '';
			document.getElementById(`load_${i}_2_label`).innerHTML = 'F=';
			document.getElementById(`load_${i}_2`).readOnly = true;
			inputs_unit_map[`load_${i}_1`] = ['mm', 'in'];
			inputs_unit_map[`load_${i}_2`] = ['N', 'lbf'];
			for (j=3;j<=4;j++)
				document.getElementById(`load_${i}_${j}_row`).style.display = 'none';
		} else if (type == 'fix' ) { //
			document.getElementById(`load_${i}_1_row`).style.display = '';
			document.getElementById(`load_${i}_1_label`).innerHTML = 'At x=';
			document.getElementById(`load_${i}_2_row`).style.display = '';
			document.getElementById(`load_${i}_2_label`).innerHTML = 'F=';
			document.getElementById(`load_${i}_2`).readOnly = true;
			document.getElementById(`load_${i}_3_row`).style.display = '';
			document.getElementById(`load_${i}_3_label`).innerHTML = 'M=';
			document.getElementById(`load_${i}_3`).readOnly = true;
			inputs_unit_map[`load_${i}_1`] = ['mm', 'in'];
			inputs_unit_map[`load_${i}_2`] = ['N', 'lbf'];
			inputs_unit_map[`load_${i}_3`] = ['N-m', 'ft-lbf'];
			for (j=4;j<=4;j++)
				document.getElementById(`load_${i}_${j}_row`).style.display = 'none';
		} else if (type == 'force' || type == 'moment') {
			document.getElementById(`load_${i}_1_row`).style.display = '';
			document.getElementById(`load_${i}_1_label`).innerHTML = 'At x=';
			document.getElementById(`load_${i}_2_row`).style.display = '';
			document.getElementById(`load_${i}_2_label`).innerHTML = type == 'force' ? 'F=' : 'M=';
			document.getElementById(`load_${i}_2`).readOnly = false;
			inputs_unit_map[`load_${i}_1`] = ['mm', 'in'];
			inputs_unit_map[`load_${i}_2`] = type == 'force' ? ['N', 'lbf'] : ['N-m', 'ft-lbf'];
			for (j=3;j<=4;j++)
				document.getElementById(`load_${i}_${j}_row`).style.display = 'none';
		}
		switch_units();
	}

	function remove_load(load_no) {
		loads = document.getElementById('loads');
		for(i=0; i<loads.children.length-1; i++) {
			if (loads.children[i].identifier == load_no) {
				loads.removeChild(loads.children[i]);
				i--;
			}
			else { // make them even and odd
				loads.children[i].classList.remove(i%2 ? 'odd' : 'even');
				loads.children[i].classList.add(i%2 ? 'even' : 'odd');
			}
		}

		delete inputs_unit_map[`load_${load_no}_1`];
		delete inputs_unit_map[`load_${load_no}_2`];
		delete inputs_unit_map[`load_${load_no}_3`];
		delete inputs_unit_map[`load_${load_no}_4`];
		compute();
	}

	function populate_materials() {
		select = document.getElementById('material');

		i=0;
		for(matl in materials) {
			i++;
			opt = document.createElement('option');
			opt.innerHTML = matl;
			opt.value = matl;
			select.appendChild(opt);
		}
	}

	function selectMaterial() {
		matl = document.getElementById('material').value;

		document.getElementById('elastic_modulus').readOnly = matl != 'custom';
		document.getElementById('Sf').readOnly 				= matl != 'custom';
		document.getElementById('density').readOnly 		= matl != 'custom';

		if (matl != 'custom') {
			gids('elastic_modulus', materials[matl]['Ef']);
			gids('density', materials[matl]['density']);
			gids('mass', materials[matl]['density']*gidv('area')*gidv('length'));
			gids('Sf', materials[matl]['Sf'] ? materials[matl]['Sf'] : '-');
		}

	}
</script>

<script type="text/javascript">
	//la = linearAlgebra();
	function make_stiffness_matrix(EI, L) {
		var m = math.matrix([ [12,  6*L,   -12,  6*L   ],
							  [6*L, 4*L*L, -6*L, 2*L*L ],
							  [-12, -6*L,  12,   -6*L  ],
							  [6*L, 2*L*L, -6*L, 4*L*L ] ]);
		return math.multiply(m, EI/L/L/L);
	}

	function run_fe(E, I, order, poses, forces, moments, pinned, fixed) {
		numel = order.length-1;

		numnode = (numel+1)*2;

		var K = math.matrix(math.zeros([numnode,numnode]));
		F = math.matrix(math.zeros([numnode,1]));
		dofs_to_remove = [];
		for (i in forces){
			F.subset(math.index(order.indexOf(parseInt(i))*2,0), forces[i]);
		}
		for (i in moments){
			F.subset(math.index(order.indexOf(parseInt(i))*2+1,0), moments[i]);
		}
		for (i in pinned){
			dofs_to_remove.push(order.indexOf(parseInt(i))*2);
		}
		for (i in fixed){
			dofs_to_remove.push(order.indexOf(parseInt(i))*2);
			dofs_to_remove.push(order.indexOf(parseInt(i))*2+1);
		}

		for (i=0;i<numel;i++) {
			idx = math.index(math.range(i*2, i*2+4), math.range(i*2, i*2+4));
			ss = K.subset(idx);
			Ks = make_stiffness_matrix(E*I, poses[order[i+1]]-poses[order[i]]);
			K.subset(idx,
				math.add(ss, Ks));
		}

		idx_rmv_l = [];
		for (i=0;i<numnode;i++) {
			if (! dofs_to_remove.includes(i)) idx_rmv_l.push(i);
		}
		idx_rmv = math.index(idx_rmv_l, idx_rmv_l);
		Kp = K.subset(idx_rmv);
		F = F.subset(math.index(idx_rmv_l, 0));
		q = math.multiply(math.inv(Kp), F);
		fq = [];
		offs = 0;
		for (i=0;i<numnode;i++) {
			if (dofs_to_remove.includes(i)){fq.push(0); offs++}
			else fq.push(q._data[i-offs][0]);
		}

		xp = []; // x; position
		tp = []; // theta; angle
		qp = []; // q; deflection
		mp = []; // m; bending moment
		sp = []; // s; shear force
		for (i=0;i<numel;i++) {
			q_seg = fq.slice(i*2, i*2+4);
			dl = poses[order[i+1]] - poses[order[i]];
			for (zeta=-1; zeta<1; zeta+=0.05) {
				xp.push(poses[order[i]] + (zeta+1)/2*dl);
				tp.push(beamShapeFunctionSlope(q_seg, zeta, dl));
				qp.push(beamShapeFunction(q_seg, zeta, dl));
				mp.push(E*I*beamShapeFunctionCurv(q_seg, zeta, dl));
				sp.push(E*I*beamShapeFunctionDcurv(q_seg, zeta, dl));
			}
			zeta = 1;
			xp.push(poses[order[i]] + (zeta+1)/2*dl);
			tp.push(beamShapeFunctionSlope(q_seg, zeta, dl));
			qp.push(beamShapeFunction(q_seg, zeta, dl));
			mp.push(E*I*beamShapeFunctionCurv(q_seg, zeta, dl));
			sp.push(E*I*beamShapeFunctionDcurv(q_seg, zeta, dl));
		}

		rxns = math.flatten(math.subset(math.multiply(K, fq), math.index(math.range(0, numnode-1))))._data;

		return [xp, qp, tp, mp, sp, rxns];
	}

	function beamShapeFunction(arr, zeta, dl) {
		Hfns = [1/4 *Math.pow(1-zeta, 2)*(2+zeta),
				dl/8*Math.pow(1-zeta, 2)*(zeta+1),
				1/4 *Math.pow(1+zeta, 2)*(2-zeta),
				dl/8*Math.pow(1+zeta, 2)*(zeta-1)];
		return math.dot(arr, Hfns);
	}

	function beamShapeFunctionSlope(arr, zeta, dl) {
		Hfns = [3/4*(zeta*zeta-1)*2/dl,
				dl/8*(3*zeta*zeta-2*zeta-1)*2/dl,
				-3/4*(zeta*zeta-1)*2/dl,
				dl/8*(3*zeta*zeta+2*zeta-1)*2/dl];
		return math.dot(arr, Hfns);
	}

	function beamShapeFunctionCurv(arr, zeta, dl) {
		Hfns = [6*zeta/dl/dl,
				(3*zeta-1)/dl,
				-6*zeta/dl/dl,
				(3*zeta+1)/dl];
		/*Hfns = [(4*x-6*dl)/dl/dl/dl,
				(6*x-4*dl)/dl/dl,
				(-12*x+6*dl)/dl/dl/dl,
				(6*x-2*dl)/dl/dl];*/
		return math.dot(arr, Hfns);
	}

	function beamShapeFunctionDcurv(arr, zeta, dl) {
		Hfns = [3/2*Math.pow(2/dl, 3),
				3/4*dl*Math.pow(2/dl, 3),
				-3/2*Math.pow(2/dl, 3),
				3/4*dl*Math.pow(2/dl, 3)];
		/*Hfns = [(4*x-6*dl)/dl/dl/dl,
				(6*x-4*dl)/dl/dl,
				(-12*x+6*dl)/dl/dl/dl,
				(6*x-2*dl)/dl/dl];*/
		return math.dot(arr, Hfns);
	}

	function compute() {
		try{
		selectShape();

		L = gidv('length');

		order   = [0,   1]; // node ids, in order (sort later)
		poses   = {0:0, 1:L}; // positions
		forces  = {}; // maps node ids to values
		moments = {}; // maps node ids to values
		pinned  = {}; // if the node id is in the list, it's pinned
		fixed   = {}; // if the node id is in the list, it's pinned

		loads = document.getElementById('loads');
		for(i=2; i<loads.children.length-1+2; i++) {
			x = loads.children[i-2].identifier;
			type = document.getElementById(`load_type_${x}`).value;

			order.push(i);
			poses[i] = gidv(`load_${x}_1`);
			if (type == 'fix') {
				fixed[i] = x;
			} else if (type == 'pin') {
				pinned[i] = x;
			} else if (type == 'force') {
				forces[i] = gidv(`load_${x}_2`);
			} else if (type == 'moment') {
				moments[i] = gidv(`load_${x}_2`);
			}
		}

		order.sort(function(a, b){ return poses[a]-poses[b]});

		// merge close nodes
		for (i=0;i<order.length-1;i++) {
			if (Math.abs(poses[order[i]] - poses[order[i+1]]) < L/100) {
				oldnode = order[i];
				newnode = order[i+1]
				order.splice(i, 1);
				if (oldnode in poses) {
					poses[newnode] = poses[oldnode];
					delete poses[oldnode];
				}
				if (oldnode in forces) {
					forces[newnode] = forces[oldnode];
					delete forces[oldnode];
				}
				if (oldnode in moments) {
					moments[newnode] = moments[oldnode];
					delete moments[oldnode];
				}
				if (oldnode in pinned) {
					pinned[newnode] = pinned[oldnode];
					delete pinned[oldnode];
				}
				if (oldnode in fixed) {
					fixed[newnode] = fixed[oldnode];
					delete fixed[oldnode];
				}
			}
		}

		[xp, qp, tp, mp, sp, rxns] = run_fe(gidv('moi'), gidv('elastic_modulus'),
			order, poses, forces, moments, pinned, fixed);

		for (pin in pinned) {
			noden = order.indexOf(parseInt(pin));
			gids(`load_${pinned[pin]}_2`, rxns[noden*2]);
		}
		for (fix in fixed) {
			noden = order.indexOf(parseInt(fix));
			gids(`load_${fixed[fix]}_2`, rxns[noden*2]);
			gids(`load_${fixed[fix]}_3`, rxns[noden*2+1]);
		}

		drawchart([xp, qp, tp, mp, sp], [poses, forces, moments, pinned, fixed]);
		}catch(err){
			console.log(err);
			setError(2, err);
			return;
		}
		setError(0);
	}

  //todo: this
	function drawbeam() {
		beam = document.getElementById('chart_beam');
		beam_items = document.getElementById('chart_beam_items');
		while(beam_items.firstChild) beam_items.removeChild(beam_items.firstChild);
		y_axis = document.getElementById('chart_y_axis');

		x0 = Math.min(y_axis.x1.baseVal.value, y_axis.x2.baseVal.value);
		xf = Math.max(y_axis.x1.baseVal.value, y_axis.x2.baseVal.value);
		y0 = beam.y1.baseVal.value;
		len = gidv('length');
		canv_geo = [x0, xf, y0];

		loads = document.getElementById('loads');

		for(i=0; i<loads.children.length-1; i++) {
			x = loads.children[i].identifier;
			type = document.getElementById(`load_type_${x}`).value;


			position = gidv(`load_${x}_1`);
			cp = x0 + (xf-x0)*position/len;

			subhandler = function (event) {
				focus_handler(event.target.getAttribute('cp'));
			}

			if (type == 'fix') {
				shape = document.createElementNS('http://www.w3.org/2000/svg','polyline');
				y2 = y0 + 20;
				x1 = cp - 12;
				x2 = cp + 12;
				shape.classList.add('beam-shape');
				shape.setAttribute('fill', '#111');
				shape.setAttribute('points', `${x2},${y0} ${x1},${y0} ${x1},${y2} ${x2},${y2}`);
				shape.addEventListener('click', subhandler);
				shape.setAttribute('cp', position);
				beam_items.append(shape);
			} else if (type == 'pin') {
				shape = document.createElementNS('http://www.w3.org/2000/svg','polyline');
				y2 = y0 + 20;
				x1 = cp - 10;
				x2 = cp + 10;
				shape.classList.add('beam-shape');
				shape.setAttribute('fill', '#111');
				shape.setAttribute('points', `${cp},${y0} ${x1},${y2} ${x2},${y2}`);
				shape.addEventListener('click', subhandler);
				shape.setAttribute('cp', position);
				beam_items.append(shape);
			} else if (type == 'force') {
				sgn = gidv(`load_${x}_2`) < 0 ? -1 : +1;

				shape = document.createElementNS('http://www.w3.org/2000/svg','polyline');
				y2 = y0 - 25*sgn;
				shape.setAttribute('points', `${cp},${y0} ${cp},${y2}`);
				shape.classList.add('beam-arrow');
				shape.setAttribute('stroke', '#111');
				shape.addEventListener('click', subhandler);
				shape.setAttribute('cp', position);
				beam_items.append(shape);

				shape = document.createElementNS('http://www.w3.org/2000/svg','polyline');
				x1 = cp - 12*sgn;
				x2 = cp + 12*sgn;
				y1 = y0 - 25*sgn;
				y2 = y0 - 45*sgn;
				shape.classList.add('beam-shape');
				shape.setAttribute('fill', sgn>0 ? '#3c3' : '#d22');
				shape.setAttribute('points', `${cp},${y2} ${x1},${y1} ${x2},${y1}`);
				shape.addEventListener('click', subhandler);
				shape.setAttribute('cp', position);
				beam_items.append(shape);
			} else if (type == 'moment') {
				sgn = gidv(`load_${x}_2`) < 0 ? -1 : +1;

				shape = document.createElementNS('http://www.w3.org/2000/svg','circle');
				shape.classList.add('beam-shape');
				shape.setAttribute('fill', sgn>0 ? '#3c3' : '#d22');
				shape.setAttribute('cx', cp);
				shape.setAttribute('cy', y0);
				shape.setAttribute('r', 12);
				shape.addEventListener('click', subhandler);
				shape.setAttribute('cp', position);
				beam_items.append(shape);
			}
		}
	}

	// todo: this
	function find_extrema_handler(event) {
		if (event.buttons != 2) return;
		query_l_unit = inputs_unit_map['query_l'][unit_sys];

		bg = document.getElementById('chart');
		xq = event.clientX - bg.getBoundingClientRect().left;
		//yq = event.clientY - bg.getBoundingClientRect().top;

		lq = (convert(focus_l_max, query_l_unit)-0)/(focus_xf-focus_x0)*(xq-focus_x0);
		if (lq > Math.max(...focus_l) || lq < 0)
			return;

		// init extremization algorithm
		idx = linterp_idx(focus_l, lq);
		direction = -sign(focus_m[idx]) * sign(focus_sl[idx]);
		if (direction == 0) direction = 1; // can't be indecisive
		max_or_min = -sign(focus_m[idx]);
		if (max_or_min == 0) max_or_min = 1;

		while ( idx >= 1 && idx < focus_l.length-1 ) {
			idx += direction;
			if (sign(focus_sl[idx+direction]) != max_or_min*direction)
				break;
		}

		focus_handler(focus_l[idx]);

		event.preventDefault();
		return false;
	}
</script>

<script id="packed_inputs_dump">
	packed_inputs = null; // set to an object/dict (id => value) with some specials
	// unit_sys
</script>

<script>
	function pack_inputs() {
		packed_inputs = {};
		packed_inputs.current_load_number = current_load_number;
		packed_inputs.inputs_unit_map     = inputs_unit_map;
		for (input of document.getElementsByTagName('input')) {
			if (input.type == "text") {
				packed_inputs[input.id] = input.value;
			}
			if (input.type == "radio") {
				packed_inputs[input.id] = input.checked;
			}
		}
		for (input of document.getElementsByTagName('select')) {
			packed_inputs[input.id] = input.value;
		}

		document.getElementById("packed_inputs_dump").innerHTML = "packed_inputs="+JSON.stringify(packed_inputs)+";";
	}

	function unpack_inputs() {
		current_load_number = packed_inputs.current_load_number;
		inputs_unit_map     = packed_inputs.inputs_unit_map;
		delete packed_inputs.current_load_number;
		delete packed_inputs.inputs_unit_map;
		for (key in packed_inputs) {
			if (typeof packed_inputs[key] == "boolean")
				document.getElementById(key).checked = packed_inputs[key];
			else
				document.getElementById(key).value   = packed_inputs[key];
		}

		loads = document.getElementsByClassName('load');
		for (load of loads) {
			load.identifier = load.firstChild.getAttribute('identifier');
		}
		for (btn of document.getElementsByClassName('toggle_button'))
			btn.innerHTML = "&#9650;";
	}

	function readTextFile(file)
	{
		var allText = null;
	    var rawFile = new XMLHttpRequest();
	    rawFile.open("GET", file, false);
	    rawFile.onreadystatechange = function ()
	    {
	        if(rawFile.readyState === 4)
	        {
	            if(rawFile.status === 200 || rawFile.status == 0)
	            {
	                allText = rawFile.responseText;
	            }
	        }
	    }
	    rawFile.send(null);
	    return allText;
	}

	if (!String.prototype.decodeHTML) {
	  String.prototype.decodeHTML = function () {
	    return this.replace(/&apos;/g, "'")
	               .replace(/&quot;/g, '"')
	               .replace(/&gt;/g, '>')
	               .replace(/&lt;/g, '<')
	               .replace(/&amp;/g, '&');
	  };
	}

	months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
	function download_page() {
		today = new Date();
		var fileName = 'beam_' + today.getFullYear()+months[today.getMonth()]+today.getDate();
		fileName = prompt("Enter a filename. (.html will be appended)", fileName)
		if (!fileName) return;
		document.getElementById('topbar_fname').innerHTML = fileName;
		fileName += '.html';


		head = document.head || document.getElementsByTagName('head')[0];

		pack_inputs();

		scripts   = document.getElementsByTagName('script');
		for (script of scripts) {
			if (script.src) {
				scr = readTextFile(script.src);
				script.innerHTML = scr;
				script.removeAttribute('src');
			}
		}

		links = document.getElementsByTagName('link');
		for (link of links) {
			if (link.href) {
				scr = readTextFile(link.href);
				style = document.createElement('style');
				style.type='text/css';
				if(style.styleSheet) {
					style.styleSheet.cssText = scr;
				} else {
					style.appendChild(document.createTextNode(scr));
				}
				head.prepend(style);
				link.parentElement.removeChild(link);
			}
		}


		var fileContent = new XMLSerializer().serializeToString(document).decodeHTML();
		var myFile = new Blob([fileContent], {type: 'text/html'});
		window.URL = window.URL || window.webkitURL;
		dlurl = window.URL.createObjectURL(myFile);
		document.getElementById('download_iframe').download = fileName;
		document.getElementById('download_iframe').href = dlurl;
		document.getElementById('download_iframe').click();
	}

	function print_page() {
		window.print();
	}
</script>


<html>
<body onload="thload()">
<div id="topbar">
	<div class="topbar_la selectable" onclick="window.location='./'">EveryCalc</div>
	<div class="topbar_la" id='topbar_version'></div>
	<div class="topbar_la" id='topbar_fname'></div>
	<div class="topbar_ctr">Beam Calculator</div>
	<div class="topbar_ra selectable" onclick="download_page();" id="download">Export HTML</div>
	<div class="topbar_ra selectable" onclick="print_page();">Print</div>
	<a id="download_iframe" hidden></a>
</div>
	<div style="width: 275px; float: left;" class="container">
		<div class="even">
			<center>
			  <input type="radio" id="unit_english" name="unit" value="english" onclick="switch_units(); compute();">
			  <label for="english">English</label>
			  <input type="radio" id="unit_metric" name="unit" value="metric" onclick="switch_units(); compute();" checked>
			  <label for="metric">Metric</label>
			</center>
			<table>
				<tr>
					<th class='rowlabel'>Length</th>
					<td><input id='length' /></td>
					<td class='unit' id='unit_length'></td>
				</tr>
			</table>
		</div>
		<div class="odd">
			<table id="table_material">

				<tr>
					<th class='rowlabel'>Material</th>
					<td colspan>
						<select id="material" onchange="selectMaterial(); compute();">
							<option value="custom">Custom</option>
						</select>
					</td>
					<td>
						<button type="button" onclick="collapse('material'); selectShape(true)" id='toggle_detail_section' class="toggle_button">&#9650;</button>
					</td>

				</tr>
				<tr>
					<th class='rowlabel'>Flexural Modulus</th>
					<td><input id='elastic_modulus' value=69 /></td>
					<td class='unit' id='unit_elastic_modulus'></td>
				</tr><tr>
					<th class='rowlabel'>Flexural Strength</th>
					<td><input id='Sf' value=30 /></td>
					<td class='unit' id='unit_Sf'></td>
				</tr><tr>
					<th class='rowlabel'>Density</th>
					<td><input id='density' value=0 /></td>
					<td class='unit' id='unit_density'></td>
				</tr><tr>
					<th class='rowlabel'>Mass</th>
					<td><input id='mass' readonly /></td>
					<td class='unit' id='unit_mass'></td>
				</tr>
			</table>
		</div>
		<div class="even">
			<table id="table_section">
				<tr>
					<th class='rowlabel'>Cross-Section</th>
					<td>
						<select id="section" onchange="selectShape(); compute();">
							<option value="rndbar" selected='selected'>Round Bar</option>
							<option value="boxbar">Rect. Bar</option>
							<option value="boxtube">Box Tube</option>
							<option value="channel">Channel</option>
							<option value="rndtube">Round Tube</option>
							<option value="angle">Angle</option>
							<option value="hex">Hexagon</option>
							<option value="custom">Custom</option>
						</select>
					</td>
					<td>
						<button type="button" onclick="collapse('section'); selectShape(true)" id='toggle_detail_section' class="toggle_button">&#9650;</button>
					</td>
				</tr>
				<tr>
					<td colspan=3>
						<center><img id='section_img' src='include/section_boxtube.svg' /></center>
					</td>
				</tr>
				<tr>
					<th class='rowlabel'>MOI<span class="ttt">The area moment of inertia for the section</span></th>
					<td><input id='moi' readonly /></td>
					<td class='unit' id='unit_moi'></td>
				</tr><tr>
					<th class='rowlabel'>Area<span class="ttt">Cross-sectional area</span></th>
					<td><input id='area' readonly /></td>
					<td class='unit' id='unit_area'></td>
				</tr><tr>
					<th class='rowlabel'>Top Height<span class="ttt">Distance from neutral axis to top of section</span></th>
					<td><input id='rmax' readonly /></td>
					<td class='unit' id='unit_rmax'></td>
				</tr><tr>
					<th class='rowlabel'>Bottom Height<span class="ttt">Distance from neutral axis to bottom of section</span></th>
					<td><input id='rmin' readonly /></td>
					<td class='unit' id='unit_rmin'></td>
				</tr><tr id='section_1_row'>
					<th class='rowlabel' id='section_1_label'>D1</th>
					<td><input id='section_1' value=5 /></td>
					<td class='unit' id='unit_section_1'></td>
				</tr><tr id='section_2_row'>
					<th class='rowlabel' id='section_2_label'>D2</th>
					<td><input id='section_2' /></td>
					<td class='unit' id='unit_section_2'></td>
				</tr><tr id='section_3_row'>
					<th class='rowlabel' id='section_3_label'>D3</th>
					<td><input id='section_3' /></td>
					<td class='unit' id='unit_section_3'></td>
				</tr><tr id='section_4_row'>
					<th class='rowlabel' id='section_4_label'>D4</th>
					<td><input id='section_4' /></td>
					<td class='unit' id='unit_section_4'></td>
				</tr><tr id='section_flip_row'>
					<th class='rowlabel' id='section_flip_label'>Flip?</th>
					<td><input type="checkbox" id='section_flip' /></td>
				</tr>
			</table>
		</div>
		<div class="even" id='loads'><center class=""><button id='addLoad_btn' onclick='addLoad()'>Add Load</button><button id='compute_btn' onclick='compute()'>Compute</button><table id="table_protips">
				<tr>
					<th class='rowlabel' colspan=2>Pro-Tips and Easter Eggs</th>
					<td>
						<button type="button" onclick="collapse('protips'); selectShape(true)" id='toggle_detail_protips' class="toggle_button">&#9650;</button>
					</td>
				</tr>
				<tr>
					<td colspan=3>
							Moments are positive counter-clockwise.<br/><br/>
							Click on the chart to query points. <br/><br/>
							Click on the beam elements to query the corresponding points.<br/><br/>
							Right click on the chart near a local extrema to latch on and find the local extrema.<br/><br/>
							Moments are positive-counterclockwise.<br/><br/>
							Bending/shear extrema are at points of interest (constraints/loads). <br/><br/>
							The flexural strength and mass properties are for your usage/reference only- they aren't used in calculations.
					</td>
				</tr>
			</table></center></div> <!-- MAKE SURE NO SPACES! NO DEAD CHLDREN! -->
	</div>


<div style="margin-left: 0px;" class="container" id="charts">

<style>
	.beam {
		stroke: #555;
		stroke-width: 8px;
	}
	.graph {
		height: 600px !important;
		width: 700px !important;
	}

	.beam-shape {
		stroke: none;
	}

	.beam-arrow {
		stroke-width: 3;
	}

	.load {
		border-top: 2px solid #333 !important;
	}
</style>

<svg version="1.2" class="graph" id='chart' aria-labelledby="title" role="img">
  <title id="title">Position/Velocity Data</title>



<rect class="background" id="chart_background" x=70 y=20 width=555 height=430 />
<g class="x-grid">
  <line id="chart_x_axis" class="axes" x1=70 x2=70 y1=20 y2=450 ></line>
</g>
<g class="y-grid">
  <line id="chart_y_axis" class="axes" x1=70 x2=625 y1=235 y2=235></line>
  <line id="chart_z_axis" class="axes" x1=625 x2=625 y1=20 y2=450></line>
</g>

<g class="beam">
  <line id="chart_beam" class="beam" x1=70 x2=625 y1=550 y2=550 ></line>
</g>
<g id="chart_beam_items"></g>

<g class="x-grid" id="chart_x_grid"></g>
<g class="y-grid" id="chart_y_grid"></g>
<g class="z-grid" id="chart_z_grid"></g>

<g class="labels x-labels" id='chart_x_labels'>
  <text x="325" y=485 class="label-title" id="chart_x_label">Position [mm]</text>
</g>

<g class="labels y-labels" id='chart_y_labels'>
  <text x=-240 y=15 class="label-title" transform="rotate(270)" id="chart_q_label" fill="#0074d9">Deflection [mm]</text>
</g>

<g class="labels z-labels" id='chart_z_labels'>
  <text x=-240 y=700 class="label-title" transform="rotate(270)" id="chart_m_label" fill="#d91200">Bending Moment [N-m]</text>
</g>

<g class="labels x-labels" id='chart_x_axis_labels'></g>
<g class="labels z-labels" id='chart_z_axis_labels'></g>
<g class="labels y-labels" id='chart_y_axis_labels'></g>

<g class="query-line">
	<line id="chart_query_line" x1=100 x2=100 y1=15 y2=555></line>
</g>
<polyline
	id='chart_q_line'
	fill='none'
	stroke='#0074d9'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_m_line'
	fill='none'
	stroke='#d91200'
	stroke-width=2
	points="
	"/>

<rect id="chart_query_area" x=0 y=0 width=700 height=460 opacity=0 fill="#fff">
</svg>

<div class="output-graph">

		<table>
			<tr>
				<th class="rowlabel">Queried Position<span class="ttt">Query a position on the graph by clicking (and optionally dragging) a point.</span></th>
				<td><input id="query_l" onkeyup="focus_handler(gidv('query_l'), true);" /></td>
				<td class="unit" id="unit_query_l"></td>
			</tr><tr>
				<th class="rowlabel">Deflection</th>
				<td><input id="query_q" readonly /></td>
				<td class="unit" id="unit_query_q"></td>
			</tr><tr>
				<th class="rowlabel">Slope</th>
				<td><input id="query_sl" readonly /></td>
				<td class="unit" id="unit_query_sl"></td>
			</tr><tr>
				<th class="rowlabel">Bending Moment</th>
				<td><input id="query_m" readonly /></td>
				<td class="unit" id="unit_query_m"></td>
			</tr><tr>
				<th class="rowlabel">Shear Force<span class="ttt">Note: Shear force at a load/constraint is not properly defined. Query before and after.</span></th>
				<td><input id="query_sh" readonly /></td>
				<td class="unit" id="unit_query_sh"></td>
			</tr><tr>
				<th class="rowlabel">Bending Stress @ Top<span class="ttt">Positive is tension</span></th>
				<td><input id="query_stress_bend_top" readonly /></td>
				<td class="unit" id="unit_query_stress_bend_top"></td>
			</tr><tr>
				<th class="rowlabel">Bending Stress @ Bottom<span class="ttt">Positive is tension</span></th>
				<td><input id="query_stress_bend_bot" readonly /></td>
				<td class="unit" id="unit_query_stress_bend_bot"></td>
			</tr><tr>
				<th class="rowlabel">Shear Stress @ Center</th>
				<td><input id="query_stress_shear" readonly /></td>
				<td class="unit" id="unit_query_stress_shear"></td>
			</tr>
		</div>

</div>
</body>
</html>
