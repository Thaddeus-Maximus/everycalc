<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css"> 
<script type="text/javascript" src="include/specs.js"></script>
<script type="text/javascript" src="include/math.js"></script>
<script type="text/javascript">
	unit_sys = 0;
	inputs_unit_map = {
		'f_push': ['N', 'lbf'],
		'f_pull': ['N', 'lbf'],
		'v_endstop': ['mm/s', 'in/s'],
		'E_endstop': ['J', 'ft-lbf'],
		'air_cons': ['g', 'lbm'],

		'mass': ['kg', 'lbm'],
		'load': ['N', 'lbf'],
		'stroke': ['mm', 'in'],
		'd_rod': ['mm', 'in'],
		'd_bore': ['mm', 'in'],
		'l_line': ['m', 'ft'],
		'd_line': ['mm', 'in'],
		'T_src': ['C', 'C'],
		'P_src': ['kPa', 'psi'],

		'query_d': ['mm', 'in'],
		'query_v': ['mm/s', 'in/s'],
		'query_p': ['kPa', 'psi'],
		'query_f': ['N', 'lbf']
	}

	function populate_units() {
		if(document.getElementById('unit_metric').checked)
			unit_sys = 0;
		else 
			unit_sys = 1;

		unit_labels = document.getElementsByClassName('unit');
		//console.log(unit_labels);
		for (unit in unit_labels) {
			if (unit_labels[unit].id && inputs_unit_map[unit_labels[unit].id.substring(5)] ){
				varname = unit_labels[unit].id.substring(5);
				document.getElementById('unit_'+varname).innerHTML = '['+inputs_unit_map[varname][unit_sys]+']';
			}
		}
	}

	function switch_units() {
		populate_units();
		compute();
	}

	var poschart = null, poschart_options = null;

	function gidv(id) {

		v =  eval(document.getElementById(id).value);
		if (typeof inputs_unit_map[id] !== 'undefined')
			v = convert(v, inputs_unit_map[id][unit_sys]);
		return v;
	}

	function gids(id, value, places) {
		if (typeof places === 'undefined')
			places = 3;
		if (typeof value === 'string') {
			document.getElementById(id).value = value;
		} else {
			if (typeof inputs_unit_map[id] !== 'undefined')
				value = convert_to(value, inputs_unit_map[id][unit_sys]);
			document.getElementById(id).value = value.toFixed(places);
		}
	}

	function thload() {
		populate_units();		

		var inputs, index;

		inputs = document.getElementsByTagName('input');
		for (index = 0; index < inputs.length; ++index) {
		    inputs[index].onkeyup = function(e) {
		    	var key = e.keyCode ? e.keyCode : e.which;

		    	if (key==13) {
		    		compute(true);
		    	} else {
		    		compute(false);
		    	}
		    }
		}

		compute();
	}

		
	function sign(x) {
		if (x>0) return 1;
		if (x<0) return -1;
		return 0;
	}


	function NaNtoerr(x) {
		if (isNaN(x)) return '-'; return x;
	}


	function NaNto1(x) {
		if (isNaN(x))
			return 1;
		return x;
	}

	function collapse(id) {
		el = document.getElementById('detail_'+id);
		btn = document.getElementById('toggle_detail_'+id);
		if(el.style['display'] != 'none') {
			el.style['display'] = 'none';
			btn.innerHTML = "&#9660";
		} else {
			el.style['display'] = 'inherit';
			btn.innerHTML = "&#9650";
		}
	}
</script>

<script type="text/javascript">
	//la = linearAlgebra();
	function make_stiffness_matrix(EI, L) {
		var m = math.matrix([ [12,  6*L,   -12,  6*L   ],
							  [6*L, 4*L*L, -6*L, 2*L*L ],
							  [-12, -6*L,  12,   -6*L  ],
							  [6*L, 2*L*L, -6*L, 4*L*L ] ]);
		return math.multiply(m, EI/L/L/L);
	}

	function drawtbl(K) {
		tbl = document.getElementById('k_table');
		tbl.innerHTML = '';
		for (i=0;i<K._data.length;i++) {
			tr = tbl.insertRow();
			for (j=0;j<K._data[i].length;j++) {
				td = tr.insertCell(tr.cells.length);
				td.innerHTML = K._data[i][j];
			}
		}
	}

	function run_fe(EI, nodes, forces, moments, pinned, fixed) {
		numel = nodes.length-1;

		numnode = (numel+1)*2;
		
		var K = math.matrix(math.zeros([numnode,numnode]));
		F = math.matrix(math.zeros([numnode,1]));
		dofs_to_remove = [];
		for (i in forces){
			F.subset(math.index(parseInt(i)*2,0), forces[i]);
		}
		for (i in moments){
			F.subset(math.index(parseInt(i)*2+1,0), forces[i]);
		}
		for (i of pinned){
			dofs_to_remove.push(i*2);
		}
		for (i of fixed){
			dofs_to_remove.push(i*2);
			dofs_to_remove.push(i*2+1);
		}

		for (i=0;i<numel;i++) {
			idx = math.index(math.range(i*2, i*2+4), math.range(i*2, i*2+4));
			ss = K.subset(idx);
			Ks = make_stiffness_matrix(EI, nodes[i+1]-nodes[i]);
			K.subset(idx,
				math.add(ss, Ks));
		}

		idx_rmv_l = [];
		for (i=0;i<numnode;i++) {
			if (! dofs_to_remove.includes(i)) idx_rmv_l.push(i);
		}
		idx_rmv = math.index(idx_rmv_l, idx_rmv_l);
		K = K.subset(idx_rmv);
		F = F.subset(math.index(idx_rmv_l, 0));
		q = math.multiply(math.inv(K), F);
		fq = [];
		offs = 0;
		for (i=0;i<numnode;i++) {
			if (dofs_to_remove.includes(i)){fq.push(0); offs++}
			else fq.push(q._data[i-offs][0]);
		}
		console.log(fq);
		return fq;
	}

	function compute() {
		nodes  = [0, 0.1, 0.2, 0.5, 0.6];
		forces = {2: 100};
		moments = {};
		pinned = [1,3];
		fixed  = [];
		EI = 4e9*0.00007;

		run_fe(EI, nodes, forces, moments, pinned, fixed);
	}
</script>

<html>
<body onload="thload()">
	<div style="width: 360px; float: left;" class="container">
		<h3>Thad's Beam Calculator</h3>
		<center><a href="./">Back To Index</a></center>

		<div class="even">
		<center>
			  <input type="radio" id="unit_english" name="unit" value="english" onclick="switch_units()">
			  <label for="english">English</label><br>
			  <input type="radio" id="unit_metric" name="unit" value="metric" onclick="switch_units()" checked>
			  <label for="metric">Metric</label><br>
		</center>
		</div>

		<div class="odd">
			<span class="rowlabel">Cross-Section</span>
			<select id="section" onchange="shape_select(); compute();">
				<option vlaue="rndbar" selected='selected'>Round Bar</option>
				<option value="boxbar">Rect. Bar</option>
				<option value="boxtube">Box Tube</option>
				<option value="rndtube">Round Tube</option>
				<option value="angle">Angle</option>
				<option value="hex">Hexagon</option>
			</select>

			<button type="button" onclick="collapse('section')" id='toggle_detail_section'>&#9660;</button>
			<table id="detail_section" style='display:none;'>
				<tr id='section_1_row'>
					<th class='rowlabel' id='section_1_label'>Diameter</th>
					<td><input id='section_1' /></td>
					<td class='unit' id='unit_section_1'></td>
				</tr>
			</table>
	</div>


<div style="margin-left: 0px;" class="container" id="charts">
<table id="k_table"></table>

</div>
</body>
</html>