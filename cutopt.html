<!DOCTYPE html>

<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">

<link rel="stylesheet" href="include/style.css"> 
<script type="text/javascript" src="js/eclib.js"></script>
<script type="text/javascript" src="js/units.js"></script>
<script type="text/javascript" src="js/export.js"></script>
<script type="text/javascript" src="js/walkthrough.js"></script>

<script type="text/javascript">
	EXP_FN_BASE = 'fit_tol';
	UNIT_MAP = {
		'dimension': ['-', '-'] // ezpz
	};
</script>

<script type="text/javascript">

	function generateCutOrders(quantities, part_manifest, recieved_order, kerf_width) {
		const orders = [];
		
		let unique_set = new Set()

		for (const id_a in quantities) {
			new_quantities = {}
			for (const id_b in quantities) {
				n = id_a == id_b ? quantities[id_b]-1 : quantities[id_b];
				if (n > 0)
					new_quantities[id_b] = n
			}
			need_to_place_part = true;

			send_order = []
			for (line of recieved_order) {
				piece_lg = part_manifest[id_a].length
				if (need_to_place_part && line.remainder >= piece_lg+kerf_width) {
					send_order.push({
						stock_length: line.stock_length,
						pieces: line.pieces.concat(piece_lg),
						saw_waste: line.saw_waste + kerf_width,
						remainder: line.remainder - piece_lg - kerf_width
					})
					need_to_place_part = false;
				} else {
					// can I just push line? idk.
					send_order.push(line)
				}
			}

			if (need_to_place_part) {
				// hm. well, we couldn't place this part. fail!
				continue;
			}

			// spawn the next things
			if (Object.keys(new_quantities).length === 0) {
				// this is the last item in the line
				orders.push(send_order)
			} else {
				//console.log(tmpresults)
				for (const spawned_order of generateCutOrders(new_quantities, part_manifest, send_order, kerf_width)){
					// collect the order
					// at this point, only accept unique cut orders.
					// this doesn't actually prevent us from going down rabbit holes that are useless, it's merely filtering
					// it at leasts prevents us from storing as much data as possible upfront
					const summary = JSON.stringify(spawned_order.map((a) => JSON.stringify(a.pieces.sort((a,b)=>b-a).concat(a.stock_length))).sort())
					if (! unique_set.has(summary)) {
						unique_set.add(summary)
						// only add orders with a unique summary
						orders.push(spawned_order)
					}
				}
			}
		}
		return orders
	}

	function generateCutOptions(parts, stock, kerf_width) {
		console.log("generateCutOptions", parts, stock, kerf_width)

		parts.sort((a,b) => b.length - a.length)
		
		let profiles = new Set();
		profiles_unaccounted = new Set();
		let part_quantities = {}
		let stock_lgs = {}
		let orders_by_profile = {}

		let piece_manifest = {}
		
		for (part of parts){
			piece_manifest[part.id] = {qty: part.qty, profile: part.profile, length: part.length}
			profiles.add(part.profile)
			profiles_unaccounted.add(part.profile)
			
			if (typeof part_quantities[part.profile] === 'undefined')
				part_quantities[part.profile] = {}
			
			part_quantities[part.profile][part.id] = part.qty
		}

		let order_template = {}
		
		let j = 0;
		for (part of stock){
			profiles_unaccounted.delete(part.profile);
			stock_lgs[part.profile] = part.length;


			if (typeof order_template[part.profile] === 'undefined')
				order_template[part.profile] = []

			for (let i=0; i<part.qty; i++)
				order_template[part.profile].push({stock_length: part.length, pieces: [], saw_waste: 0, remainder: part.length, stock_id: j})
			j+=1;
		}

		if (profiles_unaccounted.size != 0) {
			console.log(profiles_unaccounted)
			throw "don't have stock defined for profiles: " + Array.from(profiles_unaccounted).join(', ');
		}

		orders = {}

		for (profile of profiles.values()) {
			orders[profile] = generateCutOrders(part_quantities[profile], piece_manifest, order_template[profile], kerf_width)
		}

		return orders;
	}

	/*function representNumber(num) {
		if (num % 1 < .001)
			return num.toFixed(0);
		return num.toFixed(2);

	}

	function representOrder(order) {
		reprs = [];
		for (line of order) {
			repr = representNumber(line.stock_length) + " = ";
			for (piece of line.pieces) {
				repr += representNumber(piece) + " + ";
			}
			repr += "(--" + representNumber(line.saw_waste) + ") + (" + representNumber(line.remainder) + ")";
			reprs.push(repr);
		}
		return reprs.join('\n');
	}*/

	var current_cut_options = [];

	function onInput(event) {
		setError(1);

		let last_populated = 0;
		let i = 0;
		for (row of tbody_stock_input.children) {
			for (cell of row.children) {
				console.log(cell.innerHTML)
				if (! /^(\s|&nbsp;|<br>)*$/.test(cell.innerHTML)) {
					console.log("this is true")
					last_populated = i;
				}
			}
			i ++;
		}

		console.log(last_populated);
	}

	function compute() {
		// hook for when computation is requested
		let new_tbody = document.createElement("tbody");
		let old_tbody = document.getElementById("tbody_cut_output");
		old_tbody.parentNode.replaceChild(new_tbody, old_tbody);
		new_tbody.id = 'tbody_cut_output';


		tbody_piece_input = document.getElementById("tbody_piece_input");
		tbody_stock_input = document.getElementById("tbody_stock_input");

		pieces = []
		stock  = []

		row_i = 0;
		for (row of tbody_piece_input.children) {
			profile = getV(row.children[1]);
			length  = getV(row.children[2]);
			qty     = getV(row.children[3]);

			if (length && qty) {
				pieces.push({
					id:      row_i,
					profile: profile,
					length:  length,
					qty:     qty
				});
			}
			row_i++;
		}

		for (row of tbody_stock_input.children) {
			profile = getV(row.children[1]);
			length  = getV(row.children[2]);
			qty     = getV(row.children[3]);

			if (length && qty) {
				stock.push({
					profile: profile,
					length:  length,
					qty:     qty
				});
			}
		}

		current_cut_options = generateCutOptions(pieces, stock, .125)

		console.log(current_cut_options)

		// sort the options
		// todo: this should probably get rolled together, too many nested functions
		for (profile in current_cut_options) {
			for (order of current_cut_options[profile]) {
				order.sort((a,b) => a.remainder-b.remainder)
				order['remainder'] = 0;
				for (let i = order.length-1; i>=0; i--) {
					const line = order[i];
					if (line.remainder == line.stock_length) {
						order.remainder += 1;
					}
					else{
						// only get the first one
						order.remainder += line.remainder/line.stock_length;
						break;
					}
				}
			}
			current_cut_options[profile].sort((a,b) => b.remainder-a.remainder);

			let select    = document.getElementById("cut_option_select");
			let old_val   = select.value;
			select.innerHTML = '';
			for (base in current_cut_options[profile]) {
				let opt = document.createElement('option');
				opt.innerHTML = base;
				opt.value = base;
				if (old_val == base) opt.selected = true;
				select.appendChild(opt);
			}
		}

		changeCutOption();

		setError(0);	
	}

	function changeCutOption() {
		let new_tbody = document.createElement("tbody");
		let old_tbody = document.getElementById("tbody_cut_output");
		old_tbody.parentNode.replaceChild(new_tbody, old_tbody);
		new_tbody.id = 'tbody_cut_output';

		let option_no = document.getElementById("cut_option_select").value;
		let cut_option = current_cut_options[undefined][option_no];



		const fractional   = UNIT_sys[0]=='f' ? true : false;
		const places       = parseInt(UNIT_sys.substring(1))
		const show_sign    = false;
		const leading_zero = true;

		console.log(cut_option)

		for (cut of cut_option) {
			let row = document.createElement("tr");

			let cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);
			setV(cell, cut.stock_length, places, show_sign, leading_zero, fractional);

			cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);
			setV(cell, "=");

			cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);

			for (piece of cut.pieces) {
				let span = document.createElement("span");
				span.classList.add("span-readout");
				cell.appendChild(span);
				setV(span, piece, places, show_sign, leading_zero, fractional);

				span = document.createElement("span");
				span.classList.add("span-readout");
				span.innerText = " + ";
				cell.appendChild(span);
			}
			cell.removeChild(cell.lastChild);

			cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);
			setV(cell, "--");

			cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);
			setV(cell, cut.saw_waste, places, show_sign, leading_zero, fractional);

			cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);
			setV(cell, "--");

			cell = document.createElement("td");
			cell.classList.add("td-readout");
			row.appendChild(cell);
			setV(cell, cut.remainder, places, show_sign, leading_zero, fractional);

			/*row.innerHTML = `
				<td class='td-readout'><span class="span-readout" id="$"></span></td>
				<td>=</td>
				<td class='td-readout' style='width: 250px'>${cuts}</td>
				<td>--</td>
				<td class='td-readout'>${kerfloss}</td>
				<td>--</td>
				<td class='td-readout'>${remainder}</td>
			`;*/

			new_tbody.appendChild(row);
		}
	}

	function init() {
		// hook for initialization
		EC_onload();

		//EXP_onload();

		for (inp of document.getElementsByTagName('TD')) {
			if (inp.contentEditable == 'true') {
				inp.addEventListener('keydown', (evt) => {
				    if (evt.keyCode === 13) {
				        evt.preventDefault();
				        // TODO: enter; go down
				    }
				    // TODO: other arrow keys
					
					// always
				});
				inp.addEventListener('keyup', onInput);

			}
		}

		document.getElementById('idContentEditable')
		UNIT_change();
		//
		compute();
	}
</script>

<html>
<!-- Make sure to call your init function on document load -->
<!-- You can copy the topbar template here -->
<body onload="init()">
	<div id="topbar">
		<div class="topbar-la selectable" onclick="window.location='./'">EveryCalc</div>
		<div class="topbar-la" id='topbar_version'></div>
		<div class="topbar-la" id='topbar_filename'></div>
		<div class="topbar-la" id='topbar_unit'>
			<!-- Required for unit library. You could also put this in the calculator main body -->
			<select id="unit_select" onchange="UNIT_change(); compute();">
				<option value='d0'>Wholes</option>
				<option value='d2'>2-places</option>
				<option value='d3' selected="selected">3-places</option>
				<option value='d4'>4-places</option>
				<option value='f8' >8ths</option>
				<option value='f16' >16ths</option>
				<option value='f32' >32nds</option>
				<option value='f64' >64ths</option>
			</select>
		</div>
		<div class="topbar-ctr" id="topbar_title" onclick="compute();">Fit Clearance/Interference Calculator</div>
		<div class="topbar-ra selectable" onclick="compute();" id="topbar_status"><span></span><span class='ttt'></span></div>
		<div class="topbar-ra selectable" onclick="downloadPage();" id="download">Export HTML</div>
		<div class="topbar-ra selectable" onclick="printPage();">Print</div>
		<div class="topbar-ra selectable" onclick="WALK_enable();">Tutorial</div>
		<a id="download_frame" hidden></a>
	</div>	

	<svg id="walkthrough_overlay" onclick="WALK_nextStep()" >
		<path id="walkthrough_frame" ></path>
		<text id="walkthrough_text" ></text>
		<text id="walkthrough_skip_button" onclick="WALK_disable();">Skip Tutorial</text>
	</svg>

<!-- From here go nuts, do whatever works for you. Use the container to keep stuff from spilling under topbar. I'll point out patterns to pay attention to. -->
	<div style="float: left;" class="container odd">
		<table id="table_piece_input" style="word-wrap: unset; white-space: nowrap;">
			<tr>
				<th class="rowlabel bold" colspan="4" style="text-align: center;">Pieces</th>
			</tr>
			<tr>
				<td>Name</td>
				<td>Profile</td>
				<td>Length<!--<span class="unit" data-unit="dimension"></span>--></td>
				<td>Quantity</td>
			</tr>
			<tbody id="tbody_piece_input">
			<tr id='piece_0_row'>
				<td contenteditable="true" class="table-cell-input" id="piece_name_0">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_profile_0">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_length_0">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_qty_0">&nbsp;</td>
			</tr>
			<tr id='piece_1_row'>
				<td contenteditable="true" class="table-cell-input" id="piece_name_1">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_profile_1">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_length_1">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_qty_1">&nbsp;</td>
			</tr>
			<tr id='piece_2_row'>
				<td contenteditable="true" class="table-cell-input" id="piece_name_2">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_profile_2">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_length_2">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="piece_qty_2">&nbsp;</td>
			</tr>
		</tbody>
		</table>
	</div>
	
	<div style="float: left;" class="container even">
		<table id="table_stock_input" style="word-wrap: unset; white-space: nowrap;">
			<tr>
				<th class="rowlabel bold" colspan="4" style="text-align: center;">Stock</th>
			</tr>
			<tr>
				<td>Name</td>
				<td>Profile</td>
				<td>Length<!--<span class="unit" data-unit="dimension"></span>--></td>
				<td>Quantity</td>
			</tr>
			<tbody id="tbody_stock_input">
			<tr id='stock_3_row'>
				<td contenteditable="true" class="table-cell-input" id="stock_name_0">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_profile_0">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_length_0">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_qty_0">&nbsp;</td>
			</tr>
			<tr id='stock_1_row'>
				<td contenteditable="true" class="table-cell-input" id="stock_name_1">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_profile_1">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_length_1">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_qty_1">&nbsp;</td>
			</tr>
			<tr id='stock_2_row'>
				<td contenteditable="true" class="table-cell-input" id="stock_name_2">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_profile_2">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_length_2">&nbsp;</td>
				<td contenteditable="true" class="table-cell-input" id="stock_qty_2">&nbsp;</td>
			</tr>
		</tbody>
		</table>
	</div>
	
	<div style="float: left;" class="container output">
		<table id="table_cut_output" style="word-wrap: unset; white-space: nowrap;">
			<tr>
				<th class="rowlabel bold" colspan="7" style="text-align: left;">Cut Option 
					<select id="cut_option_select" onchange="changeCutOption();">
					</select>
				</th>
			</tr>
			<tr>
				<td colspan>Stock Lg.</td>
				<td>=</td>
				<td colspan>Cuts</td>
				<td>--</td>
				<td colspan>Kerf Loss</td>
				<td>--</td>
				<td colspan>Spare</td>
			</tr>
			<tbody id="tbody_cut_output">
				<tr id='cut_1_row' class="cut_row">
					<td id="cut_overall_1"></td>
					<td>=</td>
					<td id="cut_pieces_1"></td>
					<td>--</td>
					<td id="cut_kerfloss_1"></td>
					<td>--</td>
					<td id="cut_remainder_1"></td>
				</tr>
			</tbody>
		</table>		
	</div>
</body>
</html>