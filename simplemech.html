<!DOCTYPE html>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet" href="style.css"> 
<script type="text/javascript" src="specs.js"></script>
<script type="text/javascript">
	unit_sys = 0;
	inputs_unit_map = {
		"motor_stall_torque": ["N-m", "N-m"],
		"motor_stall_torque_adj": ["N-m", "N-m"],
		"encoder_cpx": ["c/m", "c/ft"],
		"radius": ["mm","in"],
		"load": ["N", "lbf"],
		"mass": ["kg", "lbm"],
		"theor_freespd": ["m/s", "ft/s"],
		"theor_runspd": ["m/s", "ft/s"],
		"theor_stall_force": ["N", "lbf"],

		"mass_ref": ["kg", "lbm"],
		"moi_ref": ["kg m^2", "lbm in^2"],
		"radius_ref": ["m"," in"],
		"velocity_ref": ["m/s", "ft/s"],
		"position_ref": ["m", "ft"]
	}

	function populate_units() {
		if(document.getElementById('unit_metric').checked)
			unit_sys = 0;
		else 
			unit_sys = 1;
		
		unit_labels = document.getElementsByClassName('unit');
		//console.log(unit_labels);
		for (unit in unit_labels) {
			if (unit_labels[unit].id && inputs_unit_map[unit_labels[unit].id.substring(5)] ){
				varname = unit_labels[unit].id.substring(5);
				document.getElementById('unit_'+varname).innerHTML = '['+inputs_unit_map[varname][unit_sys]+']';
			}
		}
	}

	function switch_units() {

		populate_units();
		compute();
	}

	var vchart = null, vchart_options = null;
	var xchart = null, xchart_options = null;

	google.charts.load('current', {'packages':['corechart', 'scatter', 'line']});
    google.charts.setOnLoadCallback(drawStuff);


    function drawStuff() {
      vchart = new google.visualization.LineChart(document.getElementById('vchart_div'));
      var vchartDiv = document.getElementById('vchart_div');

      vchart_options = {
          backgroundColor: { fill:'transparent' },
          curveType: 'function',
          legend: {position: 'top'},
          vAxes: {
          	0: {title: 'Linear Velocity (m/s)'},
          	1: {title: 'Linear Position (m)'}
          },
          series: {
          	0: {targetAxisIndex: 0},
          	1: {targetAxisIndex: 1}
          },
          vAxis: {
	          viewWindow: {
	            min: 0
	          }
	        }

      };

      var vdata = new google.visualization.DataTable();
      vdata.addColumn('number', 'Time (s)');
      vdata.addColumn('number', 'Linear Velocity (m/s)');
      vdata.addColumn('number', 'Linear Position (m)');
      vdata.addRows([]);

      vchart.draw(vdata, vchart_options);

      xchart = new google.visualization.LineChart(document.getElementById('xchart_div'));
      var xchartDiv = document.getElementById('xchart_div');

      xchart_options = {
          backgroundColor: { fill:'transparent' },
          curveType: 'function',
          legend: {position: 'top'},
          vAxes: {
          	0: {title: 'Angular Velocity (RPM)'},
          	1: {title: 'Rotational Position (Rev)'}
          },
          series: {
          	0: {targetAxisIndex: 0},
          	1: {targetAxisIndex: 1}
          },
          vAxis: {
	          viewWindow: {
	            min: 0
	          }
	        }

      };

      var xdata = new google.visualization.DataTable();
      xdata.addColumn('number', 'Time (s)');
      xdata.addColumn('number', 'Angular Velocity (RPM)');
      xdata.addColumn('number', 'Rotational Position (Rev)');
      xdata.addRows([]);

      xchart.draw(xdata, xchart_options);
    };

	function get_motor_data(motor,key){
		return motor_data[motor][key];
	}

	function gidv(id) {

		v =  eval(document.getElementById(id).value);
		if (typeof inputs_unit_map[id] !== 'undefined')
			v = convert(v, inputs_unit_map[id][unit_sys]);
		return v;
	}

	function gids(id, value, places) {
		if (typeof places === 'undefined')
			places = 3;
		if (typeof value === 'string') {
			document.getElementById(id).value = value;
		} else {
			if (typeof inputs_unit_map[id] !== 'undefined')
				value = convert_to(value, inputs_unit_map[id][unit_sys]);
			document.getElementById(id).value = value.toFixed(places);
		}
	}

	function thload() {
		var inputs, index;

		populate_units();

		inputs = document.getElementsByTagName('input');
		for (index = 0; index < inputs.length; ++index) {
		    inputs[index].onkeyup = function(e) {
		    	var key = e.keyCode ? e.keyCode : e.which;

		    	if (key==13) {
		    		compute(true);
		    	} else {
		    		compute(false);
		    	}
		    }
		}

		select = document.getElementById("motortype");
		i=0;
		for(motor in motor_data) {
			i++;
			opt = document.createElement('option');
			opt.innerHTML = motor_data[motor]["plain_name"];
			opt.value = motor;
			select.appendChild(opt);
		}

		drawStuff();
		calc_ratio();
		motortype_select(document.getElementById("motortype"));
		
	}

	function compute(simulate) {
		simulate = typeof simulate !== 'undefined' ? simulate : true;
		document.getElementById('charts').classList.add('uncomputed');
		document.getElementById('endcond_met').classList.add('uncomputed');
		document.getElementById('current_cons').classList.add('uncomputed');
		document.getElementById('current_end').classList.add('uncomputed');

		var dt = 0;
		// overall, solve: alpha = (T-Mres)/I
		// make x, v, theta, omega available
		var r = gidv("radius");
		var m = gidv("mass");
		var Ts = gidv("motor_stall_torque_adj");
		var wf = gidv("motor_max_rpm_adj") * 2*Math.PI/60; // convert to rad/s!
		var If = gidv("motor_free_current_adj");
		var Is = gidv("motor_stall_current_adj");
		var G = gidv("G");

		//console.log(r,m,Ts,wf,If,Is,G);

		load_expr = document.getElementById("load").value;
		end_expr = document.getElementById("endcond").value;

		if(end_expr == "") end_expr = "0";

		I = m*r*r;

		alpha_ar = [0,0];
		omega_ar = [0,0];
		theta_ar = [0];
		t_ar = [0];

		omega=0; theta=0; theta_m=0; omega_m=0; v=0; x=0; t=0;
		T = G*Ts*(wf-omega_ar[omega_ar.length-1]*G)/wf;
		Mres = eval(load_expr)*r;
		if(isNaN(Mres)) Mres = 0;
		// T = Mres -> G*Ts - G*Ts*omega_m/wf = Mres -> omega_m = (G*Ts - Mres)/(G*Ts/wf)
		omega_m_theor = (G*Ts - Mres)/(G*Ts/wf);
		gids("theor_freespd", r*wf/G)
		gids("theor_runspd", r*omega_m_theor/G);
		gids("theor_stall_force", G*Ts/r);
		gids("theor_stall_current", If + (Is-If) * (wf-omega_m_theor)/wf);

		enc_plc = document.getElementById('encoder_placement').value;
		//console.log(enc_plc);
		enc_els = document.getElementsByClassName('encoder_detail');
		if (enc_plc == 'none') {
			for (i=0;i<enc_els.length;i++) {
				enc_els[i].style.display = 'none';
			}
		} else {
			for (i=0;i<enc_els.length;i++) {
				enc_els[i].style.display = 'table-row';
			}

			cpx = gidv('encoder_cpr')/NaNto1(gidv('encoder_reduction'))/(r*2*Math.PI);
			if(enc_plc == 'motor') cpx *= G;

			console.log(cpx);
			gids('encoder_cpx', cpx);
			gids('encoder_max_cps', cpx*r*wf/G);
		}

		if (!simulate) return; // YARRR, NO MORE PLAIN CALCS BEYOND THIS POINT

		cur_cons = 0;

		alpha_o = NaN;

		var vdata = new google.visualization.DataTable();
		vdata.addColumn('number', 'Time (s)');
      	vdata.addColumn('number', 'Linear Velocity (m/s)');
      	vdata.addColumn('number', 'Linear Position (m)');
      	vdata.addRows([[0,0,0]]);

      	var xdata = new google.visualization.DataTable();
		xdata.addColumn('number', 'Time (s)');
      	xdata.addColumn('number', 'Angular Velocity (RPM)');
      	xdata.addColumn('number', 'Rotational Position (rev)');
      	xdata.addRows([[0,0,0]]);
      	i=0;
		while(1) {
			//console.log(dt);
			omega = omega_ar[omega_ar.length-1] * 60/2/Math.PI;
			theta = theta_ar[theta_ar.length-1] * 2/Math.PI;
			t = t_ar[t_ar.length-1];
			x = theta_ar[theta_ar.length-1]*r;
			v = omega_ar[omega_ar.length-1]*r;
			omega_m = omega*G;
			theta_m = theta*G;

			T = G*Ts*(wf-omega_ar[omega_ar.length-1]*G)/wf;
			Mres = convert(eval(load_expr), inputs_unit_map["load"][unit_sys])*r;
			if(isNaN(Mres)) Mres = 0;
			alpha = (T-Mres) / I;
			//console.log(T, Mres, alpha);
			if(isNaN(alpha_o)) alpha_o = alpha;

			alpha_ar.push(alpha);

			// Use Adams-Bradforth Method
			theta_ar.push(theta_ar[theta_ar.length-1] + omega_ar[omega_ar.length-1]*dt*3/2 - omega_ar[omega_ar.length-2]*dt*1/2);
			omega_ar.push(omega_ar[omega_ar.length-1] + alpha_ar[alpha_ar.length-1]*dt*3/2 - alpha_ar[alpha_ar.length-2]*dt*1/2);
			t_ar.push(t_ar[t_ar.length-1]+dt);
			

			cur_cons = cur_cons + dt*(If + (Is-If)*(wf-omega_ar[omega_ar.length-1]*G)/wf);

			vdata.addRows([[t_ar[t_ar.length-1], omega_ar[omega_ar.length-1]*r, 			r*theta_ar[theta_ar.length-1]]]);
			xdata.addRows([[t_ar[t_ar.length-1], 60/2/Math.PI*omega_ar[omega_ar.length-1], 	2/Math.PI*theta_ar[theta_ar.length-1]]])

			if (i > 1000 || eval(end_expr)) break;

			dt = Math.min(0.1,Math.max(1e-7,Math.min(Math.abs(wf/G/alpha_o),Math.abs(wf/G/alpha))/30));
			i++;
		}

		omega_ar.shift(); //remove the first element of this array that was there for adams-bradforth purposes

		//console.log(vdata, xdata);

		vchart.draw(vdata, vchart_options);
      	xchart.draw(xdata, xchart_options);
      	document.getElementById('charts').classList.remove('uncomputed');
      	document.getElementById('endcond_met').classList.remove('uncomputed');
		document.getElementById('current_cons').classList.remove('uncomputed');
		document.getElementById('current_end').classList.remove('uncomputed');

      	gids("endcond_met", eval(end_expr) ? t_ar[t_ar.length-1]:"NOT MET");
      	gids("current_cons", cur_cons);
      	gids("current_end", (If + (Is-If)*(wf-G*omega_ar[omega_ar.length-1])/wf));
	}

	function motortype_select() {
		e=document.getElementById("motortype");
		var props = ["max_rpm", "stall_torque", "free_current", "stall_current"];
		props.forEach(function(a) {
			
			document.getElementById("motor_"+a).value=get_motor_data(e.value, a);
			adjVal = get_motor_data(e.value, a)*gidv("op_voltage")/12;
			if (a=="stall_torque")
				adjVal *= gidv("motornum")*gidv("efficiency")/100;
			if (a=="free_current" || a=="stall_current" )
				adjVal *= gidv("motornum");
			gids("motor_"+a+"_adj",adjVal);
		});

		compute();
	}

	function NaNto1(x) {
		if (isNaN(x))
			return 1;
		return x;
	}

	function calc_ratio() {
		var G = 1;
		G *= NaNto1(gidv("G1B"));
		G *= NaNto1(gidv("G2B"));
		G *= NaNto1(gidv("G3B"));
		G *= NaNto1(gidv("G4B"));
		G /= NaNto1(gidv("G1A"));
		G /= NaNto1(gidv("G2A"));
		G /= NaNto1(gidv("G3A"));
		G /= NaNto1(gidv("G4A"));

		gids("G", G);
	}

</script>

<html>
<body onload="thload()">
	<div style="width: 420px; float: left;" class="container">
	<h3>Thad's Mechanism Calculator</h3>
	<center><a href="./">Back To Index</a></center>

	<div class="even">
		<center>
			  <input type="radio" id="unit_english" name="unit" value="english" onclick="switch_units()">
			  <label for="english">English</label><br>
			  <input type="radio" id="unit_metric" name="unit" value="metric" onclick="switch_units()" checked>
			  <label for="metric">Metric</label><br>
		</center>
	</div>

	<div class="odd">
		<table>
		<tr>
			<th class="rowlabel">Number of Motors<span class="ttt">How many motors do you have in total for this mechanism (assuming they're identical, and geared together)</span></th>
			<td><input id="motornum" oninput="motortype_select()" value=1 /></td>
		</tr><tr>
			<th class="rowlabel">Voltage<span class="ttt">What voltage are the motors ran at? (assuming that the nominal motor performance is at 12V)</span></th>
			<td><input id="op_voltage" oninput="motortype_select()" value=12 /></td>
			<td class="unit">[V]</td>
		</tr><tr>
			<th class="rowlabel">Efficiency<span class="ttt">Efficiency of the transmission</span></th>
			<td><input id="efficiency" oninput="motortype_select()" value=85 /></td>
			<td class="unit">[%]</td>
		</tr>
	</table>
</div>

	

	<div class="even">
		<table>
		<tr>
			<th>Motor</th>
			<td colspan="2"><select class="doublewide" id="motortype" oninput="motortype_select()">
			  
			  <!--<option value="neo">REV NEO</option>
			  <option value="neo550">REV NEO550</option>
			  <option value="falcon500">VEX Falcon 500</option>
			  <option value="cim">CIM</option>
			  <option value="minicim">MiniCIM</option>
			  <option value="bag">Vex BAG</option>
			  <option value="775pro">775Pro / Redline</option>
			  <option value="am9015">AndyMark 9015</option>
			  <option value="neverest">AndyMark NeveRest</option>
			  <option value="rs550">BaneBots RS-550</option>-->
			</select></td>
		</tr>
		<tr>
			<th></th>
			<th class="collabel">Raw Motor</th>
			<th class="collabel">Adjusted</th>
			<th></th>
		</tr>
		<tr>
			<th class="rowlabel">Free Speed<span class="ttt">The maximum RPM of the motor</span></th>
			<td><input id="motor_max_rpm" readonly /></td>
			<td><input id="motor_max_rpm_adj" readonly /></td>
			<td class="unit">[RPM]</td>
		</tr><tr>
			<th class="rowlabel">Stall Torque<span class="ttt">The maximum torque of the motor, occurring at 0 RPM</span></th>
			<td><input id="motor_stall_torque" readonly /></td>
			<td><input id="motor_stall_torque_adj" readonly /></td>
			<td class="unit" id="unit_motor_stall_torque"></td>
		</tr><tr>
			<th class="rowlabel">Free Current<span class="ttt">The current drawn when the motor is unloaded</span></th>
			<td><input id="motor_free_current" readonly /></td>
			<td><input id="motor_free_current_adj" readonly /></td>
			<td class="unit">[A]</td>
		</tr><tr>
			<th class="rowlabel">Stall Current<span class="ttt">The current drawn at 0 RPM / Max Torque</span></th>
			<td><input id="motor_stall_current" readonly /></td>
			<td><input id="motor_stall_current_adj" readonly /></td>
			<td class="unit">[A]</td>
		</tr>
	</table>
</div>
	<div class="odd">
		<table>
		<tr>
			<th class="rowlabel">Gear Ratio<span class="ttt">The overall gear ratio. Larger than 1 is a reduction, smaller is a RPM increase. Empty cells are assumed to be 1. You can either blank out all the cells, and plug in a number in the top right one, or build a ratio by typing in the number of teeth on each gear (or belts/sprockets) starting from the motor.</span></th>
			<td class="tiny"></td>
			<td><input id="G" readonly/></td>
		</tr><tr>
			<td><input id="G1A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G1B" oninput="calc_ratio()" /></td>
		</tr><tr>
			<td><input id="G2A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G2B" oninput="calc_ratio()" /></td>
		</tr><tr>
			<td><input id="G3A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G3B" oninput="calc_ratio()" /></td>
		</tr><tr>
			<td><input id="G4A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G4B" oninput="calc_ratio()" /></td>
		</tr>
	</table>
</div><div class="even">
	<table>
		<tr>
			<th class="rowlabel" colspan=2>Encoder Relativity <span class="ttt">(Optional) Where is the encoder placed - on (or in) the motor, or on the output shaft?</span>
				<select id="encoder_placement" onchange="compute(false)">
				<option value="none">No Encoder</option>
				<option value="motor">To Motor</option>
				<option value="output">To Output</option>
			</select></td>
		</tr><tr class='encoder_detail'>
			<th class="rowlabel">CPR<span class="ttt">Encoder Counts Per Revolution<br/>(you can also put ticks, and ticks will be computed. Math is the same)</span></th>
			<td><input id="encoder_cpr" onchange="compute(false)" value=1 /></td>
			<th class="rowlabel">C/x<span class="ttt">Encoder Counts Per Distance Traveled<br/>(how many encoder counts per unit distance traveled)</span></th>
			<td><input id="encoder_cpx" value=1 readonly /></td>
			<td class="unit" id="unit_encoder_cpx"></td>
		</tr><tr class='encoder_detail'>
			<th class="rowlabel">Reduction<span class="ttt">Additional reduction applied between the shaft and the encoder</span></th>
			<td><input id="encoder_reduction" onchange="compute(false)" value='' /></td>
			<th class="rowlabel">Max CPS<span class="ttt">Maximum Counts per Second, at free speed</span></th>
			<td><input id="encoder_max_cps" value=1 readonly /></td>
		</tr>
	</table></div>
	<div class="odd">
		<table>
		<tr>
			<th class="rowlabel">Radius <span class="ttt">Radius of the output.<br/>If this is an arm, input the length of the arm.<br/>If this is an elevator, input the radius of the spool.<br/>If this is a drivetrain, input the radius of the wheel.</span></th>
			<td><input id="radius" oninput="" value=0.1 /></td>
			<td class="unit" id="unit_radius"></td>
		</tr><tr>
			<th class="rowlabel">Load Equation<span class="ttt">(Optional) Load equation. You can put a simple number here, or you can put an expression.<br/>If you put an expression, you can use any javascript operators (+,-,*,/,Math.sin(...),...).<br/>You can use any variables described in the pullout below.</span></th>
			<td><input id="load" oninput="" /></td>
			<td class="unit" id="unit_load"></td>
		</tr><tr>
			<th class="rowlabel">Mass<span class="ttt">(Optional) [Equivalent] Mass.<br/>If you're running a linear device, you can just put its mass in here.<br/>If you are analyzing a rotational device, you can put the moment of inertia, divided by the radius squared here.</span></th>
			<td><input id="mass" oninput="" value=1.0 /></td>
			<td class="unit" id="unit_mass"></td>
		</tr><tr>
			<th class="rowlabel">End Condition<span class="ttt">(Optional) End condition. Must be an expression that logically evaluates.<br/>You can use any javascript operators/comparators (+,-,*,/,>,<,Math.sin(...),...).<br/>You can use any variables described in the pullout below.</span></th>
			<td><input id="endcond" oninput="" value="t > 5"/></td>
		</tr>
	</table>
	<button type="button" onclick="compute()">Compute!</button>
</div>
<div  class="output">
	<table>
		<tr>
			<th class="rowlabel">End Condition Met in t=<span class="ttt">When simulation terminated if the end condition was met. If not, it will tell you the end condition was unmet.</span></th>
			<td><input id="endcond_met" readonly /></td>
			<td class="unit">[s]</td>
		</tr><tr>
			<th class="rowlabel">Current Used<span class="ttt">Total electrical consumption in the simulation period</span></th>
			<td><input id="current_cons" readonly /></td>
			<td class="unit">[A-s]</td>
		</tr><tr>
			<th class="rowlabel">Current At End<span class="ttt">Current drawn at the end of the simulation period</span></th>
			<td><input id="current_end" readonly /></td>
			<td class="unit">[A]</td>
		</tr>
		<tr>
			<th class="rowlabel">No Load Speed<span class="ttt">Speed without any load on the system.<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_freespd" readonly /></td>
			<td class="unit" id="unit_theor_freespd"></td>
		</tr><tr>
			<th class="rowlabel">Running Speed<span class="ttt">Speed while running at steady-state, ASSUMING THAT ALL TRANSIENT VARIABLES (v,x,omega,theta) ARE ZERO.<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_runspd" readonly /></td>
			<td class="unit" id="unit_theor_runspd"></td>
		</tr><tr>
			<th class="rowlabel">Stall Force<span class="ttt">Force produced while at stall (ignoring external load/mass)<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_stall_force" readonly /></td>
			<td class="unit" id="unit_theor_stall_force"></td>
		</tr><tr>
			<th class="rowlabel">Running Current<span class="ttt">Current consumption while running at steady-state, ASSUMING THAT ALL TRANSIENT VARIABLES (v,x,omega,theta) ARE ZERO.<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_stall_current" readonly /></td>
			<td class="unit">[A]</td>
		</tr>
	</table>
</div>
<div class="even">
	Variable reference for use in expressions
	<table>
			<tr><th class='rowlabel'>G</th><td class="unit">[-]</td><td>Overall gear ratio</td></tr>
			<tr><th class='rowlabel'>m</th><td class="unit" id="unit_mass_ref">[kg]</td><td>Mass</td></tr>
			<tr><th class='rowlabel'>I</th><td class="unit" id="unit_moi_ref"></td><td>MOI</td></tr>
			<tr><th class='rowlabel'>r</th><td class="unit" id="unit_radius_ref"></td><td>Radius</td></tr>
			<tr><th class='rowlabel'>t</th><td class="unit">[s]</td><td>Time</td></tr>
			<tr><th class='rowlabel'>v</th><td class="unit" id="unit_velocity_ref"></td><td>Lin. Velocity</td></tr>
			<tr><th class='rowlabel'>x</th><td class="unit" id="unit_position_ref"></td><td>Lin. Position</td></tr>
			<tr><th class='rowlabel'>omega</th><td class="unit">[RPM]</td><td>Rot. Velocity</td></tr>
			<tr><th class='rowlabel'>theta</th><td class="unit">[Rev]</td><td>Rot. Position</td></tr>
			<tr><th class='rowlabel'>omega_m</th><td class="unit">[RPM]</td><td>Rot. Motor Velocity</td></tr>
			<tr><th class='rowlabel'>theta_m</th><td class="unit">[Rev]</td><td>Rot. Motor Position</td></tr>
	</table>
</div>

<!--<div class="even">
	<button type="button" onclick="compute()">CALCULATE!</button>
</div>-->

</div><div style="margin-left: 0px;" class="container" id="charts">
	 <div id="vchart_div" style="width: 900px; height: 500px"></div>
	 <div id="xchart_div" style="width: 900px; height: 500px"></div>
	</div>
</body>
</html>