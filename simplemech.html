<!DOCTYPE html>
<link rel="stylesheet" href="include/style.css"> 
<script type="text/javascript" src="include/specs.js"></script>
<script type="text/javascript">
	unit_sys = 0;
	inputs_unit_map = {
		"motor_stall_torque": ["N-m", "N-m"],
		"motor_stall_torque_adj": ["N-m", "N-m"],
		"encoder_cpx": ["c/m", "c/ft"],
		"radius": ["mm","in"],
		"load": ["N", "lbf"],
		"mass": ["kg", "lbm"],
		"theor_freespd": ["m/s", "ft/s"],
		"theor_runspd": ["m/s", "ft/s"],
		"theor_stall_force": ["N", "lbf"],

		"mass_ref": ["kg", "lbm"],
		"moi_ref": ["kg m^2", "lbm in^2"],
		"radius_ref": ["m"," in"],
		"velocity_ref": ["m/s", "ft/s"],
		"position_ref": ["m", "ft"],

		"query_d": ["m", "ft"],
		"query_v": ["m/s", "ft/s"],
		"query_f": ["N", "lbf"],
		"query_a": ["m/s^2", "ft/s^2"]
	}

	function populate_units() {
		if(document.getElementById('unit_metric').checked)
			unit_sys = 0;
		else 
			unit_sys = 1;
		
		unit_labels = document.getElementsByClassName('unit');
		//console.log(unit_labels);
		for (unit in unit_labels) {
			if (unit_labels[unit].id && inputs_unit_map[unit_labels[unit].id.substring(5)] ){
				varname = unit_labels[unit].id.substring(5);
				document.getElementById('unit_'+varname).innerHTML = '['+inputs_unit_map[varname][unit_sys]+']';
			}
		}

		document.getElementById(chart_name+'_d_label').innerHTML = 'Position ['+inputs_unit_map['query_d'][unit_sys]+']';
		document.getElementById(chart_name+'_v_label').innerHTML = 'Velocity ['+inputs_unit_map['query_v'][unit_sys]+']';
		document.getElementById(chart_name+'_f_label').innerHTML = 'Force ['  +inputs_unit_map['query_f'][unit_sys]+']';
	}


	function select_plot_mode(no_compute) {
		var v = document.getElementById('plot_mode').value;
		if (v=='linear') {
			inputs_unit_map["query_d"]=["m", "ft"];
			inputs_unit_map["query_v"]=["m/s", "ft/s"];
			inputs_unit_map["query_f"]=["N", "lbf"];
			inputs_unit_map["query_a"]=["m/s^2", "ft/s^2"];
		} else if (v=='rotary') {
			inputs_unit_map["query_d"]=["rev", "rev"];
			inputs_unit_map["query_v"]=["RPM", "RPM"];
			inputs_unit_map["query_f"]=["N-m", "ft-lbf"];
			inputs_unit_map["query_a"]=["RPM/s", "RPM/s"];
		}

		switch_units(no_compute);
	}

	function switch_units(no_compute) {
		populate_units();
		if(!no_compute) compute();
	}

	function get_motor_data(motor,key){
		return motor_data[motor][key];
	}

	function gidv(id, ignore_units) {

		v =  eval(document.getElementById(id).value);
		if ((!ignore_units) && typeof inputs_unit_map[id] !== 'undefined')
			v = convert(v, inputs_unit_map[id][unit_sys]);
		return v;
	}

	function gids(id, value, places, disable_conversion) {
		if (typeof places === 'undefined')
			places = 3;
		if (typeof value === 'string') {
			document.getElementById(id).value = value;
		} else {
			if ((!disable_conversion) && typeof inputs_unit_map[id] !== 'undefined')
				value = convert_to(value, inputs_unit_map[id][unit_sys]);
			document.getElementById(id).value = value.toFixed(places);
		}
	}

	function thload() {
		var inputs, index;

		select_plot_mode(true);

		inputs = document.getElementsByTagName('input');
		for (index = 0; index < inputs.length; ++index) {
		    inputs[index].onkeyup = function(e) {
		    	var key = e.keyCode ? e.keyCode : e.which;

		    	if (key==13) {
		    		compute(true);
		    	} else {
		    		compute(false);
		    	}
		    }
		}

		select = document.getElementById("motortype");
		i=0;
		for(motor in motor_data) {
			i++;
			opt = document.createElement('option');
			opt.innerHTML = motor_data[motor]["plain_name"];
			opt.value = motor;
			select.appendChild(opt);
		}

		calc_ratio();
		motortype_select(document.getElementById("motortype"));
		
	}

	function compute(simulate) {
		simulate = typeof simulate !== 'undefined' ? simulate : true;
		document.getElementById('charts').classList.add('uncomputed');
		document.getElementById('endcond_met').classList.add('uncomputed');
		document.getElementById('current_cons').classList.add('uncomputed');
		document.getElementById('current_end').classList.add('uncomputed');

		var dt = 0;
		// overall, solve: alpha = (T-Mres)/I
		// make x, v, theta, omega available
		var R = gidv("radius"); var r = gidv('radius', true);
		var M = gidv("mass");   var m = gidv('mass',   true);
		var TS = gidv("motor_stall_torque_adj"); var Ts = gidv('motor_stall_torque_adj', true);
		var wf = gidv("motor_max_rpm_adj") * 2*Math.PI/60; // convert to rad/s!
		var If = gidv("motor_free_current_adj");
		var Is = gidv("motor_stall_current_adj");
		var G = gidv("G");

		//console.log(r,m,Ts,wf,If,Is,G);

		load_expr = document.getElementById("load").value;
		end_expr = document.getElementById("endcond").value;

		if(end_expr == "") end_expr = "0";

		I = M*R*R;

		alpha_ar = [0,0];
		omega_ar = [0,0];
		theta_ar = [0];
		t_ar = [0];

		omega=0; theta=0; theta_m=0; omega_m=0; v=0; x=0; t=0;
		T = G*TS*(wf-omega_ar[omega_ar.length-1]*G)/wf;
		Mres = eval(load_expr)*R;
		if(isNaN(Mres)) Mres = 0;
		// T = Mres -> G*Ts - G*Ts*omega_m/wf = Mres -> omega_m = (G*Ts - Mres)/(G*Ts/wf)
		omega_m_theor = (G*TS - Mres)/(G*TS/wf);
		gids("theor_freespd", R*wf/G)
		gids("theor_runspd", R*omega_m_theor/G);
		gids("theor_stall_force", G*TS/R);
		gids("theor_stall_current", If + (Is-If) * (wf-omega_m_theor)/wf);

		enc_plc = document.getElementById('encoder_placement').value;
		//console.log(enc_plc);
		enc_els = document.getElementsByClassName('encoder_detail');
		if (enc_plc == 'none') {
			for (i=0;i<enc_els.length;i++) {
				enc_els[i].style.display = 'none';
			}
		} else {
			for (i=0;i<enc_els.length;i++) {
				enc_els[i].style.display = 'table-row';
			}

			cpx = gidv('encoder_cpr')/NaNto1(gidv('encoder_reduction'))/(r*2*Math.PI);
			if(enc_plc == 'motor') cpx *= G;

			console.log(cpx);
			gids('encoder_cpx', cpx);
			gids('encoder_max_cps', cpx*R*wf/G);
		}

		if (!simulate) return; // YARRR, NO MORE PLAIN CALCS BEYOND THIS POINT

		cur_cons = 0;

		alpha_o = NaN;

		Rf = R;
		if (document.getElementById('plot_mode').value == 'linear') Rf = 1;

		channels = [[],[],[],[],[],[]]; //[[0],[0],[0],[Is],[G*TS/R*Rf],[0]];
      	i=0;
		while(1) {
			//console.log(dt);
			omega = omega_ar[omega_ar.length-1] * 60/2/Math.PI;
			theta = theta_ar[theta_ar.length-1] * 2/Math.PI;
			t = t_ar[t_ar.length-1];
			x = convert_to(theta_ar[theta_ar.length-1]*R, inputs_unit_map['query_d'][unit_sys]);
			v = convert_to(omega_ar[omega_ar.length-1]*R, inputs_unit_map['query_v'][unit_sys]);
			omega_m = omega*G;
			theta_m = theta*G;

			T = G*TS*(wf-omega_ar[omega_ar.length-1]*G)/wf;
			Mres = convert(eval(load_expr), inputs_unit_map["load"][unit_sys])*R;
			if(isNaN(Mres)) Mres = 0;
			alpha = (T-Mres) / I;
			//console.log(T, Mres, alpha);
			if(isNaN(alpha_o)) alpha_o = alpha;

			alpha_ar.push(alpha);

			// Use Adams-Bradforth Method
			theta_ar.push(theta_ar[theta_ar.length-1] + omega_ar[omega_ar.length-1]*dt*3/2 - omega_ar[omega_ar.length-2]*dt*1/2);
			omega_ar.push(omega_ar[omega_ar.length-1] + alpha_ar[alpha_ar.length-1]*dt*3/2 - alpha_ar[alpha_ar.length-2]*dt*1/2);
			t_ar.push(t_ar[t_ar.length-1]+dt);
			
			cur = If + (Is-If)*(wf-omega_ar[omega_ar.length-1]*G)/wf;
			cur_cons = cur_cons + dt*cur;

			if (i > 5000 || eval(end_expr)) break;

			channels[0].push(t_ar[t_ar.length-1]);
			channels[1].push(omega_ar[omega_ar.length-1]*R / Rf);
			channels[2].push(theta_ar[theta_ar.length-1]*R / Rf);
			channels[3].push(cur);
			channels[4].push(T/R * Rf);
			channels[5].push(alpha*R / Rf);

			

			dt = Math.min(0.1,Math.max(1e-7,Math.min(Math.abs(wf/G/alpha_o),Math.abs(wf/G/alpha))/30));
			i++;
		}

		omega_ar.shift(); //remove the first element of this array that was there for adams-bradforth 

		drawchart1(channels);
		document.getElementById('charts').classList.remove('uncomputed');
		document.getElementById('endcond_met').classList.remove('uncomputed');
		document.getElementById('current_cons').classList.remove('uncomputed');
		document.getElementById('current_end').classList.remove('uncomputed');

      	gids("endcond_met", eval(end_expr) ? t_ar[t_ar.length-1]:"NOT MET");
      	gids("current_cons", cur_cons);
      	gids("current_end", (If + (Is-If)*(wf-G*omega_ar[omega_ar.length-1])/wf));
	}

	function motortype_select() {
		e=document.getElementById("motortype");
		var props = ["max_rpm", "stall_torque", "free_current", "stall_current"];
		props.forEach(function(a) {
			
			document.getElementById("motor_"+a).value=get_motor_data(e.value, a);
			adjVal = get_motor_data(e.value, a)*gidv("op_voltage")/12;
			if (a=="stall_torque")
				adjVal *= gidv("motornum")*gidv("efficiency")/100;
			if (a=="free_current" || a=="stall_current" )
				adjVal *= gidv("motornum");
			gids("motor_"+a+"_adj",adjVal);
		});

		compute();
	}

	function NaNto1(x) {
		if (isNaN(x))
			return 1;
		return x;
	}

	function calc_ratio() {
		var G = 1;
		G *= NaNto1(gidv("G1B"));
		G *= NaNto1(gidv("G2B"));
		G *= NaNto1(gidv("G3B"));
		G *= NaNto1(gidv("G4B"));
		G /= NaNto1(gidv("G1A"));
		G /= NaNto1(gidv("G2A"));
		G /= NaNto1(gidv("G3A"));
		G /= NaNto1(gidv("G4A"));

		gids("G", G);
	}

	function collapse(id) {
		el = document.getElementById('detail_'+id);
		btn = document.getElementById('toggle_detail_'+id);
		
		if(el.style['display'] != 'none') {
			el.style['display'] = 'none';
			btn.innerHTML = "&#9660";
			if (id='gratio') document.getElementById('G').readOnly = false;
		} else {
			el.style['display'] = 'inherit';
			btn.innerHTML = "&#9650";
			if (id='gratio'){ document.getElementById('G').readOnly = true; calc_ratio(); }
		}
	}

</script>

<script style="text/javascript">
	function makeTicks(maxes, num_to_print, n) {
		if (Math.min(maxes) < 0) return [0];
		H = [];
		bases = [];
		for(var i=0; i<maxes.length; i++){
			h = maxes[i]/n;
			base = Math.floor(Math.log10(h)-Math.log10(5));
			bases.push(base);
			H.push(Math.round(h/Math.pow(10, base))*Math.pow(10, base));
		}

		ticks = [];
		ticksstr = [];
		alive = true;
		for(var i=0; alive; i++) {
			alive = false;
			labelstr = '';
			for(var j=0; j<maxes.length; j++) {
				if (j<num_to_print) {
					if (ticks.length <= j+1)
						ticks.push([]);
					ticks[j].push(H[j]*i);
					labelstr += (H[j]*i).toFixed(bases[j] > 0 ? 0:-bases[j]);
					if (j != num_to_print-1)
						labelstr += ' / ';
				}
				if (H[j]*(i) < maxes[j])
					alive = true;
			}
			ticksstr.push(labelstr);
			
		}
		return [ticks, ticksstr];
	}

	function sign(x) {
		if(x>0) return 1;
		if(x<0) return -1;
		return 0;
	}

	chart_name = 'chart';

	function drawTicks(axis, ticks, maxtick, ticklabels, ff, f0, gf, g0, marg) {
		altaxis = axis == 'x' ? 'y':'x';
		realaxis = axis == 'z' ? 'y':axis;
		xgrid = document.getElementById(chart_name+'_'+axis+'_grid');
		while(xgrid.firstChild) xgrid.removeChild(xgrid.firstChild);

		labels = document.getElementById(chart_name+'_'+axis+'_axis_labels');
		while(labels.firstChild) labels.removeChild(labels.firstChild);

		gfl = (axis=='z'?gf:g0) + (axis=='y'?-1:1)*marg;

		for (i in ticklabels) {
			line = document.createElementNS('http://www.w3.org/2000/svg','line');
			line.setAttribute(altaxis+'1', gf); line.setAttribute(altaxis+'2', g0);
			fp = f0 + (ff-f0)*(ticks==null ? i/(ticklabels.length-1) : ticks[i]/maxtick);
			//fp = f0 + (ff-f0)*(i/(ticklabels.length-1));
			line.setAttribute(realaxis+'1', fp);
			line.setAttribute(realaxis+'2', fp);
			line.setAttribute('class', 'grid');
			xgrid.append(line);

			label = document.createElementNS('http://www.w3.org/2000/svg','text');
			label.setAttribute(altaxis, gfl);
			label.setAttribute(realaxis, fp);
			label.innerHTML = i==0 ? '0' : ticklabels[i];
			labels.append(label);
		}
	}

	function linterp(xs, ys, xq) {
		i;
		for (i=1; i<xs.length-1 && !isNaN(xs[i]) && xq>xs[i]; i++) {}
		return ys[i-1] + (ys[i]-ys[i-1])/(xs[i]-xs[i-1])*(xq-xs[i-1]);
	}

	function drawchart1(channels) {
		[t, v_raw, d_raw, cur, F_raw, a_raw] = channels;
		d = convert_to(d_raw, inputs_unit_map['query_d'][unit_sys]);
		v = convert_to(v_raw, inputs_unit_map['query_v'][unit_sys]);
		f = convert_to(F_raw, inputs_unit_map['query_f'][unit_sys]);
		a = convert_to(a_raw, inputs_unit_map['query_a'][unit_sys]);

		//console.log([t,v,d,cur,f]);

		svg = document.getElementById('chart');
		x_axis = document.getElementById('chart_x_axis');
		y_axis = document.getElementById('chart_y_axis');

		x0 = Math.min(y_axis.x1.baseVal.value, y_axis.x2.baseVal.value);
		xf = Math.max(y_axis.x1.baseVal.value, y_axis.x2.baseVal.value);
		y0 = Math.max(x_axis.y1.baseVal.value, x_axis.y2.baseVal.value);
		yf = Math.min(x_axis.y1.baseVal.value, x_axis.y2.baseVal.value);

		d_line = document.getElementById('chart_d_line');
		v_line = document.getElementById('chart_v_line');
		cur_line = document.getElementById('chart_cur_line');
		f_line = document.getElementById('chart_f_line');
		d_line.setAttribute("points",""); // I don't like it, but it does clear the points
		v_line.setAttribute("points",""); // I don't like it, but it does clear the points
		cur_line.setAttribute("points",""); // I don't like it, but it does clear the points
		f_line.setAttribute('points','');



		[[t_ticks], xticklabels] = makeTicks([Math.max(...t)], 1, 9);
		[[d_ticks, v_ticks], yticklabels] = makeTicks([Math.max(...d), Math.max(...v), Math.max(...cur), Math.max(...f)], 2, 6);
		[[cur_ticks, f_ticks], zticklabels] = makeTicks([Math.max(...cur), Math.max(...f), Math.max(...d), Math.max(...v)], 2, 6);

		t_ticks.pop(); xticklabels.pop();
		
		t_max = Math.max(...t); //t_ticks[t_ticks.length-1];
		d_max = d_ticks[d_ticks.length-1];
		v_max = v_ticks[v_ticks.length-1];
		cur_max = cur_ticks[cur_ticks.length-1];
		f_max = f_ticks[f_ticks.length-1];



		drawTicks('x', t_ticks, t_max, xticklabels, xf, x0, yf, y0, 15);
		drawTicks('y', null, null, yticklabels, yf, y0, xf, x0, 5);
		drawTicks('z', null, null, zticklabels, yf, y0, xf, x0, 5);

		for (i in t) {
			var ptd = svg.createSVGPoint();
			var ptv = svg.createSVGPoint();
			var ptcur = svg.createSVGPoint();
			var ptf = svg.createSVGPoint();

			xq = x0 + (xf-x0)/(t_max-0)*t[i];
			ptf.x = ptv.x = ptd.x = ptcur.x = xq;

			ptd.y   = y0 + (yf-y0)/(d_max-0)*d[i];
			ptv.y   = y0 + (yf-y0)/(v_max-0)*v[i];
			ptcur.y = y0 + (yf-y0)/(cur_max-0)*cur[i];
			ptf.y   = y0 + (yf-y0)/(f_max-0)*f[i];
			d_line.points.appendItem(ptd);
			v_line.points.appendItem(ptv);
			cur_line.points.appendItem(ptcur);
			f_line.points.appendItem(ptf);
		}
		
		bg=document.getElementById('chart');

		qline = document.getElementById('chart_query_line');
		qline.setAttribute('opacity', 0);

		gids('query_time', '-', 3, true);
		gids('query_d', '-', 3, true);
		gids('query_v', '-', 3, true);
		gids('query_cur', '-', 3, true);
		gids('query_f', '-', 3, true);
		gids('query_a', '-', 3, true);

		handler = function(event){
			if(event.buttons != 1) return;
				xq = event.clientX - bg.getBoundingClientRect().left;
				yq = event.clientY - bg.getBoundingClientRect().top;

				tq = (t_max-0)/(xf-x0)*(xq-x0);
				if (tq>Math.max(...t)){
					tq = Math.max(...t);
					xq = x0 + (xf-x0)/(t_max-0)*tq;
				}
				if (tq<Math.min(...t)) {
					tq=Math.min(...t); xq=x0;
				}
				dq   = linterp(t, d, tq);
				vq   = linterp(t, v, tq);
				curq = linterp(t, cur, tq);
				fq   = linterp(t, f, tq);
				aq   = linterp(t, a, tq);
				qline.setAttribute('opacity', 1);

				qline.setAttribute('x1', xq);
				qline.setAttribute('x2', xq);

				gids('query_time', tq, 3, true);
				gids('query_d', dq, 3, true);
				gids('query_v', vq, 3, true);
				gids('query_cur', curq, 3, true);
				gids('query_f', fq, 3, true);
				gids('query_a', aq, 3, true);
			}
		bg.addEventListener('mousemove', handler);
		bg.addEventListener('mousedown', handler);
	}
</script>


<html>
<body onload="thload()">
	<div style="display:table;">
	<div style="width: 300px; float: left; display:table-cell;" class="container">
	<h3><a href="http://thaddeus-maximus.github.io">Thad</a>'s Mechanism Calculator</h3>
	<center><a href="./">Back To Index</a></center>

	<div class="odd">
		<center>
			  <input type="radio" id="unit_english" name="unit" value="english" onclick="switch_units()" checked>
			  <label for="english">English</label>
			  <input type="radio" id="unit_metric" name="unit" value="metric" onclick="switch_units()">
			  <label for="metric">Metric</label><br>
		</center>
	</div>

	

	<div class="even">
		<div>
			<span class="rowlabel"># Motors<span class="ttt">How many motors do you have in total for this mechanism (assuming they're identical, and geared together)</span></span>
			<input class='narrow' id="motornum" oninput="motortype_select()" value=1 />

			<span class="rowlabel">Voltage<span class="ttt">What voltage are the motors ran at? (assuming that the nominal motor performance is at 12V)</span></span>
			<input class='narrow' id="op_voltage" oninput="motortype_select()" value=12 />
			<span class="unit">[V]</span>
			
			<span class="rowlabel">Efficiency<span class="ttt">Efficiency of the transmission</span></span>
			<input class='narrow'  id="efficiency" oninput="motortype_select()" value=85 />
			<span class="unit">[%]</span>
			
		</div>
		<div>
			
			<span class="rowlabel">Motor</span>
			<select class="doublewide" id="motortype" oninput="motortype_select()"></select>
			<button type="button" onclick="collapse('motor')" id='toggle_detail_motor'>&#9660;</button>
		</div>
	<table id='detail_motor' style='display:none;'>
		<tr>
			<th></th>
			<th class="collabel">Raw Motor</th>
			<th class="collabel">Adjusted</th>
			<th></th>
		</tr>
		<tr>
			<th class="rowlabel">Free Speed<span class="ttt">The maximum RPM of the motor</span></th>
			<td><input id="motor_max_rpm" readonly /></td>
			<td><input id="motor_max_rpm_adj" readonly /></td>
			<td class="unit">[RPM]</td>
		</tr><tr>
			<th class="rowlabel">Stall Torque<span class="ttt">The maximum torque of the motor, occurring at 0 RPM</span></th>
			<td><input id="motor_stall_torque" readonly /></td>
			<td><input id="motor_stall_torque_adj" readonly /></td>
			<td class="unit" id="unit_motor_stall_torque"></td>
		</tr><tr>
			<th class="rowlabel">Free Current<span class="ttt">The current drawn when the motor is unloaded</span></th>
			<td><input id="motor_free_current" readonly /></td>
			<td><input id="motor_free_current_adj" readonly /></td>
			<td class="unit">[A]</td>
		</tr><tr>
			<th class="rowlabel">Stall Current<span class="ttt">The current drawn at 0 RPM / Max Torque</span></th>
			<td><input id="motor_stall_current" readonly /></td>
			<td><input id="motor_stall_current_adj" readonly /></td>
			<td class="unit">[A]</td>
		</tr>
	</table>
</div>
	<div class="odd">
		<div>
		<span class='rowlabel'>Gear Ratio<span class="ttt">The overall gear ratio. Larger than 1 is a reduction, smaller is a RPM increase. Empty cells are assumed to be 1. You can either blank out all the cells, and plug in a number in the top right one, or build a ratio by typing in the number of teeth on each gear (or belts/sprockets) starting from the motor.</span></span>
		<input id="G"/>
		<button type="button" onclick="collapse('gratio')" id='toggle_detail_gratio'>&#9660;</button>
	</div>
	<table id='detail_gratio' style="display:none;">
		<tr>
			<td><input id="G1A" oninput="calc_ratio()" value=12 /></td>
			<td class="tiny">:</td>
			<td><input id="G1B" oninput="calc_ratio()" value=72 /></td>
		</tr><tr>
			<td><input id="G2A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G2B" oninput="calc_ratio()" /></td>
		</tr><tr>
			<td><input id="G3A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G3B" oninput="calc_ratio()" /></td>
		</tr><tr>
			<td><input id="G4A" oninput="calc_ratio()" /></td>
			<td class="tiny">:</td>
			<td><input id="G4B" oninput="calc_ratio()" /></td>
		</tr>
	</table>
</div><div class="even">
	<div>
		<span class="rowlabel">Encoder Relativity<span class="ttt">(Optional) Where is the encoder placed - on (or in) the motor, or on the output shaft?</span></span>
			<select id="encoder_placement" onchange="compute(false)">
				<option value="none">No Encoder</option>
				<option value="motor">To Motor</option>
				<option value="output">To Output</option>
			</select>
		<button type="button" onclick="collapse('encoder')" id='toggle_detail_encoder'>&#9660;</button>
		</div>
		<table id='detail_encoder' style='display:none;'>
		<tr class='encoder_detail'>
			<th class="rowlabel">CPR<span class="ttt">Encoder Counts Per Revolution<br/>(you can also put ticks, and ticks will be computed. Math is the same)</span></th>
			<td><input id="encoder_cpr" onchange="compute(false)" value=1 /></td>
			<th class="rowlabel">C/x<span class="ttt">Encoder Counts Per Distance Traveled<br/>(how many encoder counts per unit distance traveled)</span></th>
			<td><input id="encoder_cpx" value=1 readonly /></td>
			<td class="unit" id="unit_encoder_cpx"></td>
		</tr><tr class='encoder_detail'>
			<th class="rowlabel">Reduction<span class="ttt">Additional reduction applied between the shaft and the encoder</span></th>
			<td><input id="encoder_reduction" onchange="compute(false)" value='' /></td>
			<th class="rowlabel">Max CPS<span class="ttt">Maximum Counts per Second, at free speed</span></th>
			<td><input id="encoder_max_cps" value=1 readonly /></td>
		</tr>
	</table></div>
	<div class="odd">
		<table>
		<tr>
			<th class="rowlabel">Radius <span class="ttt">Radius of the output.<br/>If this is an arm, input the length of the arm.<br/>If this is an elevator, input the radius of the spool.<br/>If this is a drivetrain, input the radius of the wheel.</span></th>
			<td><input id="radius" oninput="" value=2 /></td>
			<td class="unit" id="unit_radius"></td>
		</tr><tr>
			<th class="rowlabel">Load Equation<span class="ttt">(Optional) Load equation. You can put a simple number here, or you can put an expression.<br/>If you put an expression, you can use any javascript operators (+,-,*,/,Math.sin(...),...).<br/>You can use any variables described in the pullout below.</span></th>
			<td><input id="load" oninput="" /></td>
			<td class="unit" id="unit_load"></td>
		</tr><tr>
			<th class="rowlabel">Mass<span class="ttt">(Optional) [Equivalent] Mass.<br/>If you're running a linear device, you can just put its mass in here.<br/>If you are analyzing a rotational device, you can put the moment of inertia, divided by the radius squared here.</span></th>
			<td><input id="mass" oninput="" value=30 /></td>
			<td class="unit" id="unit_mass"></td>
		</tr><tr>
			<th class="rowlabel">End Condition<span class="ttt">(Optional) End condition. Must be an expression that logically evaluates.<br/>You can use any javascript operators/comparators (+,-,*,/,>,<,Math.sin(...),...).<br/>You can use any variables described in the pullout below.</span></th>
			<td><input id="endcond" oninput="" value="x > 5"/></td>
		</tr>
	</table>
<div class="even">
	Variable reference for use in expressions
	<button type="button" onclick="collapse('varref')" id='toggle_detail_varref'>&#9660;</button>
	<table id='detail_varref' style='display:none;'>
			<tr><th class='rowlabel'>G</th><td class="unit">[-]</td><td>Overall gear ratio</td></tr>
			<tr><th class='rowlabel'>m</th><td class="unit" id="unit_mass_ref">[kg]</td><td>Mass</td></tr>
			<tr><th class='rowlabel'>I</th><td class="unit" id="unit_moi_ref"></td><td>MOI</td></tr>
			<tr><th class='rowlabel'>r</th><td class="unit" id="unit_radius_ref"></td><td>Radius</td></tr>
			<tr><th class='rowlabel'>t</th><td class="unit">[s]</td><td>Time</td></tr>
			<tr><th class='rowlabel'>v</th><td class="unit" id="unit_velocity_ref"></td><td>Lin. Velocity</td></tr>
			<tr><th class='rowlabel'>x</th><td class="unit" id="unit_position_ref"></td><td>Lin. Position</td></tr>
			<tr><th class='rowlabel'>omega</th><td class="unit">[RPM]</td><td>Rot. Velocity</td></tr>
			<tr><th class='rowlabel'>theta</th><td class="unit">[Rev]</td><td>Rot. Position</td></tr>
			<tr><th class='rowlabel'>omega_m</th><td class="unit">[RPM]</td><td>Rot. Motor Velocity</td></tr>
			<tr><th class='rowlabel'>theta_m</th><td class="unit">[Rev]</td><td>Rot. Motor Position</td></tr>
	</table>
	<center><button type="button" onclick="compute()">Compute!</button></center>
</div>
<div  class="output">
	<table>
		<tr>
			<th class="rowlabel">End Cond. Met @<span class="ttt">When simulation terminated if the end condition was met. If not, it will tell you the end condition was unmet. Auto-time-stepping may cause runs with high initial accelerations to have very short runtimes.</span></th>
			<td><input id="endcond_met" readonly /></td>
			<td class="unit">[s]</td>
		</tr><tr>
			<th class="rowlabel">Current Used<span class="ttt">Total electrical consumption in the simulation period</span></th>
			<td><input id="current_cons" readonly /></td>
			<td class="unit">[A-s]</td>
		</tr><tr>
			<th class="rowlabel">Current At End<span class="ttt">Current drawn at the end of the simulation period</span></th>
			<td><input id="current_end" readonly /></td>
			<td class="unit">[A]</td>
		</tr>
		<tr>
			<th class="rowlabel">No Load Speed<span class="ttt">Speed without any load on the system.<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_freespd" readonly /></td>
			<td class="unit" id="unit_theor_freespd"></td>
		</tr><tr>
			<th class="rowlabel">Running Speed<span class="ttt">Speed while running at steady-state, ASSUMING THAT ALL TRANSIENT VARIABLES (v,x,omega,theta) ARE ZERO.<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_runspd" readonly /></td>
			<td class="unit" id="unit_theor_runspd"></td>
		</tr><tr>
			<th class="rowlabel">Stall Force<span class="ttt">Force produced while at stall (ignoring external load/mass)<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_stall_force" readonly /></td>
			<td class="unit" id="unit_theor_stall_force"></td>
		</tr><tr>
			<th class="rowlabel">Running Current<span class="ttt">Current consumption while running at steady-state, ASSUMING THAT ALL TRANSIENT VARIABLES (v,x,omega,theta) ARE ZERO.<br/>Equivalent to the JVN calc.</span></th>
			<td><input id="theor_stall_current" readonly /></td>
			<td class="unit">[A]</td>
		</tr>
	</table>
	</div>
</div><div class="even">
		<span class="rowlabel">Protips</span>
		<button type="button" onclick="collapse('protips')" id='toggle_detail_protips'>&#9660;</button>
		<table id='detail_protips'>
		<tr>
			<td>
				The calculator can be used for any mechanism. For a drivetrain, plug in wheel radius, robot mass, and nothing for load (unless you're pushing something). For an arm, plug in the radius to the center of mass, arm's mass, and the effective load at the center of gravity. For an elevator, plug in pulley radius, elevator mass, and the elevator load (weight minus any counterbalancing). Reverse the load to go 'down'.<br/><br/>
				Click on the chart to probe points!<br/><br/>
				When the chart background is yellow, computation is needed; hit enter or press compute.</br/><br/>
				When the chart background is red, the current combination of inputs cannot be solved for.<br/><br/>
				The gear ratio has a dropdown that can be used to compute ratios from gearsets. Otherwise you can collapse it and plug in a gear ratio directly.<br/><br/>
				The simulator uses auto-time-stepping based on the initial acceleration. It's best to specify an end condition. If your mechanism is extremely snappy, it's probably geared really, really low- so it will put the motor near free speed, which is generally undesirable.<br/><br/>
				You can input arithmetic anywhere. But only input symbolic math (with variables) in the end condition and load equation boxes.
			</td>
		</tr>
</table>
</div>

</div>

<!--<div class="even">
	<button type="button" onclick="compute()">CALCULATE!</button>
</div>-->


<div style="margin-left: 0px; display:table-cell;" class="container" id="charts">

<svg version="1.2" class="graph" id='chart' aria-labelledby="title" role="img">
  <title id="title">Position/Velocity Data</title>


<rect class="background" id="chart_background" x=90 y=20 width=615 height=430 />
<g class="x-grid">
  <line id="chart_x_axis" class="axes" x1="90" x2="90" y1="20" y2="450"></line>
</g>
<g class="y-grid">
  <line id="chart_y_axis" class="axes" x1="90" x2="705" y1=450 y2=450></line>
  <line id="chart_z_axis" class="axes" x1="705" x2="705" y1="20" y2=450></line>
</g>

<g class="x-grid" id="chart_x_grid"></g>
<g class="y-grid" id="chart_y_grid"></g>
<g class="z-grid" id="chart_z_grid"></g>

<g class="labels x-labels" id='chart_x_labels'>
  <text x="375" y=485 class="label-title">Time [s]</text>
</g>

<g class="labels y-labels" id='chart_y_labels'>
  <text x=-300 y=15 class="label-title" transform="rotate(270)" id="chart_d_label" fill="#0074d9">Position</text>
  <text x=-180 y=15 class="label-title" transform="rotate(270)" id="chart_v_label" fill="#d91200">Velocity</text>
  <text x=-240 y=15 class="label-title" transform="rotate(270)" id="chart_y1_divider" fill="#111">/</text>
</g>

<g class="labels z-labels" id='chart_z_labels'>
  <text x=-300 y=800 class="label-title" transform="rotate(270)" id="chart_cur_label" fill="#444">Current [A]</text>
  <text x=-180 y=800 class="label-title" transform="rotate(270)" id="chart_f_label" fill="#c48900">Force</text>
  <text x=-240 y=800 class="label-title" transform="rotate(270)" id="chart_y1_divider" fill="#111">/</text>
</g>

<g class="labels x-labels" id='chart_x_axis_labels'></g>
<g class="labels z-labels" id='chart_z_axis_labels'></g>
<g class="labels y-labels" id='chart_y_axis_labels'></g>

<g class="query-line">
	<line id="chart_query_line" x1=100 x2=100 y1=15 y2=455></line>
</g>
<polyline
	id='chart_d_line'
	fill='none'
	stroke='#0074d9'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_v_line'
	fill='none'
	stroke='#d91200'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_cur_line'
	fill='none'
	stroke='#444'
	stroke-width=2
	points="
	"/>
<polyline
	id='chart_f_line'
	fill='none'
	stroke='#c48900'
	stroke-width=2
	points="
	"/>
</svg>
	
	<div class="output-graph">

		<table>
			<tr>
				<th class="rowlabel">Plot Mode</th>
				<td>
					<select id="plot_mode" onchange="select_plot_mode()">
						<option value="linear">Linear</option>
						<option value="rotary">Rotary</option>
					</select>
				</td>
			</tr>
			<tr>
				<th class="rowlabel">Queried Time<span class="ttt">Query a time on the graph by clicking (and optionally dragging) a point. Timepoint represented by a vertical bar.</span></th>
				<td><input id="query_time" readonly /></td>
				<td class="unit">[s]</td>
			</tr><tr>
				<th class="rowlabel">Position</th>
				<td><input id="query_d" readonly /></td>
				<td class="unit" id="unit_query_d"></td>
			</tr><tr>
				<th class="rowlabel">Velocity</th>
				<td><input id="query_v" readonly /></td>
				<td class="unit" id="unit_query_v"></td>
			</tr><tr>
				<th class="rowlabel">Current</th>
				<td><input id="query_cur" readonly /></td>
				<td class="unit">[A]</td>
			</tr><tr>
				<th class="rowlabel">Acceleration</th>
				<td><input id="query_a" readonly /></td>
				<td class="unit" id="unit_query_a"></td>
			</tr><tr>
				<th class="rowlabel">Actuator Force<span class="ttt">The force the actuator puts out. THIS IS NOT NET FORCE. Subtract off load equation to find net force.</span></th>
				<td><input id="query_f" readonly /></td>
				<td class="unit" id="unit_query_f"></td>
			</tr>
		</div>
	</div>
</div>
</body>
</html>