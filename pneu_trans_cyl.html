<!DOCTYPE html>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet" href="style.css"> 
<script type="text/javascript" src="specs.js"></script>
<script type="text/javascript">
	var poschart = null, poschart_options = null;
	var xchart = null, xchart_options = null;

	google.charts.load('current', {'packages':['corechart', 'scatter', 'line']});
    google.charts.setOnLoadCallback(drawStuff);


    function drawStuff() {
      poschart = new google.visualization.LineChart(document.getElementById('poschart_div'));
      var poschartDiv = document.getElementById('poschart_div');

      poschart_options = {
          backgroundColor: { fill:'transparent' },
          curveType: 'function',
          legend: {position: 'top'},
          vAxes: {
          	//0: {title: 'Linear Velocity (m/s)'},
          	1: {title: 'Linear Position (m)'},
          	2: {title: 'Pressure'}
          	//3: {title: 'Temperature'},
          	//4: {title: 'Mass'}
          },
          series: {
          	//0: {targetAxisIndex: 1},
          	1: {targetAxisIndex: 1},
          	2: {targetAxisIndex: 0}
          	//3: {targetAxisIndex: 0},
          	//4: {targetAxisIndex: 1}
          },
          vAxis: {
	          viewWindow: {
	            min: 0
	          }
	        }

      };

      var posdata = new google.visualization.DataTable();
      posdata.addColumn('number', 'Time (s)');
      posdata.addColumn('number', 'Linear Velocity (m/s)');
      posdata.addColumn('number', 'Linear Position (m)');
      posdata.addRows([]);

      poschart.draw(posdata, poschart_options);

      xchart = new google.visualization.LineChart(document.getElementById('xchart_div'));
      var xchartDiv = document.getElementById('xchart_div');

      xchart_options = {
          backgroundColor: { fill:'transparent' },
          curveType: 'function',
          legend: {position: 'top'},
          vAxes: {
          	0: {title: 'Angular Velocity (RPM)'},
          	1: {title: 'Rotational Position (Rev)'}
          },
          series: {
          	0: {targetAxisIndex: 0},
          	1: {targetAxisIndex: 1}
          },
          vAxis: {
	          viewWindow: {
	            min: 0
	          }
	        }

      };

      var xdata = new google.visualization.DataTable();
      xdata.addColumn('number', 'Time (s)');
      xdata.addColumn('number', 'Angular Velocity (RPM)');
      xdata.addColumn('number', 'Rotational Position (Rev)');
      xdata.addRows([]);

      xchart.draw(xdata, xchart_options);
    };

	function get_motor_data(motor,key){
		return motor_data[motor][key];
	}

	function gidv(id) {
		return eval(document.getElementById(id).value);
	}

	function thload() {
		drawStuff();

		compute();
	}

	function compute(simulate) {
		simulate = typeof simulate !== 'undefined' ? simulate : true;

		dt = 0.0001;

		P_atm = 101e3;
		
		R = 287.05; // J/kg-K
		c_p = 1010; // J/kg-K
		c_v = c_p - R;

		T_in = 20 + 273; // K
		P_in = 413e3+P_atm; //Pa; 60psi
		C = 1.093333333e-8; //m^3/s/Pa
		V_in = C*P_in;
		A = Math.pow(25e-3,2)*Math.PI/4; // m^2
		xf = 0.2; // m
		F = 10; // N

		t = 0;
		T_s = T_in;
		x = 0;
		v = 0;
		V_extra = (1*A);
		m_s = V_extra*1.2; // rho = 1.2 kg/m^3

		

		M = 0.01; // kg

		cur_cons = 0;

		alpha_o = NaN;

		data = [];
		chartdata = [];

		var posdata = new google.visualization.DataTable();
		posdata.addColumn('number', 'Time (s)');
      	//posdata.addColumn('number', 'Linear Velocity (m/s)');
      	posdata.addColumn('number', 'Linear Position (m)');
      	posdata.addColumn('number', 'Cylinder Inst. Pressure (kPa)');
      	//posdata.addColumn('number', 'Cylinder Inst. Temperature (K)');
      	//posdata.addColumn('number', 'Cylinder Air Mass (kg)');
      	

      	var xdata = new google.visualization.DataTable();
		xdata.addColumn('number', 'Time (s)');
      	xdata.addColumn('number', 'Angular Velocity (RPM)');
      	xdata.addColumn('number', 'Rotational Position (rev)');
      	xdata.addRows([[0,0,0]]);
      	i=0;
		while(i<1000) {
			P_s = Math.min(m_s/(x*A+V_extra)*R*T_s, P_in);
			m_in = P_in/R/T_in*V_in;

			dT_s = (-c_p*T_s*m_in - P_s*A*v + m_in*c_v*T_in)/c_p/m_s;
			dm_s = m_in;

			dx = v;
			dv = ((P_s-P_atm)*A-F) / M;

			t += dt;
			x += dx*dt;
			v += dv*dt;
			if (x <= 0) {x = 0; v = Math.max(v,0);}
			if (x >= xf) {x = xf; v = 0}
			T_s += dT_s*dt;
			m_s += dm_s*dt;

			if (x >= xf && P_s >= P_in)
				break;

			//data.push([t,x,v,P_s,T_s,m_s]);
			chartdata.push([t,x,P_s/100]); //,T_s,m_s
			i++;
		}

		console.log(chartdata);
		posdata.addRows(chartdata);

		// omega_ar.shift(); //remove the first element of this array that was there for adams-bradforth purposes

		// console.log(posdata, xdata);

		poschart.draw(posdata, poschart_options);
      	//xchart.draw(xdata, xchart_options);
      	document.getElementById('charts').style.background='transparent';

      	console.log("thanks for coming");
	}


	function NaNto1(x) {
		if (isNaN(x))
			return 1;
		return x;
	}


</script>

<html>
<body onload="thload()">
	<div style="width: 420px; float: left;" class="container">
		
	</div><div style="margin-left: 0px;" class="container" id="charts">
	 <div id="poschart_div" style="width: 900px; height: 500px"></div>
	 <div id="xchart_div" style="width: 900px; height: 500px"></div>
	</div>
</body>
</html>