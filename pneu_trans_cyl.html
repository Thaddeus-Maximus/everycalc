<!DOCTYPE html>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet" href="style.css"> 
<script type="text/javascript" src="specs.js"></script>
<script type="text/javascript">
	var poschart = null, poschart_options = null;

	google.charts.load('current', {'packages':['corechart', 'scatter', 'line']});
    google.charts.setOnLoadCallback(drawStuff);


    direction_push = true;
    function setDirection(push) {
    	direction_push = push;
    	document.getElementById('direction_push').disabled = push;
    	document.getElementById('direction_pull').disabled = !push;

    	compute(true);
    }

    function drawStuff() {
      poschart = new google.visualization.LineChart(document.getElementById('poschart_div'));
      var poschartDiv = document.getElementById('poschart_div');

      poschart_options = {
          backgroundColor: { fill:'transparent' },
          curveType: 'function',
          legend: {position: 'top'},
          vAxes: {
          	//0: {title: 'Linear Velocity (m/s)'},
          	0: {title: 'Linear Position (m)'},
          	1: {title: 'Cylinder Inst. Pressure (kPa)'}
          	//3: {title: 'Temperature'},
          	//4: {title: 'Mass'}
          },
          series: {
          	//0: {targetAxisIndex: 1},
          	0: {targetAxisIndex: 0},
          	1: {targetAxisIndex: 1}
          	//3: {targetAxisIndex: 0},
          	//4: {targetAxisIndex: 1}
          },
          vAxis: {
	          viewWindow: {
	            min: 0
	          }
	        }

      };

      var posdata = new google.visualization.DataTable();
      posdata.addColumn('number', 'Time (s)');
      posdata.addColumn('number', 'Linear Position (m)');
      posdata.addColumn('number', 'Cylinder Inst. Pressure (kPa)');
      posdata.addRows([]);

      poschart.draw(posdata, poschart_options);
    };

	function get_motor_data(motor,key){
		return motor_data[motor][key];
	}

	function gidv(id) {
		return eval(document.getElementById(id).value);
	}

	function thload() {
		drawStuff();

		setDirection(true);
		

		var inputs, index;

		inputs = document.getElementsByTagName('input');
		for (index = 0; index < inputs.length; ++index) {
		    inputs[index].onkeyup = function(e) {
		    	var key = e.keyCode ? e.keyCode : e.which;

		    	if (key==13) {
		    		compute(true);
		    	} else {
		    		compute(false);
		    	}
		    }
		}
	}

		
	function sign(x) {
		if (x>0) return 1;
		if (x<0) return -1;
		return 0;
	}

	en_vm = true;

	function compute(simulate) {
		simulate = typeof simulate !== 'undefined' ? simulate : true;

		// Constants
		dt = 0.0005;
		P_atm = 101e3;
		R = 287.05; // J/kg-K
		c_p = 1010; // J/kg-K
		c_v = c_p - R;

		// Variables
		T_in = gidv('T_src') + 273; // K
		P_in = gidv('P_src')*1000+P_atm; //Pa; 60psi (conversion between gague and abs pressure)
		A = (Math.pow(gidv('d_bore')/1000,2)-
					(direction_push ? 0 : Math.pow(gidv('d_rod')/1000,2)))*Math.PI/4; // m^2
		xf = gidv('stroke')/1000; // m
		
		d_line = gidv('d_line')/1000;
		l_line = gidv('l_line');
		V_extra = Math.PI/4*Math.pow(d_line,2)*l_line;
		M = gidv('mass'); // kg

		// State variables (autocomputed)
		t = 0;
		T_s = T_in;
		x = 0;
		v = 0;
		m_s = P_atm*V_extra/R/T_s; // rho = 1.2 kg/m^3

		data = [];
		chartdata = [];

		var posdata = new google.visualization.DataTable();
		posdata.addColumn('number', 'Time (s)');
      	//posdata.addColumn('number', 'Linear Velocity (m/s)');
      	posdata.addColumn('number', 'Linear Position (m)');
      	posdata.addColumn('number', 'Cylinder Inst. Pressure (kPa)');
      	//posdata.addColumn('number', 'Cylinder Inst. Temperature (K)');
      	//posdata.addColumn('number', 'Cylinder Air Mass (kg)');
      	

      	var xdata = new google.visualization.DataTable();
		xdata.addColumn('number', 'Time (s)');
      	xdata.addColumn('number', 'Angular Velocity (RPM)');
      	xdata.addColumn('number', 'Rotational Position (rev)');
      	xdata.addRows([[0,0,0]]);
      	i=0;

      	t_endstop = NaN;
      	v_endstop = NaN;
      	E_endstop = NaN;
      	t_ss	  = NaN;
      	air_cons  = 0;

      	termcrit = document.getElementById('termcrit').value;
      	if (termcrit == '') termcrit = 0;

		while(i<3000) {
			P_s = m_s/(x*A+V_extra)*R*T_s;
			V_in = sign(P_in-P_s)*0.0197862*Math.pow(Math.pow(d_line,5)*(P_in-P_atm)*Math.abs(P_in-P_s)/l_line, 20/37);
			m_in = P_in/R/T_in*V_in;

			F = eval(document.getElementById('load').value); // N
			//console.log(F);

			vmterm = en_vm ? Math.pow(V_in/(Math.PI/4 * d_line*d_line), 2) : 0;

			console.log(vmterm);

			dT_s = ( m_in * (-c_p*T_s + c_v*T_in + vmterm) - P_s*A*v)/c_p/m_s;
			dm_s = m_in;

			dx = v;
			dv = ((P_s-P_atm)*A-F) / M;

			t += dt;
			x += dx*dt;
			v += dv*dt;
			air_cons += m_in*dt;
			if (x <= 0) {x = 0; v = Math.max(v,0);}
			if (x >= xf) {
				if (isNaN(t_endstop)) {
					t_endstop = t;
					v_endstop = v;
					E_endstop = M*v*v/2;
				}
				x = xf; v = 0;
			}
			T_s += dT_s*dt;
			m_s += dm_s*dt;

			if (x >= xf && P_s >= P_in) {
				if (isNaN(t_endstop)) {
					t_endstop = t;
					v_endstop = v;
					E_endstop = M*v*v/2;
				}
				t_ss = t;
				break;
			}

			if (eval(termcrit)) break;

			//data.push([t,x,v,P_s,T_s,m_s]);
			chartdata.push([t,x,(P_s-P_atm)/1000]); //,T_s,m_s
			i++;
		}

		posdata.addRows(chartdata);

		poschart.draw(posdata, poschart_options);
      	//xchart.draw(xdata, xchart_options);
      	document.getElementById('charts').style.background='transparent';
      	document.getElementById('t_endstop').value = NaNtoerr(t_endstop);
      	document.getElementById('t_steady').value  = NaNtoerr(t_ss);
      	document.getElementById('v_endstop').value = NaNtoerr(v_endstop);
      	document.getElementById('E_endstop').value = NaNtoerr(E_endstop);
      	document.getElementById('air_cons').value  = air_cons*1000;
	}

	function NaNtoerr(x) {
		if (isNaN(x)) return '-'; return x;
	}


	function NaNto1(x) {
		if (isNaN(x))
			return 1;
		return x;
	}


</script>

<html>
<body onload="thload()">
	<div style="width: 420px; float: left;" class="container">
		<h3>Thad's Pneumatic Piston Calculator</h3>
		<center><a href="./">Back To Index</a></center>

		<div class="odd">
		<table>
			<tr>
				<th class='rowlabel'>Tank Pressure</th>
				<td><input id='P_src' value=400></td>
				<td class='unit'>kPa</td>
			</tr><tr>
				<th class="rowlabel">Tank Temperature</th>
				<td><input id="T_src" value=20></td>
				<td class="unit">C</td>
			</tr><tr>
				<th class='rowlabel'>Line Diameter</th>
				<td><input id='d_line' value=5></td>
				<td class="unit">mm</td>
			</tr><tr>
				<th class="rowlabel">Line Length</th>
				<td><input id="l_line" value=1.5></td>
				<td class="unit">m</td>
			</tr><tr>
				<th class="rowlabel">Bore Diameter</th>
				<td><input id="d_bore" value=20></td>
				<td class="unit">mm</td>
			</tr><tr>
				<th class="rowlabel">Rod Diameter</th>
				<td><input id="d_rod" value=6></td>
				<td class="unit">mm</td>
			</tr><tr>
				<th class="rowlabel">Direction</th>
				<td colspan=2><button id="direction_push" onclick="setDirection(true)" disabled >PUSH</button>
					<button id="direction_pull" onclick="setDirection(false)" >PULL</button></td>
			</tr><tr>
				<th class="rowlabel">Stroke</th>
				<td><input id="stroke" value=100></td>
				<td class="unit">mm</td>
			</tr><tr>
				<th class="rowlabel">Load</th>
				<td><input id="load" value=50></td>
				<td class="unit">N</td>
			</tr><tr>
				<th class="rowlabel">Mass</th>
				<td><input id="mass" value=0.7></td>
				<td class="unit">kg</td>
			</tr><tr>
				<th class="rowlabel">Alt. Termination Criteria</th>
				<td><input id="termcrit" value=''></td>
			</tr>
		</table>
		</div><div class="output">
			<table>
				<tr>
					<th class='rowlabel'>Time to Reach Endstop</th>
					<td><input id='t_endstop' disabled /></td>
					<td class='unit'>[s]</td>
				</tr><tr>
					<th class='rowlabel'>Time to Reach Steady-State</th>
					<td><input id='t_steady' disabled /></td>
					<td class='unit'>[s]</td>
				</tr><tr>
					<th class='rowlabel'>Velocity Hitting Endstop</th>
					<td><input id='v_endstop' disabled /></td>
					<td class='unit'>[m/s]</td>
				</tr><tr>
					<th class='rowlabel'>Kinetic Energy Hitting Endstop</th>
					<td><input id='E_endstop' disabled /></td>
					<td class='unit'>[J]</td>
				</tr><tr>
					<th class='rowlabel'>Air Consumption</th>
					<td><input id='air_cons' disabled /></td>
					<td class='unit'>[g]</td>
				</tr>
			</table>
		</div>
	</div><div style="margin-left: 0px;" class="container" id="charts">
	 <div id="poschart_div" style="width: 900px; height: 500px"></div>
	</div>
</body>
</html>